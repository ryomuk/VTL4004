 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 1 - 2023/03/11 11:35:13


       1/       0 :                     ;;;---------------------------------------------------------------------------
       2/       0 :                     ;;; Tiny Monitor with Very Very Tiny Language Interpreter (VTL-4004)
       3/       0 :                     ;;; for Intel 4004 evaluation board
       4/       0 :                     ;;;
       5/       0 :                     ;;; by Ryo Mukai
       6/       0 :                     ;;; 2023/03/10
       7/       0 :                     ;;;---------------------------------------------------------------------------
       8/       0 :                     
       9/       0 :                     ;;;---------------------------------------------------------------------------
      10/       0 :                     ;;; This source can be assembled with the Macroassembler AS
      11/       0 :                     ;;; (http://john.ccac.rwth-aachen.de:8000/as/)
      12/       0 :                     ;;;---------------------------------------------------------------------------
      13/       0 :                     
      14/       0 :                     	cpu 4004        ; AS's command to specify CPU
      15/       0 :                     
      16/       0 :                     	include "macros.inc" 	; aliases and macros
(1)    1/       0 :                     ;;;---------------------------------------------------------------------------
(1)    2/       0 :                     ;;; function for label to address for FIM&FIN
(1)    3/       0 :                     ;;;---------------------------------------------------------------------------
(1)    4/       0 :                     
(1)    5/       0 :                     lo     	function x, ((x)&255)
(1)    6/       0 :                     up     	function x, ((x>>8)&255)
(1)    7/       0 :                     
(1)    8/       0 :                     ;;;---------------------------------------------------------------------------
(1)    9/       0 :                     ;;; functuon for setting counter for ISZ loop
(1)   10/       0 :                     ;;;---------------------------------------------------------------------------
(1)   11/       0 :                     
(1)   12/       0 :                     loop 	function x, (16-(x))
(1)   13/       0 :                     loops   function x,y, ((16-(x))<<4 + (16-(y)))
(1)   14/       0 :                     
(1)   15/       0 :                     ;;;---------------------------------------------------------------------------
(1)   16/       0 :                     ;;; Alias for Registers and Register Pairs
(1)   17/       0 :                     ;;;---------------------------------------------------------------------------
(1)   18/       0 :                     
(1)   19/       0 :                     ;;; Registers
(1)   20/       0 : =R10                 R10	reg RA
(1)   21/       0 : =R11                 R11     reg RB
(1)   22/       0 : =R12                 R12     reg RC
(1)   23/       0 : =R13                 R13 	reg RD
(1)   24/       0 : =R14                 R14     reg RE
(1)   25/       0 : =R15                 R15     reg RF
(1)   26/       0 :                     
(1)   27/       0 :                     ;;; Register Pairs
(1)   28/       0 : =R0P                 P0      reg R0R1
(1)   29/       0 : =R1P                 P1      reg R2R3
(1)   30/       0 : =R2P                 P2      reg R4R5
(1)   31/       0 : =R3P                 P3      reg R6R7
(1)   32/       0 : =R4P                 P4      reg R8R9
(1)   33/       0 : =R5P                 P5      reg RARB
(1)   34/       0 : =R6P                 P6      reg RCRD
(1)   35/       0 : =R7P                 P7      reg RERF
(1)   36/       0 : =R5P                 R10R11  reg RARB
(1)   37/       0 : =R6P                 R12R13  reg RCRD
(1)   38/       0 : =R7P                 R14R15  reg RERF
(1)   39/       0 :                     
(1)   40/       0 :                     ;;;---------------------------------------------------------------------------
(1)   41/       0 :                     ;;; macro instructions
(1)   42/       0 :                     ;;;---------------------------------------------------------------------------
(1)   43/       0 :                     ;;;----------------------------------------------------------------------------
(1)   44/       0 :                     ;;; For debug
 AS V1.42 Beta [Bld 236] - Source File vtl.asm(macros.inc) - Page 2 - 2023/03/11 11:35:13


(1)   45/       0 :                     ;;;----------------------------------------------------------------------------
(1)   46/       0 :                     ;;;----------------------------------------------------------------------------
(1)   47/       0 :                     ;;; DEBUG_SAFEPUTCHAR
(1)   48/       0 :                     ;;; PUTCHAR that does not destroy P1
(1)   49/       0 :                     ;;;----------------------------------------------------------------------------
(1)   50/       0 :                     DEBUG_SAFEPUTCHAR	macro ch
(1)   51/       0 :                     	JMS PUSH_P1
(1)   52/       0 :                     	FIM P1, ch
(1)   53/       0 :                     	JMS PUTCHAR_P1
(1)   54/       0 :                     	JMS POP_P1
(1)   55/       0 :                     	endm
(1)   56/       0 :                     ;;;----------------------------------------------------------------------------
(1)   57/       0 :                     ;;; Register Pair Operations
(1)   58/       0 :                     ;;;----------------------------------------------------------------------------
(1)   59/       0 :                     LD_P0_P1	macro	; P0 = P1
(1)   60/       0 :                     		LD R2
(1)   61/       0 :                     		XCH R0
(1)   62/       0 :                     		LD R3
(1)   63/       0 :                     		XCH R1
(1)   64/       0 :                     		endm
(1)   65/       0 :                     ;;;----------------------------------------------------------------------------
(1)   66/       0 :                     LD_P0_P2	macro	; P0 = P2
(1)   67/       0 :                     		LD R4
(1)   68/       0 :                     		XCH R0
(1)   69/       0 :                     		LD R5
(1)   70/       0 :                     		XCH R1
(1)   71/       0 :                     		endm
(1)   72/       0 :                     ;;;----------------------------------------------------------------------------
(1)   73/       0 :                     LD_P0_P3	macro	; P0 = P3
(1)   74/       0 :                     		LD R6
(1)   75/       0 :                     		XCH R0
(1)   76/       0 :                     		LD R7
(1)   77/       0 :                     		XCH R1
(1)   78/       0 :                     		endm
(1)   79/       0 :                     ;;;----------------------------------------------------------------------------
(1)   80/       0 :                     LD_P0_P5	macro	; P0 = P5
(1)   81/       0 :                     		LD R10
(1)   82/       0 :                     		XCH R0
(1)   83/       0 :                     		LD R11
(1)   84/       0 :                     		XCH R1
(1)   85/       0 :                     		endm
(1)   86/       0 :                     ;;;----------------------------------------------------------------------------
(1)   87/       0 :                     LD_P0_P6	macro	; P0 = P6
(1)   88/       0 :                     		LD R12
(1)   89/       0 :                     		XCH R0
(1)   90/       0 :                     		LD R13
(1)   91/       0 :                     		XCH R1
(1)   92/       0 :                     		endm
(1)   93/       0 :                     ;;;----------------------------------------------------------------------------
(1)   94/       0 :                     LD_P1_P0	macro	; P1 = P0
(1)   95/       0 :                     		LD R0
(1)   96/       0 :                     		XCH R2
(1)   97/       0 :                     		LD R1
(1)   98/       0 :                     		XCH R3
(1)   99/       0 :                     		endm
(1)  100/       0 :                     ;;;----------------------------------------------------------------------------
(1)  101/       0 :                     LD_P1_P2	macro	; P1 = P2
(1)  102/       0 :                     		LD R4
(1)  103/       0 :                     		XCH R2
(1)  104/       0 :                     		LD R5
 AS V1.42 Beta [Bld 236] - Source File vtl.asm(macros.inc) - Page 3 - 2023/03/11 11:35:13


(1)  105/       0 :                     		XCH R3
(1)  106/       0 :                     		endm
(1)  107/       0 :                     ;;;----------------------------------------------------------------------------
(1)  108/       0 :                     LD_P1_P3	macro	; P1 = P3
(1)  109/       0 :                     		LD R6
(1)  110/       0 :                     		XCH R2
(1)  111/       0 :                     		LD R7
(1)  112/       0 :                     		XCH R3
(1)  113/       0 :                     		endm
(1)  114/       0 :                     ;;;----------------------------------------------------------------------------
(1)  115/       0 :                     LD_P1_P4	macro	; P1 = P4
(1)  116/       0 :                     		LD R8
(1)  117/       0 :                     		XCH R2
(1)  118/       0 :                     		LD R9
(1)  119/       0 :                     		XCH R3
(1)  120/       0 :                     		endm
(1)  121/       0 :                     ;;;----------------------------------------------------------------------------
(1)  122/       0 :                     LD_P2_P0	macro	; P2 = P0
(1)  123/       0 :                     		LD R0
(1)  124/       0 :                     		XCH R4
(1)  125/       0 :                     		LD R1
(1)  126/       0 :                     		XCH R5
(1)  127/       0 :                     		endm
(1)  128/       0 :                     ;;;----------------------------------------------------------------------------
(1)  129/       0 :                     LD_P2_P1	macro	; P2 = P1
(1)  130/       0 :                     		LD R2
(1)  131/       0 :                     		XCH R4
(1)  132/       0 :                     		LD R3
(1)  133/       0 :                     		XCH R5
(1)  134/       0 :                     		endm
(1)  135/       0 :                     ;;;----------------------------------------------------------------------------
(1)  136/       0 :                     LD_P2_P3	macro	; P2 = P3
(1)  137/       0 :                     		LD R6
(1)  138/       0 :                     		XCH R4
(1)  139/       0 :                     		LD R7
(1)  140/       0 :                     		XCH R5
(1)  141/       0 :                     		endm
(1)  142/       0 :                     ;;;----------------------------------------------------------------------------
(1)  143/       0 :                     LD_P2_P4	macro	; P2 = P4
(1)  144/       0 :                     		LD R8
(1)  145/       0 :                     		XCH R4
(1)  146/       0 :                     		LD R9
(1)  147/       0 :                     		XCH R5
(1)  148/       0 :                     		endm
(1)  149/       0 :                     ;;;----------------------------------------------------------------------------
(1)  150/       0 :                     LD_P3_P1	macro	; P3 = P1
(1)  151/       0 :                     		LD R2
(1)  152/       0 :                     		XCH R6
(1)  153/       0 :                     		LD R3
(1)  154/       0 :                     		XCH R7
(1)  155/       0 :                     		endm
(1)  156/       0 :                     ;;;----------------------------------------------------------------------------
(1)  157/       0 :                     LD_P3_P2	macro	; P3 = P2
(1)  158/       0 :                     		LD R4
(1)  159/       0 :                     		XCH R6
(1)  160/       0 :                     		LD R5
(1)  161/       0 :                     		XCH R7
(1)  162/       0 :                     		endm
(1)  163/       0 :                     ;;;----------------------------------------------------------------------------
(1)  164/       0 :                     LD_P3_P5	macro	; P3 = P5
 AS V1.42 Beta [Bld 236] - Source File vtl.asm(macros.inc) - Page 4 - 2023/03/11 11:35:13


(1)  165/       0 :                     		LD R10
(1)  166/       0 :                     		XCH R6
(1)  167/       0 :                     		LD R11
(1)  168/       0 :                     		XCH R7
(1)  169/       0 :                     		endm
(1)  170/       0 :                     ;;;----------------------------------------------------------------------------
(1)  171/       0 :                     LD_P4_P1	macro	; P4 = P1
(1)  172/       0 :                     		LD R2
(1)  173/       0 :                     		XCH R8
(1)  174/       0 :                     		LD R3
(1)  175/       0 :                     		XCH R9
(1)  176/       0 :                     		endm
(1)  177/       0 :                     ;;;----------------------------------------------------------------------------
(1)  178/       0 :                     LD_P5_P0	macro	; P5 = P0
(1)  179/       0 :                     		LD R0
(1)  180/       0 :                     		XCH R10
(1)  181/       0 :                     		LD R1
(1)  182/       0 :                     		XCH R11
(1)  183/       0 :                     		endm
(1)  184/       0 :                     ;;;----------------------------------------------------------------------------
(1)  185/       0 :                     LD_P6_P0	macro	; P6 = P0
(1)  186/       0 :                     		LD R0
(1)  187/       0 :                     		XCH R12
(1)  188/       0 :                     		LD R1
(1)  189/       0 :                     		XCH R13
(1)  190/       0 :                     		endm
(1)  191/       0 :                     ;;;----------------------------------------------------------------------------
(1)  192/       0 :                     LD_P7_P2	macro	; P7 = P2
(1)  193/       0 :                     		LD R4
(1)  194/       0 :                     		XCH R14
(1)  195/       0 :                     		LD R5
(1)  196/       0 :                     		XCH R15
(1)  197/       0 :                     		endm
(1)  198/       0 :                     ;;;----------------------------------------------------------------------------
(1)  199/       0 :                     
      17/       0 :                     
      18/       0 :                     ;;;---------------------------------------------------------------------------
      19/       0 :                     ;;; Hardware Configuration
      20/       0 :                     ;;;---------------------------------------------------------------------------
      21/       0 :                     
      22/       0 :                     ;;; RAM0 and RAM1 must be 4002-1 and located in the BANK#0 (CM-RAM0).
      23/       0 :                     ;;; For RAM2 and RAM3, 4002-2 is preferred, because it can be located
      24/       0 :                     ;;; in the BANK#0 same as RAM0 and RAM1.
      25/       0 :                     ;;; However -2 is more expensive and difficult to get than -1,
      26/       0 :                     ;;; so the chip type of RAM2 and RAM3 is configurable.
      27/       0 :                     ;;; If you use -1 for RAM2 and RAM3, they are located in
      28/       0 :                     ;;; the BANK#1 (CM-RAM1), and DCL must be executed before SRC.
      29/       0 :                     
      30/       0 :                     ;;; Chip type of RAM2 and RAM3
      31/       0 : ="4002-2"            RAM23TYPE	equ "4002-2"	; or "4002-1"
      32/       0 :                     
      33/       0 :                     ;;; BANK# for DCL, and CHIP#=(D7.D6.000000) for SRC
      34/       0 : =0H                  BANK_RAM0	equ 0
      35/       0 : =0H                  CHIP_RAM0      	equ 00H
      36/       0 : =0H                  BANK_RAM1      	equ 0
      37/       0 : =40H                 CHIP_RAM1      	equ 40H
      38/       0 : =>TRUE               	if (RAM23TYPE == "4002-2")
      39/       0 : =0H                  BANK_RAM2      	equ 0
      40/       0 : =80H                 CHIP_RAM2      	equ 80H
      41/       0 : =0H                  BANK_RAM3      	equ 0
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 5 - 2023/03/11 11:35:13


      42/       0 : =0C0H                CHIP_RAM3      	equ 0C0H
      43/       0 : =>FALSE              	elseif (RAM23TYPE == "4002-1")
      44/       0 :                     BANK_RAM2      	equ 1
      45/       0 :                     CHIP_RAM2      	equ 00H
      46/       0 :                     BANK_RAM3      	equ 1
      47/       0 :                     CHIP_RAM3      	equ 40H
      48/       0 : [38]                 	endif
      49/       0 :                     
      50/       0 :                     ;;; Default Bank
      51/       0 :                     ;;; The CM-RAM line should be always set to BANK_DEFAULT
      52/       0 :                     ;;; to omit DCL as much as possible.
      53/       0 :                     ;;; (This is for when RAM23TYPE=="4002-1".)
      54/       0 : =0H                  BANK_DEFAULT	equ BANK_RAM0
      55/       0 :                     		
      56/       0 :                     ;;; Output port for serial interface
      57/       0 : =0H                  BANK_SERIAL     equ BANK_RAM3
      58/       0 : =0C0H                CHIP_SERIAL     equ CHIP_RAM3
      59/       0 :                     
      60/       0 :                     ;;; Output port for program memory bank selection
      61/       0 : =0H                  BANK_PMSELECT	equ BANK_RAM0
      62/       0 : =0H                  CHIP_PMSELECT   equ CHIP_RAM0
      63/       0 :                     
      64/       0 :                     ;;; Program Memory RAM area
      65/       0 : =0F00H               PM_RAM_START	equ 0F00H	; Start address of program memory RAM
      66/       0 : =0FFEH               PM_READ_P0_P1   equ 0FFEH	; Entry of the subroutine to read RAM
      67/       0 :                     				; "FIN P1 and BBL 0"
      68/       0 :                     
      69/       0 :                     ;;; Address labels in the logical program memory PM12
      70/       0 :                     ;;; PM12_LINEBUF	equ 080H
      71/       0 : =0H                  PM12_LINEBUF	equ 000H
      72/       0 : =100H                PM12_PROGRAM	equ 100H
      73/       0 : =0B00H               PM12_DATA	equ 0B00H
      74/       0 : =0DFFH               PM12_MEMEND	equ 0DFFH
      75/       0 :                     
      76/       0 :                     ;;;---------------------------------------------------------------------------
      77/       0 :                     ;;; Data RAM Register Configuration
      78/       0 :                     ;;;---------------------------------------------------------------------------
      79/       0 :                     ;;; RAM0
      80/       0 : =0H                  REG16_INDEX 		equ 00H	; or @, `
      81/       0 : =4H                  REG16_A 		equ 04H	;
      82/       0 : =8H                  REG16_B 		equ 08H	;
      83/       0 : =0CH                 REG16_C 		equ 0CH	;
      84/       0 : =10H                 REG16_D 		equ 10H	;
      85/       0 : =14H                 REG16_E 		equ 14H	;
      86/       0 : =18H                 REG16_F 		equ 18H	;
      87/       0 : =1CH                 REG16_G 		equ 1CH	;
      88/       0 : =20H                 REG16_H 		equ 20H	;
      89/       0 : =24H                 REG16_I 		equ 24H	;
      90/       0 : =28H                 REG16_J 		equ 28H	;
      91/       0 : =2CH                 REG16_K 		equ 2CH	;
      92/       0 : =30H                 REG16_L 		equ 30H	;
      93/       0 : =34H                 REG16_M 		equ 34H	;
      94/       0 : =38H                 REG16_N 		equ 38H	;
      95/       0 : =3CH                 REG16_O 		equ 3CH	;
      96/       0 :                     ;;; RAM1
      97/       0 : =40H                 REG16_P 		equ 40H	;
      98/       0 : =44H                 REG16_Q 		equ 44H	;
      99/       0 : =48H                 REG16_R 		equ 48H	;
     100/       0 : =4CH                 REG16_S 		equ 4CH	;
     101/       0 : =50H                 REG16_T 		equ 50H	;
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 6 - 2023/03/11 11:35:13


     102/       0 : =54H                 REG16_U 		equ 54H	;
     103/       0 : =58H                 REG16_V 		equ 58H	;
     104/       0 : =5CH                 REG16_W 		equ 5CH	;
     105/       0 : =60H                 REG16_X 		equ 60H	;
     106/       0 : =64H                 REG16_Y 		equ 64H	;
     107/       0 : =68H                 REG16_Z  		equ 68H	;
     108/       0 : =6CH                 REG16_LINENUM  		equ 6CH	; current line number
     109/       0 : =70H                 REG16_NEXTLINEPTR	equ 70H	; pointer to the next program line
     110/       0 : =74H                 REG16_PEND		equ 74H	; pointer to the end of program
     111/       0 :                     
     112/       0 : =78H                 REG8_ERROR		equ 78H	; 8bit register
     113/       0 : =7AH                 REG8_ERROR2		equ 7AH	; 8bit register
     114/       0 :                     
     115/       0 : =7CH                 REG4_ZEROSUP		equ 7CH	; 4bit register
     116/       0 : =7DH                 REG4_SIGN		equ 7DH	; 4bit register
     117/       0 : =7EH                 REG4_PRINTFORMAT	equ 7EH	; 4bit register
     118/       0 : =7FH                 REG4_RESERVE_7FH	equ 7FH	; 4bit register (reserved)
     119/       0 :                     
     120/       0 :                     	;; This program assumes RAM2 and RAM3 are 4002-2.
     121/       0 :                     	;; If you use 4002-1, you may need to modify program
     122/       0 :                     	;; related to data RAM registers.
     123/       0 : =>TRUE               	if (RAM23TYPE == "4002-2")
     124/       0 :                     ;;; RAM2
     125/       0 : =80H                 REG16_LVALUE		equ 80H
     126/       0 : =84H                 REG16_RVALUE		equ 84H
     127/       0 : =88H                 REG16_FACTOR		equ 88H
     128/       0 : =8CH                 REG16_EVAL		equ 8CH
     129/       0 : =90H                 REG16_RMND		equ 90H	; Remainder (result of last DIV)
     130/       0 : =94H                 REG16_RETURN		equ 94H
     131/       0 : =98H                 REG16_RANDOM		equ 98H	; (not implemented)
     132/       0 : =9CH                 REG16_ARRAYINDEX	equ 9CH	; (not implemented)
     133/       0 : =0A0H                REG16_TMP		equ 0A0H
     134/       0 : =0A4H                REG16_TMP2		equ 0A4H
     135/       0 : =0A8H                REG16_TMP3		equ 0A8H
     136/       0 : =0ACH                REG16_TMP_PRN		equ 0ACH ; temporary for PRINT routine
     137/       0 : =0B0H                REG16_RESERVED_0B0	equ 0B0H
     138/       0 : =0B4H                REG16_RESERVED_0B4	equ 0B4H
     139/       0 : =0B8H                REG16_RESERVED_0B8	equ 0B8H
     140/       0 : =0BCH                REG16_RESERVED_0BC	equ 0BCH
     141/       0 :                     ;;; RAM3
     142/       0 : =0C0H                REG16_STACKAREA_0C0	equ 0C0H
     143/       0 : =0C4H                REG16_STACKAREA_0C4	equ 0C4H
     144/       0 : =0C8H                REG16_STACKAREA_0C8	equ 0C8H
     145/       0 : =0CCH                REG16_STACKAREA_0CC	equ 0CCH
     146/       0 : =0D0H                REG16_STACKAREA_0D0	equ 0D0H
     147/       0 : =0D4H                REG16_STACKAREA_0D4	equ 0D4H
     148/       0 : =0D8H                REG16_STACKAREA_0D8	equ 0D8H
     149/       0 : =0DCH                REG16_STACKAREA_0DC	equ 0DCH
     150/       0 : =0E0H                REG16_STACKAREA_0E0	equ 0E0H
     151/       0 : =0E4H                REG16_STACKAREA_0E4	equ 0E4H
     152/       0 : =0E8H                REG16_STACKAREA_0E8	equ 0E8H
     153/       0 : =0ECH                REG16_STACKAREA_0EC	equ 0ECH
     154/       0 : =0F0H                REG16_STACKAREA_0F0	equ 0F0H
     155/       0 : =0F4H                REG16_STACKAREA_0F4	equ 0F4H
     156/       0 : =0F8H                REG16_STACKAREA_0F8	equ 0F8H
     157/       0 : =0FCH                REG16_STACKAREA_0FC	equ 0FCH
     158/       0 : =0FCH                REG16_STACKPOINTER	equ 0FCH ; SP is Status char 0 and 1 of This register
     159/       0 : =0H                  INITVAL_STACKPOINTER	equ 00H	 ; Initial value of the SP
     160/       0 :                     				 ; (The SP should be even value
     161/       0 :                     				 ;  in the current implementation)
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 7 - 2023/03/11 11:35:13


     162/       0 : [123]                	endif
     163/       0 :                     	
     164/       0 :                     ;;;---------------------------------------------------------------------------
     165/       0 :                     ;;; Data RAM Register Operation
     166/       0 :                     ;;;---------------------------------------------------------------------------
     167/       0 :                     
     168/       0 :                     ;;;---------------------------------------------------------------------------
     169/       0 :                     ;;; Program Start
     170/       0 :                     ;;;---------------------------------------------------------------------------
     171/       0 :                     	org 0000H		; beginning of Program Memory
     172/       0 :                     
     173/       0 :                     ;;;---------------------------------------------------------------------------
     174/       0 :                     ;;; Mail Loop for Monitor Program
     175/       0 :                     ;;;---------------------------------------------------------------------------
     176/       0 :                     MAIN:
     177/       0 : F0                          CLB
     178/       1 :                     	;; DL is assumed to be set back to BANK_DEFAULT (normally 0)
     179/       1 :                     	;; except when in use for another banks.
     180/       1 : D0                  	LDM BANK_DEFAULT
     181/       2 : FD                  	DCL
     182/       3 :                     
     183/       3 : 59 3A               	JMS INIT_STACKPOINTER	; initialize stack pointer
     184/       5 : 5D 82               	JMS INIT_SERIAL 	; Initialize Serial Port
     185/       7 :                     
     186/       7 : 22 00               	FIM P1, loop(16)	; R3 = 0..15
     187/       9 :                     PM_INIT_LOOP:
     188/       9 : A3                  	LD R3
     189/       A : 58 EF               	JMS PM_SELECTPMB
     190/       C : 58 E3               	JMS PM_INIT_BANK ; write PM_READ code on program memory
     191/       E : 73 09               	ISZ R3, PM_INIT_LOOP
     192/      10 :                     
     193/      10 : F0                  	CLB
     194/      11 : 58 EF               	JMS PM_SELECTPMB	 ; set PMB to 0
     195/      13 :                     	
     196/      13 :                     ;       JCN TN, $		;wait for TEST="0" (button pressed)
     197/      13 : 20 3B               	FIM P0, lo(STR_VFD_INIT) ; init VFD
     198/      15 : 5E 00                       JMS PRINTSTR_P0
     199/      17 : 20 17               	FIM P0, lo(STR_OMSG) ; opening message in the Page 7
     200/      19 : 5E 00                       JMS PRINTSTR_P0
     201/      1B :                     
     202/      1B :                     CMD_LOOP:
     203/      1B : 22 5D                       FIM P1, ']'		; prompt
     204/      1D : 5D 28                       JMS PUTCHAR_P1
     205/      1F :                     
     206/      1F :                     L_CR:
     207/      1F : 5D 00               	JMS GETCHAR_P1
     208/      21 : 5D 71                       JMS DISPLED_P1
     209/      23 : 20 0D               	FIM P0, '\r'
     210/      25 : 5D C3               	JMS CMP_P0P1
     211/      27 : 14 1F               	JCN Z, L_CR		; skip CR
     212/      29 :                     
     213/      29 : 5D 28               	JMS PUTCHAR_P1		; echo input
     214/      2B :                     
     215/      2B : 20 0A               	FIM P0, '\n'
     216/      2D : 5D C3               	JMS CMP_P0P1
     217/      2F : 1C 35               	JCN ZN, L0
     218/      31 : 5D 69               	JMS PRINT_CR		; put CR
     219/      33 : 40 1B               	JUN CMD_LOOP
     220/      35 :                     
     221/      35 :                     L0:
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 8 - 2023/03/11 11:35:13


     222/      35 : 20 72               	FIM P0, 'r'		; read data memory
     223/      37 : 5D C3               	JMS CMP_P0P1
     224/      39 : 1C 3F               	JCN ZN, L1
     225/      3B : 50 8F               	JMS SETBANKCHIP_P5
     226/      3D : 4C 06               	JUN COMMAND_R
     227/      3F :                     L1:
     228/      3F : 20 77               	FIM P0, 'w'		; write to data memory
     229/      41 : 5D C3               	JMS CMP_P0P1
     230/      43 : 1C 49               	JCN ZN, L2
     231/      45 : 50 8F               	JMS SETBANKCHIP_P5
     232/      47 : 4C 30               	JUN COMMAND_W
     233/      49 :                     L2:
     234/      49 : 20 52               	FIM P0, 'R'		; READ program memory
     235/      4B : 5D C3               	JMS CMP_P0P1
     236/      4D : 1C 51               	JCN ZN, L3
     237/      4F : 4C AE               	JUN COMMAND_PMR
     238/      51 :                     L3:
     239/      51 : 20 57               	FIM P0, 'W'		; Write Program memory
     240/      53 : 5D C3               	JMS CMP_P0P1
     241/      55 : 1C 59               	JCN ZN, L4
     242/      57 : 4C 73               	JUN COMMAND_PMW
     243/      59 :                     L4:
     244/      59 : 20 43               	FIM P0, 'C'		; Clear program memory
     245/      5B : 5D C3               	JMS CMP_P0P1
     246/      5D : 1C 61               	JCN ZN, L5
     247/      5F : 4C D5               	JUN COMMAND_PMC
     248/      61 :                     L5:
     249/      61 : 20 42                	FIM P0, 'B'		; Set PMB (Program Memory Bank)
     250/      63 : 5D C3                	JMS CMP_P0P1
     251/      65 : 1C 69               	JCN ZN, L6
     252/      67 : 48 F4                	JUN COMMAND_PMB
     253/      69 :                     L6:
     254/      69 : 20 67               	FIM P0, 'g'		; Go to PM_RAM_START (0F00H)
     255/      6B : 5D C3               	JMS CMP_P0P1
     256/      6D : 1C 71               	JCN ZN, L7
     257/      6F : 4C 00               	JUN COMMAND_G
     258/      71 :                     L7:
     259/      71 : 20 76               	FIM P0, 'v'		; VTL-4004 Interpreter
     260/      73 : 5D C3               	JMS CMP_P0P1
     261/      75 : 1C 79               	JCN ZN, L8
     262/      77 : 41 00               	JUN COMMAND_V
     263/      79 :                     L8:
     264/      79 : 20 6C               	FIM P0, 'l'		; Read Logical Memory
     265/      7B : 5D C3               	JMS CMP_P0P1
     266/      7D : 1C 81               	JCN ZN, L9
     267/      7F : 4A E0               	JUN COMMAND_LMR
     268/      81 :                     L9:
     269/      81 : 20 4C               	FIM P0, 'L'		; Write Logical Memory
     270/      83 : 5D C3               	JMS CMP_P0P1
     271/      85 : 1C 89               	JCN ZN, L10
     272/      87 : 4B 21               	JUN COMMAND_LMW
     273/      89 :                     L10:
     274/      89 : 20 91               	FIM P0, lo(STR_CMDERR)
     275/      8B : 5E 00               	JMS PRINTSTR_P0
     276/      8D : 40 1B               	JUN CMD_LOOP
     277/      8F :                     	
     278/      8F :                     ;;;---------------------------------------------------------------------------
     279/      8F :                     ;;; SETBANKCHIP_P5
     280/      8F :                     ;;; Set #bank and #chip to R10 and R11
     281/      8F :                     ;;;---------------------------------------------------------------------------
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 9 - 2023/03/11 11:35:13


     282/      8F :                     SETBANKCHIP_P5:
     283/      8F : 20 40               	FIM P0, lo(STR_BANK)	; print " BANK="
     284/      91 : 5E 00               	JMS PRINTSTR_P0
     285/      93 : 5D 00               	JMS GETCHAR_P1
     286/      95 : 5D 28               	JMS PUTCHAR_P1
     287/      97 : 5D B7               	JMS CTOI_P1
     288/      99 : A3                  	LD R3
     289/      9A : BA                  	XCH R10			; save BANK to R10
     290/      9B :                     
     291/      9B : 20 47               	FIM P0, lo(STR_CHIP)	; print " CHIP="
     292/      9D : 5E 00               	JMS PRINTSTR_P0
     293/      9F : 5D 00               	JMS GETCHAR_P1
     294/      A1 : 5D 28               	JMS PUTCHAR_P1
     295/      A3 : 5D B7               	JMS CTOI_P1
     296/      A5 : A3                  	LD R3		; R3 is #chip(x.x.D3.D2)
     297/      A6 : F1                  	CLC
     298/      A7 : F5                  	RAL
     299/      A8 : F1                  	CLC
     300/      A9 : F5                  	RAL
     301/      AA : BB                  	XCH R11 	;set D3D2.00@X2 to R11 (0000 or 0100 or 1000 or 1100)
     302/      AB : 5D 5C               	JMS PRINT_CRLF
     303/      AD : C0                  	BBL 0
     304/      AE :                     	
     305/      AE :                     
     306/      AE :                     ;;;----------------------------------------------------------------------------
     307/      AE :                     ;;; ISHEX_P1
     308/      AE :                     ;;; check P1 is a hex digit letter ('0' to '9') or ('a' to 'f') or ('A' to 'F')
     309/      AE :                     ;;; return: ACC=0 if P1 is not a hex digit letter
     310/      AE :                     ;;;         ACC=1 if P1 is a hex digit letter
     311/      AE :                     ;;; destroy: P7
     312/      AE :                     ;;;----------------------------------------------------------------------------
     313/      AE :                     ISHEX_P1:
     314/      AE : 2E 30               	FIM P7, '0'
     315/      B0 : 5D D0               	JMS CMP_P1P7
     316/      B2 : 12 B5               	JCN C, ISHEX_L00
     317/      B4 : C0                  	BBL 0			; P1<'0'
     318/      B5 :                     ISHEX_L00:	
     319/      B5 : 2E 3A               	FIM P7, '9'+1
     320/      B7 : 5D D0               	JMS CMP_P1P7
     321/      B9 : 12 BC               	JCN C,  ISHEX_L1	; P1>='9'+1 then jump to next chance
     322/      BB : C1                  	BBL 1			; '0'<=P1<='9'
     323/      BC :                     ISHEX_L1:
     324/      BC : 2E 41               	FIM P7, 'A'
     325/      BE : 5D D0               	JMS CMP_P1P7
     326/      C0 : 12 C3               	JCN C, ISHEX_L10
     327/      C2 : C0                  	BBL 0			; P1<'A'
     328/      C3 :                     ISHEX_L10:
     329/      C3 : 2E 47               	FIM P7, 'F'+1
     330/      C5 : 5D D0               	JMS CMP_P1P7
     331/      C7 : 12 CA               	JCN C,  ISHEX_L2	; P1>='F'+1 then jump to next chance
     332/      C9 : C1                  	BBL 1			; 'A'<=P1<='F'
     333/      CA :                     ISHEX_L2:
     334/      CA : 2E 61               	FIM P7, 'a'
     335/      CC : 5D D0               	JMS CMP_P1P7
     336/      CE : 12 D1               	JCN C, ISHEX_L20
     337/      D0 : C0                  	BBL 0			; P1<'a'
     338/      D1 :                     ISHEX_L20:	
     339/      D1 : 2E 67               	FIM P7, 'f'+1
     340/      D3 : 5D D0               	JMS CMP_P1P7
     341/      D5 : 12 D8               	JCN C, ISHEX_FALSE	; P1>='f'+1
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 10 - 2023/03/11 11:35:13


     342/      D7 : C1                  	BBL 1			; 'a'<=P1<= 'f'
     343/      D8 :                     ISHEX_FALSE:
     344/      D8 : C0                  	BBL 0
     345/      D9 :                     
     346/      D9 :                     ;;;---------------------------------------------------------------------------
     347/      D9 :                     ;;; Program for Very Very Tiny Language Interpreter
     348/      D9 :                     ;;;---------------------------------------------------------------------------
     349/     100 :                     	org 0100H
     350/     100 :                     
     351/     100 :                     ;;;---------------------------------------------------------------------------
     352/     100 :                     ;;; Error codes
     353/     100 :                     ;;;---------------------------------------------------------------------------
     354/     100 : =0H                  ERROR_NOERROR			equ 00H
     355/     100 : =0A0H                ERROR_PRINT_CANNOTPRINT		equ 0A0H
     356/     100 : =0B0H                ERROR_RETURN_P2_IS_00		equ 0B0H
     357/     100 : =0E0H                ERROR_EXEC_SYNTAX_ERROR		equ 0E0H
     358/     100 : =0E1H                ERROR_EVAL_UNEXPECTED_EOL	equ 0E1H
     359/     100 : =0E2H                ERROR_EVAL_UNKNOWNOPERATOR	equ 0E2H
     360/     100 : =0F0H                ERROR_FACTOR_NOTAFACTOR		equ 0F0H
     361/     100 :                     	
     362/     100 :                     ;;;---------------------------------------------------------------------------
     363/     100 :                     COMMAND_V:
     364/     100 :                     ;;; commented out for debug
     365/     100 : 20 54               	FIM P0, lo(STR_VTL_MESSAGE)
     366/     102 : 5E 00               	JMS PRINTSTR_P0
     367/     104 :                     
     368/     104 : 22 00               	FIM P1, ERROR_NOERROR
     369/     106 : 20 78               	FIM P0, REG8_ERROR
     370/     108 : 56 60               	JMS LD_REG8P0_P1		; clear ERROR
     371/     10A : 20 7A               	FIM P0, REG8_ERROR2
     372/     10C : 56 60               	JMS LD_REG8P0_P1		; clear ERROR
     373/     10E :                     
     374/     10E : 20 74               	FIM P0, REG16_PEND
     375/     110 : 24 01               	FIM P2, up(PM12_PROGRAM)
     376/     112 : 26 00               	FIM P3, lo(PM12_PROGRAM)
     377/     114 : 55 FA               	JMS LD_REG16P0_P2P3	; REG(PEND) = PM12_PROGRAM (&=256)
     378/     116 :                     	
     379/     116 :                     ;;;---------------------------------------------------------------------------
     380/     116 :                     ;;; Main Loop
     381/     116 :                     ;;;---------------------------------------------------------------------------
     382/     116 :                     VTL_START:
     383/     116 :                     	;; print REG(ERROR) if not zero
     384/     116 : 20 78               	FIM P0, REG8_ERROR
     385/     118 : 56 6B               	JMS LD_P1_REG8P0
     386/     11A : 5D F5               	JMS ISZEROORNOT_P1
     387/     11C : 14 58               	JCN Z, VTL_NOERROR
     388/     11E :                     
     389/     11E :                     	;; print error code
     390/     11E : 20 7C               	FIM P0, lo(STR_VTL_ERROR)
     391/     120 : 5E 00               	JMS PRINTSTR_P0		; print error message
     392/     122 : 58 B1               	JMS PRINTHEX_P1		; print error code
     393/     124 : 20 7A               	FIM P0, REG8_ERROR2
     394/     126 : 56 6B               	JMS LD_P1_REG8P0
     395/     128 : 58 B1               	JMS PRINTHEX_P1		; print error code 2
     396/     12A : 5D 53               	JMS PRINT_SPC
     397/     12C :                     	
     398/     12C :                     	;; print remainig buffer 
     399/     12C : 20 83               	FIM P0, lo(STR_VTL_BUF)
     400/     12E : 5E 00               	JMS PRINTSTR_P0
     401/     130 : 20 00               	FIM P0, REG16_INDEX
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 11 - 2023/03/11 11:35:13


     402/     132 : 22 00               	FIM P1, REG16_INDEX
     403/     134 : 59 DA               	JMS PUSH_REG16P1
     404/     136 : 55 DB               	JMS DEC_REG16P0
     405/     138 : 57 ED               	JMS PRINTSTR_PM12REG16P0 ; print PM(REG(INDEX)-1) (for debug)
     406/     13A : 59 FD               	JMS POP_REG16P1		 ; print PM(REG(INDEX)) is enough?
     407/     13C : 5D 5C               	JMS PRINT_CRLF
     408/     13E :                     
     409/     13E :                     	;; print error line number
     410/     13E : 22 6C               	FIM P1, REG16_LINENUM
     411/     140 : 55 BA               	JMS ISZEROORNOT_REG16P1
     412/     142 : 14 4E               	JCN Z, VTL_ERROR_NOLINENUM
     413/     144 : 20 8C               	FIM P0, lo(STR_VTL_ERRORLINENUM)
     414/     146 : 5E 00               	JMS PRINTSTR_P0
     415/     148 : 22 6C               	FIM P1, REG16_LINENUM
     416/     14A : 58 1E               	JMS PRINT_REG16P1
     417/     14C : 5D 5C               	JMS PRINT_CRLF
     418/     14E :                     	
     419/     14E :                     VTL_ERROR_NOLINENUM:
     420/     14E :                     	;; clear error registers
     421/     14E : 22 00               	FIM P1, ERROR_NOERROR
     422/     150 : 20 78               	FIM P0, REG8_ERROR
     423/     152 : 56 60               	JMS LD_REG8P0_P1		; clear ERROR
     424/     154 : 20 7A               	FIM P0, REG8_ERROR2
     425/     156 : 56 60               	JMS LD_REG8P0_P1		; clear ERROR
     426/     158 :                     	
     427/     158 :                     VTL_NOERROR:
     428/     158 :                     	;; if SP !=0 print it and reset (for debug)
     429/     158 : 2E FC               	FIM P7, REG16_STACKPOINTER
     430/     15A : 2F                  	SRC P7
     431/     15B : EC                  	RD0
     432/     15C : B2                  	XCH R2
     433/     15D : ED                  	RD1
     434/     15E : B3                  	XCH R3
     435/     15F : 5D F5               	JMS ISZEROORNOT_P1
     436/     161 : 14 6F               	JCN Z, VTL_OK
     437/     163 : 20 88               	FIM P0, lo(STR_VTL_SP)
     438/     165 : 5E 00               	JMS PRINTSTR_P0         ; print SP
     439/     167 : A2                  	LD R2
     440/     168 : 5D 48               	JMS PRINT_ACC
     441/     16A : A3                  	LD R3
     442/     16B : 5D 48               	JMS PRINT_ACC
     443/     16D :                     
     444/     16D :                     	;; RESET SP
     445/     16D : 59 3A                	JMS INIT_STACKPOINTER	; reset stack pointer
     446/     16F :                     VTL_OK:	
     447/     16F : 20 75               	FIM P0, lo(STR_VTL_OK)
     448/     171 : 5E 00               	JMS PRINTSTR_P0
     449/     173 :                     
     450/     173 :                     ;;; LOOP entry for program input
     451/     173 :                     VTL_LOOP:
     452/     173 :                     	;; 	FIM P1, '%'
     453/     173 :                     	;; 	JMS PUTCHAR_P1		; put a prompt (for debug)
     454/     173 :                     
     455/     173 : 20 6C               	FIM P0, REG16_LINENUM	; clear linenumber counter
     456/     175 : 55 43               	JMS CLEAR_REG16P0
     457/     177 :                     
     458/     177 : 20 00               	FIM P0, REG16_INDEX
     459/     179 : 24 00               	FIM P2, up(PM12_LINEBUF)
     460/     17B : 26 00               	FIM P3, lo(PM12_LINEBUF)
     461/     17D : 55 FA               	JMS LD_REG16P0_P2P3	; REG(INDEX) = PM12_LNEBUF
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 12 - 2023/03/11 11:35:13


     462/     17F :                     
     463/     17F : 5A 1E               	JMS GETLINE_PM12REG16P0
     464/     181 :                     	;; 	JMS SKIPSPACE_PM12REG16P0
     465/     181 :                     
     466/     181 : 59 07               	JMS LD_P1_PM12REG16P0	; P1=PM12(REG(INDEX)
     467/     183 :                     
     468/     183 : 2E 2E               	FIM P7, '.'		; quit to the monitor program (for debug)
     469/     185 : 5D D0               	JMS CMP_P1P7
     470/     187 : 1C 8B               	JCN ZN, VTL_L0
     471/     189 : 40 1B               	JUN CMD_LOOP
     472/     18B :                     VTL_L0:
     473/     18B : 5D 8C               	JMS ISNUM_P1
     474/     18D : 14 91               	JCN Z, VTL_L1
     475/     18F : 41 A5               	JUN VTL_INSERT_PROGRAMLINE ; Top character is a number
     476/     191 :                     VTL_L1:	
     477/     191 : 20 6C               	FIM P0, REG16_LINENUM
     478/     193 : 24 00               	FIM P2, 00H
     479/     195 : 26 00               	FIM P3, 00H
     480/     197 : 55 FA               	JMS LD_REG16P0_P2P3	; REG(LINENUM)=0
     481/     199 :                     
     482/     199 : 20 70               	FIM P0, REG16_NEXTLINEPTR
     483/     19B : 24 0D               	FIM P2, up(PM12_MEMEND)
     484/     19D : 26 FF               	FIM P3, lo(PM12_MEMEND)
     485/     19F : 55 FA               	JMS LD_REG16P0_P2P3	; REG(NEXTLINEPTR)=MEMEND to exit after exec
     486/     1A1 :                     
     487/     1A1 : 20 00               	FIM P0, REG16_INDEX
     488/     1A3 : 42 72               	JUN VTL_RUN_SINGLE_LINE
     489/     1A5 :                     
     490/     1A5 :                     ;;;----------------------------------------------------------------------------
     491/     1A5 :                     ;;; VTL_INSERT_PROGRAMLINE
     492/     1A5 :                     ;;; Input program line to program area
     493/     1A5 :                     ;;;----------------------------------------------------------------------------
     494/     1A5 :                     VTL_INSERT_PROGRAMLINE:
     495/     1A5 :                     	;; 	include "stacktest.inc"
     496/     1A5 :                     	;; 	include "numbertest.inc"
     497/     1A5 :                     	;; FIM P0, REG16_INDEX  ; this can be omitted?
     498/     1A5 : 22 A0               	FIM P1, REG16_TMP
     499/     1A7 : 5A 71               	JMS GETNUMBER_PM12REG16P0_REG16P1
     500/     1A9 : 55 BA               	JMS ISZEROORNOT_REG16P1
     501/     1AB : 1C AF               	JCN ZN, INSERT_PROGRAM_L1
     502/     1AD : 42 14               	JUN PRINT_LIST
     503/     1AF :                     INSERT_PROGRAM_L1:
     504/     1AF : 55 CB               	JMS INC_REG16P0		; skip ' ' without check for symplification
     505/     1B1 :                     
     506/     1B1 : 56 24               	JMS LD_P2P3_REG16P1 
     507/     1B3 : 20 74               	FIM P0, REG16_PEND
     508/     1B5 : (MACRO)              	LD_P1_P3
     508/     1B5 : A6                                  LD R6
     508/     1B6 : B2                                  XCH R2
     508/     1B7 : A7                                  LD R7
     508/     1B8 : B3                                  XCH R3
     509/     1B9 : 59 22               	JMS LD_PM12REG16P0_P1	; PM12(REG(PEND)++) = P3 (lower byte)
     510/     1BB : 55 CB               	JMS INC_REG16P0
     511/     1BD : (MACRO)              	LD_P1_P2
     511/     1BD : A4                                  LD R4
     511/     1BE : B2                                  XCH R2
     511/     1BF : A5                                  LD R5
     511/     1C0 : B3                                  XCH R3
     512/     1C1 : 59 22               	JMS LD_PM12REG16P0_P1	; PM12(REG(PEND)++) = P2 (upper byte)
     513/     1C3 : 55 CB               	JMS INC_REG16P0
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 13 - 2023/03/11 11:35:13


     514/     1C5 : (MACRO)              	LD_P1_P0
     514/     1C5 : A0                                  LD R0
     514/     1C6 : B2                                  XCH R2
     514/     1C7 : A1                                  LD R1
     514/     1C8 : B3                                  XCH R3
     515/     1C9 : 59 DA               	JMS PUSH_REG16P1	; PUSH(REG(PEND)) to write a pointer
     516/     1CB :                     				; to the next line afterward
     517/     1CB : 55 CB               	JMS INC_REG16P0
     518/     1CD : 55 CB               	JMS INC_REG16P0		; PEND=PEND+2
     519/     1CF :                     	
     520/     1CF :                     INSERT_PROGRAM_LOOP:
     521/     1CF : 20 00               	FIM P0, REG16_INDEX
     522/     1D1 : 59 07               	JMS LD_P1_PM12REG16P0
     523/     1D3 : 5D F5               	JMS ISZEROORNOT_P1	; EOL
     524/     1D5 : 14 E1               	JCN Z, INSERT_PROGRAM_EXIT
     525/     1D7 : 55 CB               	JMS INC_REG16P0		; REG(INDEX)++
     526/     1D9 : 20 74               	FIM P0, REG16_PEND
     527/     1DB : 59 22               	JMS LD_PM12REG16P0_P1	; copy PM12(REG(INDEX)) to PM12(REG(PEND))
     528/     1DD : 55 CB               	JMS INC_REG16P0		; REG(PEND)++
     529/     1DF :                     	;; the end of memory check is omitted for simplicity
     530/     1DF : 41 CF               	JUN INSERT_PROGRAM_LOOP	;
     531/     1E1 :                     	
     532/     1E1 :                     INSERT_PROGRAM_EXIT:
     533/     1E1 : 20 74               	FIM P0, REG16_PEND
     534/     1E3 : 22 00               	FIM P1, 00H
     535/     1E5 : 59 22               	JMS LD_PM12REG16P0_P1	; write EOL and increment REG(PEND)
     536/     1E7 : 55 CB               	JMS INC_REG16P0
     537/     1E9 :                     
     538/     1E9 : 56 76               	JMS LD_P2P3_REG16P0	; P2P3=REG(PEND)
     539/     1EB : 22 A0               	FIM P1, REG16_TMP
     540/     1ED : 59 FD               	JMS POP_REG16P1		; pop the place to write the next line pointer
     541/     1EF : (MACRO)              	LD_P0_P1
     541/     1EF : A2                                  LD R2
     541/     1F0 : B0                                  XCH R0
     541/     1F1 : A3                                  LD R3
     541/     1F2 : B1                                  XCH R1
     542/     1F3 : (MACRO)              	LD_P1_P3
     542/     1F3 : A6                                  LD R6
     542/     1F4 : B2                                  XCH R2
     542/     1F5 : A7                                  LD R7
     542/     1F6 : B3                                  XCH R3
     543/     1F7 : 59 22               	JMS LD_PM12REG16P0_P1
     544/     1F9 : 55 CB               	JMS INC_REG16P0
     545/     1FB : (MACRO)              	LD_P1_P2
     545/     1FB : A4                                  LD R4
     545/     1FC : B2                                  XCH R2
     545/     1FD : A5                                  LD R5
     545/     1FE : B3                                  XCH R3
     546/     1FF : 59 22               	JMS LD_PM12REG16P0_P1
     547/     201 :                     	
     548/     201 : 41 73               	JUN VTL_LOOP
     549/     203 :                     ;;; 	JUN CMD_LOOP		;; return to command loop (for debug)
     550/     203 :                     
     551/     203 :                     ;;;----------------------------------------------------------------------------
     552/     203 :                     ;;; LD_P2P3_PM12REG16P0_AND_INCREMENT
     553/     203 :                     ;;; Get 16bit from PM
     554/     203 :                     ;;; P3=PM(REG(P0)++)
     555/     203 :                     ;;; P2=PM(REG(P0)++)
     556/     203 :                     ;;; destroy: P1
     557/     203 :                     ;;;----------------------------------------------------------------------------
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 14 - 2023/03/11 11:35:13


     558/     203 :                     LD_P2P3_PM12REG16P0_AND_INCREMENT:
     559/     203 : 59 07               	JMS LD_P1_PM12REG16P0
     560/     205 : 55 CB               	JMS INC_REG16P0
     561/     207 : (MACRO)              	LD_P3_P1
     561/     207 : A2                                  LD R2
     561/     208 : B6                                  XCH R6
     561/     209 : A3                                  LD R3
     561/     20A : B7                                  XCH R7
     562/     20B : 59 07               	JMS LD_P1_PM12REG16P0
     563/     20D : 55 CB               	JMS INC_REG16P0
     564/     20F : (MACRO)              	LD_P2_P1
     564/     20F : A2                                  LD R2
     564/     210 : B4                                  XCH R4
     564/     211 : A3                                  LD R3
     564/     212 : B5                                  XCH R5
     565/     213 : C0                  	BBL 0
     566/     214 :                     	
     567/     214 :                     ;;;----------------------------------------------------------------------------
     568/     214 :                     ;;; PRINT_LIST:
     569/     214 :                     ;;; Print program list
     570/     214 :                     ;;;----------------------------------------------------------------------------
     571/     214 :                     PRINT_LIST:
     572/     214 : 20 00               	FIM P0, REG16_INDEX
     573/     216 : 24 01               	FIM P2, up(PM12_PROGRAM)
     574/     218 : 26 00               	FIM P3, lo(PM12_PROGRAM)
     575/     21A : 55 FA               	JMS LD_REG16P0_P2P3	; REG(INDEX) = PM12_PROGRAM
     576/     21C :                     
     577/     21C :                     PRINT_LIST_LOOP:
     578/     21C : 22 74               	FIM P1, REG16_PEND
     579/     21E : 57 C9               	JMS CMP_REG16P0_REG16P1
     580/     220 : 1A 24               	JCN CN, PRINT_LIST_PRINTLINE
     581/     222 : 41 16               	JUN VTL_START		; exit to VTL_START
     582/     224 :                     PRINT_LIST_PRINTLINE
     583/     224 :                     	;; Get line number
     584/     224 : 52 03               	JMS LD_P2P3_PM12REG16P0_AND_INCREMENT
     585/     226 : 22 6C               	FIM P1, REG16_LINENUM
     586/     228 : 56 0F               	JMS LD_REG16P1_P2P3
     587/     22A :                     
     588/     22A : 58 1E               	JMS PRINT_REG16P1
     589/     22C : 5D 53               	JMS PRINT_SPC
     590/     22E :                     	
     591/     22E : 55 CB               	JMS INC_REG16P0 	; skip pointer to next line
     592/     230 : 55 CB               	JMS INC_REG16P0
     593/     232 :                     
     594/     232 : 57 ED               	JMS PRINTSTR_PM12REG16P0
     595/     234 : 5D 5C               	JMS PRINT_CRLF
     596/     236 : 55 CB               	JMS INC_REG16P0		; increment pointer to the next char of EOL
     597/     238 : 42 1C               	JUN PRINT_LIST_LOOP
     598/     23A :                     
     599/     23A :                     ;;;----------------------------------------------------------------------------
     600/     23A :                     ;;; FIND_LINE_AND_EXEC
     601/     23A :                     ;;; Search for the linenumber REG(LINENUM) and find the pointer of the line
     602/     23A :                     ;;; to be executed (minimum linenumber >= REG(LINENUM))
     603/     23A :                     ;;; in the PM(PROGRAM) and set REG(LINENUM) to the found linenumber
     604/     23A :                     ;;; and execute it
     605/     23A :                     ;;;----------------------------------------------------------------------------
     606/     23A :                     FIND_LINE_AND_EXEC:
     607/     23A : 20 00               	FIM P0, REG16_INDEX
     608/     23C : 24 01               	FIM P2, up(PM12_PROGRAM)
     609/     23E : 26 00               	FIM P3, lo(PM12_PROGRAM)
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 15 - 2023/03/11 11:35:13


     610/     240 : 55 FA               	JMS LD_REG16P0_P2P3	; REG(INDEX) = PM12_PROGRAM
     611/     242 :                     
     612/     242 :                     FIND_LINE_LOOP:
     613/     242 : 52 03               	JMS LD_P2P3_PM12REG16P0_AND_INCREMENT ; P2P3= line number
     614/     244 : 20 A0               	FIM P0, REG16_TMP
     615/     246 : 55 FA               	JMS LD_REG16P0_P2P3		; REG(TMP) = current line number
     616/     248 :                     
     617/     248 : 22 6C               	FIM P1, REG16_LINENUM
     618/     24A : 57 C9               	JMS CMP_REG16P0_REG16P1
     619/     24C : 12 5C                	JCN C, FIND_LINE_AND_EXEC_GO	; REG(TMP) >= REG(LINENUM) then exec
     620/     24E :                     	
     621/     24E : 20 00               	FIM P0, REG16_INDEX
     622/     250 : 52 03               	JMS LD_P2P3_PM12REG16P0_AND_INCREMENT ; P2P3= next line pointer
     623/     252 : 22 74               	FIM P1, REG16_PEND
     624/     254 : 55 FA               	JMS LD_REG16P0_P2P3	; REG(INDEX) = next line pointer
     625/     256 : 57 C9               	JMS CMP_REG16P0_REG16P1
     626/     258 : 12 60               	JCN C, FIND_LINE_AND_EXEC_EXIT	; REG(INDEX)>=REG(PEND)
     627/     25A : 42 42               	JUN FIND_LINE_LOOP
     628/     25C :                     	
     629/     25C :                     FIND_LINE_AND_EXEC_GO:
     630/     25C : 55 63               	JMS LD_REG16P1_REG16P0	; REG(LINENUM) = real linenum
     631/     25E : 42 6A               	JUN VTL_RUN_PROGRAM_PMINDEX_FROM_GOTO ; 
     632/     260 :                     	
     633/     260 :                     FIND_LINE_AND_EXEC_EXIT:
     634/     260 : 41 16               	JUN VTL_START		; reach the end of the program
     635/     262 :                     	
     636/     262 :                     ;;;----------------------------------------------------------------------------
     637/     262 :                     ;;; VTL_RUN_PROGRAM_PMINDEX:
     638/     262 :                     ;;; Run the program buffer
     639/     262 :                     ;;; one line is:
     640/     262 :                     ;;; 	2 byte: linenumber
     641/     262 :                     ;;; 	2 byte: PTR to next line
     642/     262 :                     ;;; 	   x  : program code
     643/     262 :                     ;;; 	1 byte: 00H (EOL)
     644/     262 :                     ;;; if REG(NEXTLINEPTR)==0 or REG(NEXTLINEPTR)>=REG(PEND) then back to prompt
     645/     262 :                     ;;;----------------------------------------------------------------------------
     646/     262 :                     VTL_RUN_PROGRAM_PMINDEX:
     647/     262 : 20 00               	FIM P0, REG16_INDEX
     648/     264 : 52 03               	JMS LD_P2P3_PM12REG16P0_AND_INCREMENT ; P2P3= line number
     649/     266 : 20 6C               	FIM P0, REG16_LINENUM
     650/     268 : 55 FA               	JMS LD_REG16P0_P2P3		; REG(LINENUM) = current line number
     651/     26A :                     VTL_RUN_PROGRAM_PMINDEX_FROM_GOTO:
     652/     26A : 20 00               	FIM P0, REG16_INDEX
     653/     26C : 52 03               	JMS LD_P2P3_PM12REG16P0_AND_INCREMENT 
     654/     26E : 20 70               	FIM P0, REG16_NEXTLINEPTR
     655/     270 : 55 FA               	JMS LD_REG16P0_P2P3             ; P2P3= next line pointer
     656/     272 :                     
     657/     272 :                     VTL_RUN_SINGLE_LINE:
     658/     272 : 42 86               	JUN VTL_EXECUTE_PMINDEX
     659/     274 :                     
     660/     274 :                     VTL_RUN_SINGLE_LINE_RETURN:
     661/     274 : 20 74               	FIM P0, REG16_PEND
     662/     276 : 22 70               	FIM P1, REG16_NEXTLINEPTR
     663/     278 : 57 C9               	JMS CMP_REG16P0_REG16P1
     664/     27A : 1A 84               	JCN CN, VTL_RUN_PROGRAM_EXIT	; REG(PEND) < REG(NEXTLINEPTR)
     665/     27C : 14 84               	JCN  Z, VTL_RUN_PROGRAM_EXIT	; REG(PEND) == REG(NEXTLINEPTR)
     666/     27E : 20 00               	FIM P0, REG16_INDEX
     667/     280 : 55 50               	JMS LD_REG16P0_REG16P1		; REG(INDEX) = REG(NEXTLINEPTR)
     668/     282 : 42 62               	JUN VTL_RUN_PROGRAM_PMINDEX
     669/     284 :                     VTL_RUN_PROGRAM_EXIT:
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 16 - 2023/03/11 11:35:13


     670/     284 : 41 16               	JUN VTL_START		; exit to VTL_START
     671/     286 :                     	
     672/     286 :                     ;;;----------------------------------------------------------------------------
     673/     286 :                     ;;; VTL_EXECUTE_PMINDEX
     674/     286 :                     ;;; Execute a string PM12(REG(INDEX))
     675/     286 :                     ;;; destroy: P0, P1
     676/     286 :                     ;;;----------------------------------------------------------------------------
     677/     286 :                     VTL_EXECUTE_PMINDEX:
     678/     286 :                     	;; if some initialization is needed, write here
     679/     286 :                     VTL_EXECUTE_PMINDEX_CONTINUE:
     680/     286 : 20 00               	FIM P0, REG16_INDEX
     681/     288 :                     
     682/     288 : 55 1D               	JMS SKIPSPACE_PM12REG16P0 ; skip spaces ' '
     683/     28A : 59 07               	JMS LD_P1_PM12REG16P0	  ; get the left term
     684/     28C : 5D F5               	JMS ISZEROORNOT_P1
     685/     28E : 1C 92               	JCN ZN, VTL_EXEC_L0
     686/     290 : 42 74               	JUN VTL_RUN_SINGLE_LINE_RETURN ; return to the run loop
     687/     292 :                     
     688/     292 :                     VTL_EXEC_L0:	
     689/     292 : 55 CB               	JMS INC_REG16P0		; REG16P0++
     690/     294 :                     
     691/     294 :                     	;;  Print
     692/     294 : 2E 3F               	FIM P7, '?'
     693/     296 : 5D D0               	JMS CMP_P1P7
     694/     298 : 14 9C               	JCN Z, VTL_SET_PRINTFMT	; go to check print format
     695/     29A : 42 BD               	JUN VTL_EXEC_L1
     696/     29C :                     VTL_SET_PRINTFMT:
     697/     29C :                     	;; check the next char to '?' and set print format
     698/     29C : 59 07               	JMS LD_P1_PM12REG16P0  ; check printformat "?=" or "?$=" or "??="
     699/     29E :                     
     700/     29E : 2E 24               	FIM P7, '$'
     701/     2A0 : 5D D0               	JMS CMP_P1P7
     702/     2A2 : 1C AB               	JCN NZ, VTL_EXEC_L0_CHECKHEX4;
     703/     2A4 : 55 CB               	JMS INC_REG16P0		; REG16P0++ for '$'
     704/     2A6 :                     
     705/     2A6 : D1                  	LDM PRINTFMT_HEX2B
     706/     2A7 : 53 38               	JMS SET_PRINTFORMAT
     707/     2A9 :                     	
     708/     2A9 : 43 43               	JUN VTL_EXEC_PRINT
     709/     2AB :                     
     710/     2AB :                     VTL_EXEC_L0_CHECKHEX4:
     711/     2AB : 2E 3F               	FIM P7, '?'
     712/     2AD : 5D D0               	JMS CMP_P1P7
     713/     2AF : 1C B8               	JCN NZ, VTL_EXEC_L0_NORMAL
     714/     2B1 : 55 CB               	JMS INC_REG16P0		; REG16P0++ for '?'
     715/     2B3 :                     
     716/     2B3 : D2                  	LDM PRINTFMT_HEX4B
     717/     2B4 : 53 38               	JMS SET_PRINTFORMAT
     718/     2B6 :                     
     719/     2B6 : 43 43               	JUN VTL_EXEC_PRINT
     720/     2B8 :                     
     721/     2B8 :                     VTL_EXEC_L0_NORMAL
     722/     2B8 :                     	;; normally it's "?=" but not check "=" for simplification
     723/     2B8 : D0                  	LDM PRINTFMT_NORMAL
     724/     2B9 : 53 38               	JMS SET_PRINTFORMAT
     725/     2BB :                     
     726/     2BB : 43 43               	JUN VTL_EXEC_PRINT
     727/     2BD :                     
     728/     2BD :                     	;; "left term = right expression" type procedures
     729/     2BD :                     VTL_EXEC_L1:
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 17 - 2023/03/11 11:35:13


     730/     2BD : 55 CB               	JMS INC_REG16P0		; SKIP '=' without check for symplification
     731/     2BF : 59 5C               	JMS PUSH_P1		; push the left term
     732/     2C1 :                     
     733/     2C1 :                     	;; Evaluate the right expression
     734/     2C1 : 22 8C               	FIM P1, REG16_EVAL
     735/     2C3 : 24 DD               	FIM P2, lo(RETURN_EXEC_R1)
     736/     2C5 : 43 93               	JUN EVAL_EXPRESSION_PMINDEX_REG16P1
     737/     2C7 :                     
     738/     2C7 :                     EXEC_R1:
     739/     2C7 : 24 8C               	FIM P2, REG16_EVAL	; set P2 to the evaluated result value
     740/     2C9 : 59 A6               	JMS POP_P1		; pop the left term
     741/     2CB :                     
     742/     2CB :                     	;; Assignment to the normal variable
     743/     2CB : 5D 9A               	JMS ISALPHA_P1
     744/     2CD : 14 D5               	JCN Z, VTL_EXEC_L2
     745/     2CF : 55 2E               	JMS CTOREG16NUM_P1	; convert the name to the register address
     746/     2D1 : 55 76               	JMS LD_REG16P1_REG16P2
     747/     2D3 : 42 86               	JUN VTL_EXECUTE_PMINDEX_CONTINUE ; execute remaining string
     748/     2D5 :                     
     749/     2D5 :                     VTL_EXEC_L2:
     750/     2D5 :                     	;; IF
     751/     2D5 : 2E 3B               	FIM P7, ';'
     752/     2D7 : 5D D0               	JMS CMP_P1P7
     753/     2D9 : 1C E5               	JCN ZN, VTL_EXEC_L3
     754/     2DB : 22 8C               	FIM P1, REG16_EVAL
     755/     2DD : 55 BA               	JMS ISZEROORNOT_REG16P1
     756/     2DF : 1C E3               	JCN ZN, VTL_EXEC_L2_TRUE
     757/     2E1 : 42 74               	JUN VTL_RUN_SINGLE_LINE_RETURN ; return to the run loop
     758/     2E3 :                     VTL_EXEC_L2_TRUE:
     759/     2E3 : 42 86               	JUN VTL_EXECUTE_PMINDEX_CONTINUE ; execute remaining string
     760/     2E5 :                     
     761/     2E5 :                     VTL_EXEC_L3:
     762/     2E5 :                     	;; GOTO
     763/     2E5 : 2E 23               	FIM P7, '#'
     764/     2E7 : 5D D0               	JMS CMP_P1P7
     765/     2E9 : 1C F9               	JCN ZN, VTL_EXEC_L4
     766/     2EB :                     VTL_EXEC_GOTO_FROM_GOSUB:
     767/     2EB : 22 8C               	FIM P1, REG16_EVAL
     768/     2ED : 55 BA               	JMS ISZEROORNOT_REG16P1
     769/     2EF : 14 F7               	JCN Z, VTL_EXEC_SKIPGOTO
     770/     2F1 : 22 6C               	FIM P1, REG16_LINENUM	         ; execute GOTO
     771/     2F3 : 55 76               	JMS LD_REG16P1_REG16P2
     772/     2F5 : 42 3A               	JUN FIND_LINE_AND_EXEC
     773/     2F7 :                     VTL_EXEC_SKIPGOTO:			 ; #=0 then do nothing
     774/     2F7 : 42 86               	JUN VTL_EXECUTE_PMINDEX_CONTINUE ; execute remaining string
     775/     2F9 :                     
     776/     2F9 :                     VTL_EXEC_L4:
     777/     2F9 :                     	;; GOSUB
     778/     2F9 : 2E 21               	FIM P7, '!'
     779/     2FB : 5D D0               	JMS CMP_P1P7
     780/     2FD : 00                  	NOP
     781/     2FE : 00                  	NOP
     782/     2FF : 00                  	NOP
     783/     300 : 14 04               	JCN Z, VTL_EXEC_GOSUB
     784/     302 : 43 10               	JUN VTL_EXEC_L5
     785/     304 :                     VTL_EXEC_GOSUB:
     786/     304 : 20 94               	FIM P0, REG16_RETURN
     787/     306 : 22 6C               	FIM P1, REG16_LINENUM
     788/     308 : 55 50               	JMS LD_REG16P0_REG16P1
     789/     30A : 55 CB               	JMS INC_REG16P0		        ; REG(!)=REG(#)+1
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 18 - 2023/03/11 11:35:13


     790/     30C : 20 00               	FIM P0, REG16_INDEX
     791/     30E :                     	
     792/     30E : 42 EB               	JUN VTL_EXEC_GOTO_FROM_GOSUB     ; jump to GOTO
     793/     310 :                     	
     794/     310 :                     VTL_EXEC_L5:
     795/     310 :                     	;; &
     796/     310 : 2E 26               	FIM P7, '&'
     797/     312 : 5D D0               	JMS CMP_P1P7
     798/     314 : 1C 1C               	JCN ZN, VTL_EXEC_L6
     799/     316 : 22 74               	FIM P1, REG16_PEND
     800/     318 : 55 76               	JMS LD_REG16P1_REG16P2
     801/     31A : 42 86               	JUN VTL_EXECUTE_PMINDEX_CONTINUE ; execute remaining string
     802/     31C :                     VTL_EXEC_L6:
     803/     31C :                     	;; Putchar
     804/     31C : 2E 24               	FIM P7, '$'
     805/     31E : 5D D0               	JMS CMP_P1P7
     806/     320 : 1C 2C               	JCN ZN, VTL_EXEC_L7
     807/     322 : (MACRO)              	LD_P0_P2
     807/     322 : A4                                  LD R4
     807/     323 : B0                                  XCH R0
     807/     324 : A5                                  LD R5
     807/     325 : B1                                  XCH R1
     808/     326 : 56 6B               	JMS LD_P1_REG16P0_8BIT
     809/     328 : 5D 28               	JMS PUTCHAR_P1
     810/     32A : 42 86               	JUN VTL_EXECUTE_PMINDEX_CONTINUE ; execute remaining string
     811/     32C :                     VTL_EXEC_L7:
     812/     32C :                     VTL_EXEC_L8:
     813/     32C :                     VTL_EXEC_L9:
     814/     32C :                     VTL_EXEC_L10:
     815/     32C :                     VTL_EXEC_SYNTAX_ERROR:
     816/     32C : 20 7A               	FIM P0, REG8_ERROR2
     817/     32E : 56 60               	JMS LD_REG8P0_P1
     818/     330 : 20 78               	FIM P0, REG8_ERROR
     819/     332 : 22 E0               	FIM P1, ERROR_EXEC_SYNTAX_ERROR
     820/     334 : 56 60               	JMS LD_REG8P0_P1
     821/     336 :                     
     822/     336 : 41 16               	JUN VTL_START
     823/     338 :                     
     824/     338 :                     ;;;----------------------------------------------------------------------------
     825/     338 :                     ;;; SET_PRINTFORMAT
     826/     338 :                     ;;; REG4(PRINTFORMAT) = ACC
     827/     338 :                     ;;;----------------------------------------------------------------------------
     828/     338 : =0H                  PRINTFMT_NORMAL		equ 00H
     829/     338 : =1H                  PRINTFMT_HEX2B		equ 01H
     830/     338 : =2H                  PRINTFMT_HEX4B		equ 02H
     831/     338 :                     
     832/     338 :                     SET_PRINTFORMAT:	
     833/     338 : 2E 7E               	FIM P7, REG4_PRINTFORMAT
     834/     33A : 2F                  	SRC P7
     835/     33B : E0                  	WRM
     836/     33C : C0                  	BBL 0
     837/     33D :                     
     838/     33D :                     GET_PRINTFORMAT_R5:
     839/     33D : 2E 7E               	FIM P7, REG4_PRINTFORMAT
     840/     33F : 2F                  	SRC P7
     841/     340 : E9                  	RDM
     842/     341 : B5                  	XCH R5
     843/     342 : C0                  	BBL 0
     844/     343 :                     ;;;----------------------------------------------------------------------------
     845/     343 :                     ;;; VTL_EXEC_PRINT
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 19 - 2023/03/11 11:35:13


     846/     343 :                     ;;;----------------------------------------------------------------------------
     847/     343 :                     VTL_EXEC_PRINT:
     848/     343 : 55 CB               	JMS INC_REG16P0		; SKIP '=' without check for symplification
     849/     345 :                     
     850/     345 : 59 07               	JMS LD_P1_PM12REG16P0
     851/     347 : 5D F5               	JMS ISZEROORNOT_P1
     852/     349 : 1C 4D               	JCN ZN, VTL_EXEC_PRINT_L1	; not EOL
     853/     34B : 43 8B               	JUN VTL_PRINT_ERREXIT   	; EOL
     854/     34D :                     VTL_EXEC_PRINT_L1:
     855/     34D : 2E 22               	FIM P7, '"'		; "
     856/     34F : 5D D0               	JMS CMP_P1P7
     857/     351 : 1C 55               	JCN ZN, VTL_PRINT_L2
     858/     353 : 43 77               	JUN VTL_PRINT_QUOTEDSTRING
     859/     355 :                     VTL_PRINT_L2:	
     860/     355 : 22 8C               	FIM P1, REG16_EVAL
     861/     357 : 24 E7               	FIM P2, lo(RETURN_PRINT_R1)
     862/     359 : 43 93               	JUN EVAL_EXPRESSION_PMINDEX_REG16P1
     863/     35B :                     PRINT_R1:
     864/     35B : 53 3D               	JMS GET_PRINTFORMAT_R5
     865/     35D : F0                  	CLB
     866/     35E : D1                  	LDM PRINTFMT_HEX2B
     867/     35F : 95                  	SUB R5
     868/     360 : 1C 6A               	JCN NZ, VTL_PRINT_FMT2
     869/     362 : 20 8C               	FIM P0, REG16_EVAL		; restore P0 afterwards if needed
     870/     364 : 56 6B               	JMS LD_P1_REG16P0_8BIT
     871/     366 : 58 B1               	JMS PRINTHEX_P1
     872/     368 : 43 91               	JUN VTL_PRINT_EXIT
     873/     36A :                     VTL_PRINT_FMT2:
     874/     36A : F0                  	CLB
     875/     36B : D2                  	LDM PRINTFMT_HEX4B
     876/     36C : 95                  	SUB R5
     877/     36D : 1C 73               	JCN NZ, VTL_PRINT_DEFAULT
     878/     36F : 58 8E               	JMS PRINTHEX_REG16P1
     879/     371 : 43 91               	JUN VTL_PRINT_EXIT
     880/     373 :                     
     881/     373 :                     VTL_PRINT_DEFAULT:
     882/     373 : 58 1E               	JMS PRINT_REG16P1
     883/     375 : 43 91               	JUN VTL_PRINT_EXIT
     884/     377 :                     
     885/     377 :                     VTL_PRINT_QUOTEDSTRING:
     886/     377 : 55 CB               	JMS INC_REG16P0		; INDEX++
     887/     379 : 57 F5               	JMS PRINTSTR_PM12REG16P0_DELIM_P1
     888/     37B : 59 07               	JMS LD_P1_PM12REG16P0
     889/     37D : 2E 3B               	FIM P7, ';'
     890/     37F : 5D D0               	JMS CMP_P1P7
     891/     381 : 14 87               	JCN Z, VTL_PRINT_SKIPCRLF	; skip CRLF and increment INDEX
     892/     383 : 5D 5C               	JMS PRINT_CRLF
     893/     385 : 43 91               	JUN VTL_PRINT_EXIT
     894/     387 :                     VTL_PRINT_SKIPCRLF:	
     895/     387 : 55 CB               	JMS INC_REG16P0
     896/     389 : 43 91               	JUN VTL_PRINT_EXIT
     897/     38B :                     
     898/     38B :                     VTL_PRINT_ERREXIT:
     899/     38B : 20 78               	FIM P0, REG8_ERROR
     900/     38D : 22 A0               	FIM P1, ERROR_PRINT_CANNOTPRINT
     901/     38F : 41 16               	JUN VTL_START			 ; error and jump to start
     902/     391 :                     	
     903/     391 :                     VTL_PRINT_EXIT:
     904/     391 : 42 86               	JUN VTL_EXECUTE_PMINDEX_CONTINUE ; execute remaining string
     905/     393 :                     
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 20 - 2023/03/11 11:35:13


     906/     393 :                     ;;;----------------------------------------------------------------------------
     907/     393 :                     ;;; EVAL_EXPRESSION_PMINDEX_REG16P1
     908/     393 :                     ;;; Evaluate expression PM(REG(INDEX)) and set result to REG(P1)
     909/     393 :                     ;;; destory: P0, P6, P7
     910/     393 :                     ;;; return: P0=REG16_INDEX, REG(P1)=result
     911/     393 :                     ;;; REG16(INDEX) is incremented to the end of expression +1, (EOL if EOL)
     912/     393 :                     ;;;----------------------------------------------------------------------------
     913/     393 :                     EVAL_EXPRESSION_PMINDEX_REG16P1:
     914/     393 : 59 74               	JMS PUSH_P2		; PUSH a return label
     915/     395 : 59 5C               	JMS PUSH_P1
     916/     397 :                     
     917/     397 : 20 00               	FIM P0, REG16_INDEX
     918/     399 : 59 07               	JMS LD_P1_PM12REG16P0
     919/     39B : 5D F5               	JMS ISZEROORNOT_P1	; check EOL
     920/     39D : 1C A7               	JCN ZN, EVAL_START
     921/     39F :                     	;; EOL and EXIT
     922/     39F :                     	;; Do nothing, and REG(EVAL) does not change.
     923/     39F : 20 78               	FIM P0, REG8_ERROR
     924/     3A1 : 22 E1               	FIM P1, ERROR_EVAL_UNEXPECTED_EOL
     925/     3A3 : 56 60               	JMS LD_REG8P0_P1
     926/     3A5 : 41 16               	JUN VTL_START		; error and jump to VTL_START
     927/     3A7 :                     	;; 	FIM P0, REG16_INDEX	; restore P0 to INDEX
     928/     3A7 :                     	;; 	JMS POP_P1
     929/     3A7 :                     	;; 	JMS POP_P2
     930/     3A7 :                     	;; 	JUN RETURN_P2
     931/     3A7 :                     
     932/     3A7 :                     EVAL_START:	
     933/     3A7 :                     	;; get a factor and push it
     934/     3A7 : 22 80               	FIM P1, REG16_LVALUE
     935/     3A9 : 24 DF               	FIM P2, lo(RETURN_EVAL_R1)
     936/     3AB : 44 51               	JUN GETFACTOR_PMINDEX_REG16P1
     937/     3AD :                     EVAL_R1:	
     938/     3AD :                     EVAL_CONTINUE:
     939/     3AD : 20 00               	FIM P0, REG16_INDEX
     940/     3AF : 22 80               	FIM P1, REG16_LVALUE
     941/     3B1 : 59 DA               	JMS PUSH_REG16P1		; push the LVALUE
     942/     3B3 : 59 07               	JMS LD_P1_PM12REG16P0		; get an operator
     943/     3B5 :                     
     944/     3B5 : 5D F5               	JMS ISZEROORNOT_P1		; no operator and EOL, then exit
     945/     3B7 : 1C BB               	JCN ZN, EVAL_NEXT1
     946/     3B9 : 44 41               	JUN EVAL_EXIT
     947/     3BB :                     EVAL_NEXT1:
     948/     3BB : 55 CB               	JMS INC_REG16P0			; increment INDEX if not EOL
     949/     3BD :                     
     950/     3BD : 2E 29               	FIM P7, ')'
     951/     3BF : 5D D0               	JMS CMP_P1P7
     952/     3C1 : 1C C5               	JCN ZN, EVAL_NEXT2		; if ')', then exit
     953/     3C3 : 44 41               	JUN EVAL_EXIT
     954/     3C5 :                     EVAL_NEXT2:
     955/     3C5 : 2E 20               	FIM P7, ' '
     956/     3C7 : 5D D0               	JMS CMP_P1P7
     957/     3C9 : 1C CD               	JCN ZN, EVAL_NEXT3		; if ' ', then exit
     958/     3CB : 44 41               	JUN EVAL_EXIT
     959/     3CD :                     EVAL_NEXT3:
     960/     3CD :                     
     961/     3CD : 59 5C               	JMS PUSH_P1			; push the operator
     962/     3CF :                     
     963/     3CF : 22 84               	FIM P1, REG16_RVALUE
     964/     3D1 : 24 E1               	FIM P2, lo(RETURN_EVAL_R2)
     965/     3D3 : 44 51               	JUN GETFACTOR_PMINDEX_REG16P1   ; get RVALUE
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 21 - 2023/03/11 11:35:13


     966/     3D5 :                     EVAL_R2:	
     967/     3D5 : 59 C0               	JMS POP_P2			; pop the operator to P2
     968/     3D7 :                     
     969/     3D7 : 22 80               	FIM P1, REG16_LVALUE
     970/     3D9 : 59 FD               	JMS POP_REG16P1		        ; pop the LVALUE
     971/     3DB :                     
     972/     3DB :                     ;;; 
     973/     3DB : 20 80               	FIM P0, REG16_LVALUE		; set P0 = REG_LVALUE
     974/     3DD : 22 84               	FIM P1, REG16_RVALUE		; set P1 = REG_RVALUE
     975/     3DF :                     ;;; 
     976/     3DF :                     ;;;  execute operator calculation
     977/     3DF :                     ;;; 
     978/     3DF : 2E 2B               	FIM P7, '+'
     979/     3E1 : 5D E9               	JMS CMPEQ_P2P7
     980/     3E3 : 1C E9               	JCN ZN, EVAL_O1
     981/     3E5 : 56 C1               	JMS ADD_REG16P0_REG16P1
     982/     3E7 : 43 AD               	JUN EVAL_CONTINUE
     983/     3E9 :                     EVAL_O1:
     984/     3E9 : 2E 2D               	FIM P7, '-'
     985/     3EB : 5D E9               	JMS CMPEQ_P2P7
     986/     3ED : 1C F3               	JCN ZN, EVAL_O2
     987/     3EF : 56 D6               	JMS SUB_REG16P0_REG16P1
     988/     3F1 : 43 AD               	JUN EVAL_CONTINUE
     989/     3F3 :                     EVAL_O2:
     990/     3F3 : 2E 2A               	FIM P7, '*'
     991/     3F5 : 5D E9               	JMS CMPEQ_P2P7
     992/     3F7 : 1C FD               	JCN ZN, EVAL_O3
     993/     3F9 : 56 FF               	JMS MUL_REG16P0_REG16P1
     994/     3FB : 43 AD               	JUN EVAL_CONTINUE
     995/     3FD :                     EVAL_O3:
     996/     3FD : 2E 2F               	FIM P7, '/'
     997/     3FF : 5D E9               	JMS CMPEQ_P2P7
     998/     401 : 00                  	NOP
     999/     402 : 00                  	NOP
    1000/     403 : 00                  	NOP
    1001/     404 : 00                  	NOP
    1002/     405 : 1C 0B               	JCN ZN, EVAL_O4
    1003/     407 : 57 22               	JMS DIV_REG16P0_REG16P1
    1004/     409 : 43 AD               	JUN EVAL_CONTINUE
    1005/     40B :                     EVAL_O4:
    1006/     40B : 2E 3D               	FIM P7, '='
    1007/     40D : 5D E9               	JMS CMPEQ_P2P7
    1008/     40F : 1C 1F               	JCN ZN, EVAL_O5
    1009/     411 : 57 C9               	JMS CMP_REG16P0_REG16P1
    1010/     413 : 14 19               	JCN Z, EVAL_LVALUE_TRUE ; jump if REG(P0)==REG(P1)
    1011/     415 :                     EVAL_LVALUE_FALSE:	
    1012/     415 : 55 43               	JMS CLEAR_REG16P0	; set LVALUE=0
    1013/     417 : 43 AD               	JUN EVAL_CONTINUE
    1014/     419 :                     EVAL_LVALUE_TRUE:	
    1015/     419 : 22 01               	FIM P1, 1
    1016/     41B : 56 39               	JMS LD_REG16P0_8BIT_P1	; set LVALUE=1
    1017/     41D : 43 AD               	JUN EVAL_CONTINUE
    1018/     41F :                     EVAL_O5:
    1019/     41F : 2E 3C               	FIM P7, '<'
    1020/     421 : 5D E9               	JMS CMPEQ_P2P7
    1021/     423 : 1C 2B               	JCN ZN, EVAL_06
    1022/     425 : 57 C9               	JMS CMP_REG16P0_REG16P1
    1023/     427 : 1A 19               	JCN CN, EVAL_LVALUE_TRUE  ; jump if REG(P0) < REG(P1)
    1024/     429 : 44 15               	JUN EVAL_LVALUE_FALSE
    1025/     42B :                     EVAL_06:
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 22 - 2023/03/11 11:35:13


    1026/     42B : 2E 3E               	FIM P7, '>'
    1027/     42D : 5D E9               	JMS CMPEQ_P2P7
    1028/     42F : 1C 37               	JCN ZN, EVAL_O7
    1029/     431 : 57 C9               	JMS CMP_REG16P0_REG16P1
    1030/     433 : 1A 15               	JCN CN, EVAL_LVALUE_FALSE ; jump if REG(P0) < REG(P1)
    1031/     435 :                     ;;; 
    1032/     435 :                     ;;; '>' is TEST FOR GREATER THAN OR EQUAL TO
    1033/     435 :                     ;;; 
    1034/     435 :                     ;;; 	JCN Z, EVAL_LVALUE_FALSE  ;         REG(P0) == REG(P1)
    1035/     435 : 44 19               	JUN EVAL_LVALUE_TRUE	  ;         REG(P0) > REG(P1)
    1036/     437 :                     EVAL_O7:
    1037/     437 :                     EVAL_O8:
    1038/     437 :                     EVAL_O9:
    1039/     437 :                     	;; ERROR (unknown operator)
    1040/     437 : 20 78               	FIM P0, REG8_ERROR
    1041/     439 : 22 E2               	FIM P1, ERROR_EVAL_UNKNOWNOPERATOR
    1042/     43B :                     
    1043/     43B : 22 80               	FIM P1, REG16_LVALUE	; set current LVALUE as a result
    1044/     43D : 59 DA               	JMS PUSH_REG16P1
    1045/     43F : 41 16               	JUN VTL_START		; error and jump to VTL_START
    1046/     441 :                     EVAL_EXIT:
    1047/     441 : 22 A0               	FIM P1, REG16_TMP
    1048/     443 : 59 FD               	JMS POP_REG16P1		; return with stacked value
    1049/     445 :                     
    1050/     445 : 59 A6               	JMS POP_P1
    1051/     447 : 20 A0               	FIM P0, REG16_TMP
    1052/     449 : 55 63               	JMS LD_REG16P1_REG16P0	; load result to REG(P1)
    1053/     44B :                     	
    1054/     44B : 20 00               	FIM P0, REG16_INDEX	; restore P0 to INDEX
    1055/     44D : 59 C0               	JMS POP_P2
    1056/     44F : 4B D0               	JUN RETURN_P2	
    1057/     451 :                     	
    1058/     451 :                     ;;;----------------------------------------------------------------------------
    1059/     451 :                     ;;; GETFACTOR_PMINDEX_REG16P1
    1060/     451 :                     ;;; Get a value of the first factor from PMINDEX and set it to REG(P1)
    1061/     451 :                     ;;;----------------------------------------------------------------------------
    1062/     451 :                     GETFACTOR_PMINDEX_REG16P1:
    1063/     451 : 59 74               	JMS PUSH_P2		; PUSH a return label
    1064/     453 : 59 5C               	JMS PUSH_P1
    1065/     455 :                     
    1066/     455 : 20 00               	FIM P0, REG16_INDEX
    1067/     457 : 59 07               	JMS LD_P1_PM12REG16P0
    1068/     459 :                     
    1069/     459 : 2E 28               	FIM P7, '('
    1070/     45B : 5D D0               	JMS CMP_P1P7
    1071/     45D : 1C 69               	JCN NZ,GETFACTOR_L0
    1072/     45F : 55 CB               	JMS INC_REG16P0
    1073/     461 : 24 E3               	FIM P2, lo(RETURN_GETFACTOR_R1)
    1074/     463 : 22 88               	FIM P1, REG16_FACTOR
    1075/     465 : 43 93               	JUN EVAL_EXPRESSION_PMINDEX_REG16P1
    1076/     467 :                     GETFACTOR_R1:
    1077/     467 : 45 11               	JUN GETFACTOR_EXIT_NOINCREMENT
    1078/     469 :                     
    1079/     469 :                     GETFACTOR_L0:
    1080/     469 : 24 88               	FIM P2, REG16_FACTOR	; P2 = REG16_FACTOR
    1081/     46B :                     
    1082/     46B :                     	;; unary operator minus '-' 
    1083/     46B : 2E 2D               	FIM P7, '-'
    1084/     46D : 5D D0               	JMS CMP_P1P7
    1085/     46F : 1C 81               	JCN NZ,GETFACTOR_L1
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 23 - 2023/03/11 11:35:13


    1086/     471 : 55 CB               	JMS INC_REG16P0
    1087/     473 : 24 E5               	FIM P2, lo(RETURN_GETFACTOR_R2)
    1088/     475 : 22 88               	FIM P1, REG16_FACTOR
    1089/     477 : 44 51               	JUN GETFACTOR_PMINDEX_REG16P1
    1090/     479 :                     GETFACTOR_R2:
    1091/     479 :                     	;; REG(FACTOR)=-REG(FACTOR) (2's complement)
    1092/     479 : 20 88               	FIM P0, REG16_FACTOR
    1093/     47B : 55 EC               	JMS COMPLEMENT_REG16P0
    1094/     47D : 55 CB               	JMS INC_REG16P0
    1095/     47F :                     	;; FIM P0, REG16_INDEX ; can be omitted because NOINCREMENT P0
    1096/     47F :                     	
    1097/     47F : 45 11               	JUN GETFACTOR_EXIT_NOINCREMENT
    1098/     481 :                     GETFACTOR_L1:
    1099/     481 :                     	;; decimal number
    1100/     481 : 5D 8C               	JMS ISNUM_P1
    1101/     483 : 14 8B               	JCN Z, GETFACTOR_L2
    1102/     485 : 22 88               	FIM P1, REG16_FACTOR
    1103/     487 : 5A 71               	JMS GETNUMBER_PM12REG16P0_REG16P1
    1104/     489 : 45 11               	JUN GETFACTOR_EXIT_NOINCREMENT
    1105/     48B :                     GETFACTOR_L2:
    1106/     48B :                     	;; variable
    1107/     48B : 5D 9A               	JMS ISALPHA_P1
    1108/     48D : 14 95               	JCN Z, GETFACTOR_L3
    1109/     48F : 55 2E               	JMS CTOREG16NUM_P1
    1110/     491 : 55 9C               	JMS LD_REG16P2_REG16P1
    1111/     493 : 45 0F               	JUN GETFACTOR_EXIT
    1112/     495 :                     GETFACTOR_L3:
    1113/     495 :                     	;; remainder of the last DIV
    1114/     495 : 2E 25               	FIM P7, '%'
    1115/     497 : 5D D0               	JMS CMP_P1P7
    1116/     499 : 1C A1               	JCN ZN, GETFACTOR_L4
    1117/     49B :                     
    1118/     49B : 22 90               	FIM P1, REG16_RMND
    1119/     49D : 55 9C               	JMS LD_REG16P2_REG16P1
    1120/     49F :                     
    1121/     49F : 45 0F               	JUN GETFACTOR_EXIT
    1122/     4A1 :                     GETFACTOR_L4:
    1123/     4A1 :                     	;; line number
    1124/     4A1 : 2E 23               	FIM P7, '#'
    1125/     4A3 : 5D D0               	JMS CMP_P1P7
    1126/     4A5 : 1C AD               	JCN ZN, GETFACTOR_L5
    1127/     4A7 :                     
    1128/     4A7 : 22 6C               	FIM P1, REG16_LINENUM
    1129/     4A9 : 55 9C               	JMS LD_REG16P2_REG16P1
    1130/     4AB :                     	
    1131/     4AB : 45 0F               	JUN GETFACTOR_EXIT
    1132/     4AD :                     GETFACTOR_L5:
    1133/     4AD :                     	;; return address
    1134/     4AD : 2E 21               	FIM P7, '!'
    1135/     4AF : 5D D0               	JMS CMP_P1P7
    1136/     4B1 : 1C B9               	JCN ZN, GETFACTOR_L6
    1137/     4B3 :                     
    1138/     4B3 : 22 94               	FIM P1, REG16_RETURN
    1139/     4B5 : 55 9C               	JMS LD_REG16P2_REG16P1
    1140/     4B7 :                     
    1141/     4B7 : 45 0F               	JUN GETFACTOR_EXIT
    1142/     4B9 :                     GETFACTOR_L6:
    1143/     4B9 :                     	;; random number
    1144/     4B9 : 2E 27               	FIM P7, '\''
    1145/     4BB : 5D D0               	JMS CMP_P1P7
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 24 - 2023/03/11 11:35:13


    1146/     4BD : 1C C5               	JCN ZN, GETFACTOR_L7
    1147/     4BF :                     
    1148/     4BF : 22 98               	FIM P1, REG16_RANDOM
    1149/     4C1 : 55 9C               	JMS LD_REG16P2_REG16P1
    1150/     4C3 :                     
    1151/     4C3 : 45 0F               	JUN GETFACTOR_EXIT
    1152/     4C5 :                     GETFACTOR_L7:
    1153/     4C5 :                     	;; the last byte of program
    1154/     4C5 : 2E 26               	FIM P7, '&'
    1155/     4C7 : 5D D0               	JMS CMP_P1P7
    1156/     4C9 : 1C D1               	JCN ZN, GETFACTOR_L8
    1157/     4CB :                     
    1158/     4CB : 22 74               	FIM P1, REG16_PEND
    1159/     4CD : 55 9C               	JMS LD_REG16P2_REG16P1
    1160/     4CF :                     
    1161/     4CF : 45 0F               	JUN GETFACTOR_EXIT
    1162/     4D1 :                     GETFACTOR_L8:
    1163/     4D1 :                     	;; input one charactoer from serial
    1164/     4D1 : 2E 24               	FIM P7, '$'
    1165/     4D3 : 5D D0               	JMS CMP_P1P7
    1166/     4D5 : 1C E1               	JCN ZN, GETFACTOR_L9
    1167/     4D7 :                     
    1168/     4D7 : 5D 00               	JMS GETCHAR_P1
    1169/     4D9 : 20 88               	FIM P0, REG16_FACTOR
    1170/     4DB : 56 39               	JMS LD_REG16P0_8BIT_P1
    1171/     4DD :                     
    1172/     4DD : 20 00               	FIM P0, REG16_INDEX
    1173/     4DF :                     
    1174/     4DF : 45 0F               	JUN GETFACTOR_EXIT
    1175/     4E1 :                     GETFACTOR_L9:
    1176/     4E1 :                     	;; input one line from serial and evaluate it
    1177/     4E1 : 2E 3F               	FIM P7, '?'
    1178/     4E3 : 5D D0               	JMS CMP_P1P7
    1179/     4E5 : 14 E9               	JCN Z, GETFACTOR_L91
    1180/     4E7 : 45 03               	JUN GETFACTOR_L10
    1181/     4E9 :                     GETFACTOR_L91:
    1182/     4E9 : 20 00               	FIM P0, REG16_INDEX
    1183/     4EB : 22 00               	FIM P1, REG16_INDEX
    1184/     4ED : 59 DA               	JMS PUSH_REG16P1	; push REG(INDEX)
    1185/     4EF : 24 00               	FIM P2, up(PM12_LINEBUF)
    1186/     4F1 : 26 00               	FIM P3, lo(PM12_LINEBUF)
    1187/     4F3 : 55 FA               	JMS LD_REG16P0_P2P3	; REG(INDEX) = PM12_LNEBUF
    1188/     4F5 : 5A 1E               	JMS GETLINE_PM12REG16P0	; get line input
    1189/     4F7 :                     
    1190/     4F7 : 22 88               	FIM P1, REG16_FACTOR
    1191/     4F9 : 24 E9               	FIM P2, lo(RETURN_GETFACTOR_L9_R1)
    1192/     4FB : 43 93               	JUN EVAL_EXPRESSION_PMINDEX_REG16P1 ; eval it
    1193/     4FD :                     GETFACTOR_L9_R1:
    1194/     4FD : 22 00               	FIM P1, REG16_INDEX
    1195/     4FF : 59 FD               	JMS POP_REG16P1		; pop REG(INDEX)
    1196/     501 :                     
    1197/     501 : 45 0F               	JUN GETFACTOR_EXIT
    1198/     503 :                     GETFACTOR_L10:
    1199/     503 :                     
    1200/     503 :                     
    1201/     503 :                     GETFACTOR_ERROR:
    1202/     503 : 20 7A               	FIM P0, REG8_ERROR2
    1203/     505 : 56 60               	JMS LD_REG8P0_P1
    1204/     507 :                     
    1205/     507 : 22 F0               	FIM P1, ERROR_FACTOR_NOTAFACTOR
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 25 - 2023/03/11 11:35:13


    1206/     509 : 20 78               	FIM P0, REG8_ERROR
    1207/     50B : 56 60               	JMS LD_REG8P0_P1
    1208/     50D : 41 16               	JUN VTL_START		; error and jump to VTL_START
    1209/     50F :                     GETFACTOR_EXIT:
    1210/     50F : 55 CB               	JMS INC_REG16P0		; increment REG(INDEX)
    1211/     511 :                     GETFACTOR_EXIT_NOINCREMENT:
    1212/     511 : 59 A6               	JMS POP_P1
    1213/     513 : 20 88               	FIM P0, REG16_FACTOR
    1214/     515 : 55 63               	JMS LD_REG16P1_REG16P0	; load result to REG(P1)
    1215/     517 : 20 00               	FIM P0, REG16_INDEX	; set P0 to INDEX
    1216/     519 :                     
    1217/     519 : 59 C0               	JMS POP_P2
    1218/     51B : 4B D0               	JUN RETURN_P2
    1219/     51D :                     	
    1220/     51D :                     ;;;----------------------------------------------------------------------------
    1221/     51D :                     ;;; SKIPSPACE_PM12REG16P0
    1222/     51D :                     ;;; Skip ' ' in the string buffer PM(REG16(P0))
    1223/     51D :                     ;;; increment REG16(P0) to not a ' ' char.
    1224/     51D :                     ;;; destroy: P7
    1225/     51D :                     ;;;----------------------------------------------------------------------------
    1226/     51D :                     SKIPSPACE_PM12REG16P0:
    1227/     51D : 59 5C               	JMS PUSH_P1
    1228/     51F :                     SKIPSPACE_LOOP:	
    1229/     51F : 59 07               	JMS LD_P1_PM12REG16P0
    1230/     521 :                     	;; 	JMS ISZEROORNOT_P1
    1231/     521 :                     	;;	JCN Z, SKIPSPACE_EXIT	; EOL
    1232/     521 : 2E 20               	FIM P7, ' '
    1233/     523 : 5D D0               	JMS CMP_P1P7
    1234/     525 : 1C 2B               	JCN ZN, SKIPSPACE_EXIT
    1235/     527 : 55 CB               	JMS INC_REG16P0
    1236/     529 : 45 1F               	JUN SKIPSPACE_LOOP
    1237/     52B :                     SKIPSPACE_EXIT:
    1238/     52B : 59 A6               	JMS POP_P1
    1239/     52D : C0                  	BBL 0
    1240/     52E :                     
    1241/     52E :                     ;;;----------------------------------------------------------------------------
    1242/     52E :                     ;;; CTOREG16NUM_P1
    1243/     52E :                     ;;; return address of REG16_x, (x=A to Z)
    1244/     52E :                     ;;; assuming that REG16_A=04H, ..., REG16_Z=68H
    1245/     52E :                     ;;; P1 must be an alphabet caracter and no error check
    1246/     52E :                     ;;; 
    1247/     52E :                     ;;; (Aa) 41H, 61H: 01x0 0001 -> 0000 0100 (04H)
    1248/     52E :                     ;;; (Bb) 42H, 62H: 01x0 0010 -> 0000 1000 (08H)
    1249/     52E :                     ;;; ...
    1250/     52E :                     ;;; (Zz) 5AH, 7AH: 01x1 1010 -> 0110 1000 (68H)
    1251/     52E :                     ;;;           bit: 7654 3210 -> .432 10.. (.=0)
    1252/     52E :                     ;;;----------------------------------------------------------------------------
    1253/     52E :                     CTOREG16NUM_P1:
    1254/     52E : F0                  	CLB
    1255/     52F : A2                  	LD R2
    1256/     530 : F6                  	RAR
    1257/     531 : F7                  	TCC			; ACC=R2.bit0 (=P1.bit4)
    1258/     532 : F5                  	RAL
    1259/     533 : F5                  	RAL
    1260/     534 : B2                  	XCH R2			; R2 = .4..
    1261/     535 : A3                  	LD R3
    1262/     536 : F6                  	RAR
    1263/     537 : F1                  	CLC
    1264/     538 : F6                  	RAR
    1265/     539 : F1                  	CLC
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 26 - 2023/03/11 11:35:13


    1266/     53A : 82                  	ADD R2
    1267/     53B : B2                  	XCH R2			; R2 = .432
    1268/     53C : F0                  	CLB
    1269/     53D : A3                  	LD R3
    1270/     53E : F5                  	RAL
    1271/     53F : F1                  	CLC
    1272/     540 : F5                  	RAL
    1273/     541 : B3                  	XCH R3			; R3 = 10..
    1274/     542 : C0                  	BBL 0
    1275/     543 :                     	
    1276/     543 :                     
    1277/     543 :                     ;;;----------------------------------------------------------------------------
    1278/     543 :                     ;;; Subroutines for REG16 (16bit registars)
    1279/     543 :                     ;;;----------------------------------------------------------------------------
    1280/     543 :                     ;;;----------------------------------------------------------------------------
    1281/     543 :                     ;;; CLEAR_REG16P0
    1282/     543 :                     ;;; REG16(P0) = 0
    1283/     543 :                     ;;; destroy: P7
    1284/     543 :                     ;;;----------------------------------------------------------------------------
    1285/     543 :                     CLEAR_REG16P0:
    1286/     543 : A1                  	LD R1
    1287/     544 : BF                  	XCH R15			; save R1
    1288/     545 : DC                  	LDM loop(4)
    1289/     546 : BE                  	XCH R14
    1290/     547 : F0                  	CLB
    1291/     548 :                     CLEARREG16_LOOP:
    1292/     548 : 21                  	SRC P0
    1293/     549 : E0                  	WRM
    1294/     54A : 61                  	INC R1
    1295/     54B : 7E 48               	ISZ R14, CLEARREG16_LOOP	
    1296/     54D : AF                  	LD R15
    1297/     54E : B1                  	XCH R1			; restore R1
    1298/     54F : C0                  	BBL 0
    1299/     550 :                     
    1300/     550 :                     ;;;----------------------------------------------------------------------------
    1301/     550 :                     ;;; LD_REG16P0_REG16P1
    1302/     550 :                     ;;; REG16(P0) = REG16(P1)
    1303/     550 :                     ;;; destroy: P7
    1304/     550 :                     ;;;----------------------------------------------------------------------------
    1305/     550 :                     LD_REG16P0_REG16P1:
    1306/     550 : A1                  	LD R1
    1307/     551 : BF                  	XCH R15			; save R1 to R15
    1308/     552 : A3                  	LD R3
    1309/     553 : BD                  	XCH R13			; save R3 to R13
    1310/     554 :                     
    1311/     554 : DC                  	LDM loop(4)
    1312/     555 : BE                  	XCH R14
    1313/     556 :                     LDREG16P0P1_LOOP:
    1314/     556 : 23                  	SRC P1
    1315/     557 : E9                  	RDM
    1316/     558 : 21                  	SRC P0
    1317/     559 : E0                  	WRM
    1318/     55A : 61                  	INC R1
    1319/     55B : 63                  	INC R3
    1320/     55C : 7E 56               	ISZ R14, LDREG16P0P1_LOOP
    1321/     55E :                     
    1322/     55E : AF                  	LD R15
    1323/     55F : B1                  	XCH R1			; restore R1
    1324/     560 : AD                  	LD R13
    1325/     561 : B3                  	XCH R3			; restore R3
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 27 - 2023/03/11 11:35:13


    1326/     562 : C0                  	BBL 0
    1327/     563 :                     
    1328/     563 :                     ;;;----------------------------------------------------------------------------
    1329/     563 :                     ;;; LD_REG16P1_REG16P0
    1330/     563 :                     ;;; REG16(P1) = REG16(P0)
    1331/     563 :                     ;;; destroy: P7
    1332/     563 :                     ;;;----------------------------------------------------------------------------
    1333/     563 :                     LD_REG16P1_REG16P0:
    1334/     563 : A1                  	LD R1
    1335/     564 : BF                  	XCH R15			; save R1 to R15
    1336/     565 : A3                  	LD R3
    1337/     566 : BD                  	XCH R13			; save R3 to R13
    1338/     567 :                     
    1339/     567 : DC                  	LDM loop(4)
    1340/     568 : BE                  	XCH R14
    1341/     569 :                     LDREG16P1P0_LOOP:
    1342/     569 : 21                  	SRC P0
    1343/     56A : E9                  	RDM
    1344/     56B : 23                  	SRC P1
    1345/     56C : E0                  	WRM
    1346/     56D : 61                  	INC R1
    1347/     56E : 63                  	INC R3
    1348/     56F : 7E 69               	ISZ R14, LDREG16P1P0_LOOP
    1349/     571 :                     
    1350/     571 : AF                  	LD R15
    1351/     572 : B1                  	XCH R1			; restore R1
    1352/     573 : AD                  	LD R13
    1353/     574 : B3                  	XCH R3			; restore R3
    1354/     575 : C0                  	BBL 0
    1355/     576 :                     
    1356/     576 :                     ;;;----------------------------------------------------------------------------
    1357/     576 :                     ;;; LD_REG16P1_REG16P2
    1358/     576 :                     ;;; REG16(P1) = REG16(P2)
    1359/     576 :                     ;;; destroy: P7
    1360/     576 :                     ;;;----------------------------------------------------------------------------
    1361/     576 :                     LD_REG16P1_REG16P2:
    1362/     576 : A5                  	LD R5
    1363/     577 : BF                  	XCH R15			; save R5 to R15
    1364/     578 : A3                  	LD R3
    1365/     579 : BD                  	XCH R13			; save R3 to R13
    1366/     57A :                     
    1367/     57A : DC                  	LDM loop(4)
    1368/     57B : BE                  	XCH R14
    1369/     57C :                     LDREG16P1P2_LOOP:
    1370/     57C : 25                  	SRC P2
    1371/     57D : E9                  	RDM
    1372/     57E : 23                  	SRC P1
    1373/     57F : E0                  	WRM
    1374/     580 : 65                  	INC R5
    1375/     581 : 63                  	INC R3
    1376/     582 : 7E 7C               	ISZ R14, LDREG16P1P2_LOOP
    1377/     584 :                     
    1378/     584 : AF                  	LD R15
    1379/     585 : B5                  	XCH R5			; restore R5
    1380/     586 : AD                  	LD R13
    1381/     587 : B3                  	XCH R3			; restore R3
    1382/     588 : C0                  	BBL 0
    1383/     589 :                     
    1384/     589 :                     ;;;----------------------------------------------------------------------------
    1385/     589 :                     ;;; LD_REG16P2_REG16P0
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 28 - 2023/03/11 11:35:13


    1386/     589 :                     ;;; REG16(P2) = REG16(P0)
    1387/     589 :                     ;;; destroy: P7
    1388/     589 :                     ;;;----------------------------------------------------------------------------
    1389/     589 :                     LD_REG16P2_REG16P0:
    1390/     589 : A1                  	LD R1
    1391/     58A : BF                  	XCH R15			; save R1 to R15
    1392/     58B : A5                  	LD R5
    1393/     58C : BD                  	XCH R13			; save R5 to R13
    1394/     58D :                     
    1395/     58D : DC                  	LDM loop(4)
    1396/     58E : BE                  	XCH R14
    1397/     58F :                     LDREG16P2P0_LOOP:
    1398/     58F : 21                  	SRC P0
    1399/     590 : E9                  	RDM
    1400/     591 : 25                  	SRC P2
    1401/     592 : E0                  	WRM
    1402/     593 : 61                  	INC R1
    1403/     594 : 65                  	INC R5
    1404/     595 : 7E 8F               	ISZ R14, LDREG16P2P0_LOOP
    1405/     597 :                     
    1406/     597 : AF                  	LD R15
    1407/     598 : B1                  	XCH R1			; restore R1
    1408/     599 : AD                  	LD R13
    1409/     59A : B5                  	XCH R5			; restore R3
    1410/     59B : C0                  	BBL 0
    1411/     59C :                     	
    1412/     59C :                     ;;;----------------------------------------------------------------------------
    1413/     59C :                     ;;; LD_REG16P2_REG16P1
    1414/     59C :                     ;;; REG16(P2) = REG16(P1)
    1415/     59C :                     ;;; destroy: P7
    1416/     59C :                     ;;;----------------------------------------------------------------------------
    1417/     59C :                     LD_REG16P2_REG16P1:
    1418/     59C : A3                  	LD R3
    1419/     59D : BF                  	XCH R15			; save R3 to R15
    1420/     59E : A5                  	LD R5
    1421/     59F : BD                  	XCH R13			; save R5 to R13
    1422/     5A0 :                     
    1423/     5A0 : DC                  	LDM loop(4)
    1424/     5A1 : BE                  	XCH R14
    1425/     5A2 :                     LDREG16P2P1_LOOP:
    1426/     5A2 : 23                  	SRC P1
    1427/     5A3 : E9                  	RDM
    1428/     5A4 : 25                  	SRC P2
    1429/     5A5 : E0                  	WRM
    1430/     5A6 : 63                  	INC R3
    1431/     5A7 : 65                  	INC R5
    1432/     5A8 : 7E A2               	ISZ R14, LDREG16P2P1_LOOP
    1433/     5AA :                     
    1434/     5AA : AF                  	LD R15
    1435/     5AB : B3                  	XCH R3			; restore R1
    1436/     5AC : AD                  	LD R13
    1437/     5AD : B5                  	XCH R5			; restore R3
    1438/     5AE : C0                  	BBL 0
    1439/     5AF :                     	
    1440/     5AF :                     
    1441/     5AF :                     ;;;----------------------------------------------------------------------------
    1442/     5AF :                     ;;; GETSIGN_REG16P0_TOCARRY
    1443/     5AF :                     ;;; Get a sign of REG(P0) and set it to Carry
    1444/     5AF :                     ;;; CY = SIGN(REG16(P0)), ACC=0
    1445/     5AF :                     ;;;----------------------------------------------------------------------------
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 29 - 2023/03/11 11:35:13


    1446/     5AF :                     GETSIGN_REG16P0_TOCARRY:
    1447/     5AF : A1                  	LD R1
    1448/     5B0 : BF                  	XCH R15			; save R1 to R15
    1449/     5B1 : 61                  	INC R1
    1450/     5B2 : 61                  	INC R1
    1451/     5B3 : 61                  	INC R1
    1452/     5B4 : 21                  	SRC P0
    1453/     5B5 : E9                  	RDM			; bitFEDC
    1454/     5B6 : F5                  	RAL			; rotate left (CY<-MSB)
    1455/     5B7 : AF                  	LD R15
    1456/     5B8 : B1                  	XCH R1			; restore R1
    1457/     5B9 : C0                  	BBL 0
    1458/     5BA :                     
    1459/     5BA :                     ;;;----------------------------------------------------------------------------
    1460/     5BA :                     ;;; ISZEROORNOT_REG16P1
    1461/     5BA :                     ;;; return:
    1462/     5BA :                     ;;; 	ACC = 0, CY = 0 if REG16(P1) == 0
    1463/     5BA :                     ;;; 	ACC = 1, CY = 0 if 1<=REG16(P1)<=0x7fff
    1464/     5BA :                     ;;; 	ACC = 1, CY = 1 if 0x80<=REG16(P1)<=0xffff
    1465/     5BA :                     ;;; destroy: R15, R14
    1466/     5BA :                     ;;;----------------------------------------------------------------------------
    1467/     5BA :                     ISZEROORNOT_REG16P1:
    1468/     5BA : A3                  	LD R3
    1469/     5BB : BF                  	XCH R15			; save R3 to R15
    1470/     5BC :                     
    1471/     5BC : DC                  	LDM loop(4)
    1472/     5BD : BE                  	XCH R14
    1473/     5BE :                     ISZEROORNOT_LOOP:
    1474/     5BE : 23                  	SRC P1
    1475/     5BF : E9                  	RDM			; bit4321
    1476/     5C0 : 1C C8               	JCN ZN, ISZEROREGP0_EXIT1
    1477/     5C2 : 63                  	INC R3
    1478/     5C3 : 7E BE               	ISZ R14, ISZEROORNOT_LOOP
    1479/     5C5 :                     
    1480/     5C5 : AF                  	LD R15
    1481/     5C6 : B3                  	XCH R3			; restore R3
    1482/     5C7 : C0                  	BBL 0
    1483/     5C8 :                     
    1484/     5C8 :                     ISZEROREGP0_EXIT1:
    1485/     5C8 : AF                  	LD R15
    1486/     5C9 : B3                  	XCH R3			; restore R3
    1487/     5CA : C1                  	BBL 1
    1488/     5CB :                     
    1489/     5CB :                     
    1490/     5CB :                     ;;;----------------------------------------------------------------------------
    1491/     5CB :                     ;;; INC_REG16P0
    1492/     5CB :                     ;;; REG16(P0) = REG16(P0)+1
    1493/     5CB :                     ;;; destroy: P7(R14, R15)
    1494/     5CB :                     ;;;----------------------------------------------------------------------------
    1495/     5CB :                     INC_REG16P0:
    1496/     5CB : A1                  	LD R1
    1497/     5CC : BF                  	XCH R15			; save R1 to R15
    1498/     5CD :                     
    1499/     5CD : DC                  	LDM loop(4)
    1500/     5CE : BE                  	XCH R14			; R14 = 12, 13, 14, 15
    1501/     5CF :                     REG16_INC_LOOP:
    1502/     5CF : 21                  	SRC P0
    1503/     5D0 : E9                  	RDM
    1504/     5D1 : F2                  	IAC 
    1505/     5D2 : E0                  	WRM
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 30 - 2023/03/11 11:35:13


    1506/     5D3 : 1C D8               	JCN NZ, REG16_INC_EXIT
    1507/     5D5 : 61                  	INC R1
    1508/     5D6 : 7E CF               	ISZ R14, REG16_INC_LOOP
    1509/     5D8 :                     
    1510/     5D8 :                     REG16_INC_EXIT:
    1511/     5D8 : AF                  	LD R15
    1512/     5D9 : B1                  	XCH R1			; restore R1
    1513/     5DA : C0                  	BBL 0
    1514/     5DB :                     
    1515/     5DB :                     ;;;----------------------------------------------------------------------------
    1516/     5DB :                     ;;; DEC_REG16P0
    1517/     5DB :                     ;;; REG16(P0) = REG16(P0) - 1
    1518/     5DB :                     ;;; destroy: P7(R14, R15)
    1519/     5DB :                     ;;;----------------------------------------------------------------------------
    1520/     5DB :                     DEC_REG16P0:
    1521/     5DB : A1                  	LD R1
    1522/     5DC : BF                  	XCH R15			; save R1 to R15
    1523/     5DD :                     
    1524/     5DD : DC                  	LDM loop(4)
    1525/     5DE : BE                  	XCH R14			; R14 = 12, 13, 14, 15
    1526/     5DF : F1                  	CLC
    1527/     5E0 :                     REG16_DEC_LOOP:
    1528/     5E0 : 21                  	SRC P0
    1529/     5E1 : E9                  	RDM
    1530/     5E2 : F8                  	DAC
    1531/     5E3 : E0                  	WRM
    1532/     5E4 : 12 E9               	JCN C, REG16_DEC_EXIT	; CY=1 if no borrow
    1533/     5E6 : 61                  	INC R1
    1534/     5E7 : 7E E0               	ISZ R14, REG16_DEC_LOOP
    1535/     5E9 :                     REG16_DEC_EXIT:
    1536/     5E9 : AF                  	LD R15
    1537/     5EA : B1                  	XCH R1			; restore R1
    1538/     5EB : C0                  	BBL 0
    1539/     5EC :                     
    1540/     5EC :                     ;;;----------------------------------------------------------------------------
    1541/     5EC :                     ;;; COMPLEMENT_REG16P0
    1542/     5EC :                     ;;; REG16(P0) = not REG16(P0)
    1543/     5EC :                     ;;; destroy: P7(R14, R15)
    1544/     5EC :                     ;;;----------------------------------------------------------------------------
    1545/     5EC :                     COMPLEMENT_REG16P0:
    1546/     5EC : A1                  	LD R1
    1547/     5ED : BF                  	XCH R15			; save R1 to R15
    1548/     5EE :                     
    1549/     5EE : DC                  	LDM loop(4)
    1550/     5EF : BE                  	XCH R14			; R14 = 12, 13, 14, 15
    1551/     5F0 :                     REG16_COMPLEMENT_LOOP:
    1552/     5F0 : 21                  	SRC P0
    1553/     5F1 : E9                  	RDM
    1554/     5F2 : F4                  	CMA
    1555/     5F3 : E0                  	WRM
    1556/     5F4 : 61                  	INC R1
    1557/     5F5 : 7E F0               	ISZ R14, REG16_COMPLEMENT_LOOP
    1558/     5F7 :                     
    1559/     5F7 :                     REG16_COMPLEMENT_EXIT:
    1560/     5F7 : AF                  	LD R15
    1561/     5F8 : B1                  	XCH R1			; restore R1
    1562/     5F9 : C0                  	BBL 0
    1563/     5FA :                     
    1564/     5FA :                     ;;;----------------------------------------------------------------------------
    1565/     5FA :                     ;;; LD_REG16P0_P2P3
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 31 - 2023/03/11 11:35:13


    1566/     5FA :                     ;;; REG16(P0) = P2P3(R4R5R6R7)
    1567/     5FA :                     ;;; destroy: P7
    1568/     5FA :                     ;;;----------------------------------------------------------------------------
    1569/     5FA :                     LD_REG16P0_P2P3:
    1570/     5FA : 21                  	SRC P0
    1571/     5FB : A7                  	LD R7
    1572/     5FC : E0                  	WRM
    1573/     5FD :                     
    1574/     5FD : 61                  	INC R1
    1575/     5FE : 21                  	SRC P0
    1576/     5FF : A6                  	LD R6
    1577/     600 : E0                  	WRM
    1578/     601 :                     
    1579/     601 : 61                  	INC R1
    1580/     602 : 21                  	SRC P0
    1581/     603 : A5                  	LD R5
    1582/     604 : E0                  	WRM
    1583/     605 :                     
    1584/     605 : 61                  	INC R1
    1585/     606 : 21                  	SRC P0
    1586/     607 : A4                  	LD R4
    1587/     608 : E0                  	WRM
    1588/     609 :                     
    1589/     609 : A1                  	LD R1
    1590/     60A : F8                  	DAC
    1591/     60B : F8                  	DAC
    1592/     60C : F8                  	DAC
    1593/     60D : B1                  	XCH R1			; restore R1
    1594/     60E : C0                  	BBL 0
    1595/     60F :                     
    1596/     60F :                     ;;;----------------------------------------------------------------------------
    1597/     60F :                     ;;; LD_REG16P1_P2P3
    1598/     60F :                     ;;; REG16(P1) = P2P3(R4R5R6R7)
    1599/     60F :                     ;;; destroy: P7
    1600/     60F :                     ;;;----------------------------------------------------------------------------
    1601/     60F :                     LD_REG16P1_P2P3:
    1602/     60F : 23                  	SRC P1
    1603/     610 : A7                  	LD R7
    1604/     611 : E0                  	WRM
    1605/     612 :                     
    1606/     612 : 63                  	INC R3
    1607/     613 : 23                  	SRC P1
    1608/     614 : A6                  	LD R6
    1609/     615 : E0                  	WRM
    1610/     616 :                     
    1611/     616 : 63                  	INC R3
    1612/     617 : 23                  	SRC P1
    1613/     618 : A5                  	LD R5
    1614/     619 : E0                  	WRM
    1615/     61A :                     
    1616/     61A : 63                  	INC R3
    1617/     61B : 23                  	SRC P1
    1618/     61C : A4                  	LD R4
    1619/     61D : E0                  	WRM
    1620/     61E :                     
    1621/     61E : A3                  	LD R3
    1622/     61F : F8                  	DAC
    1623/     620 : F8                  	DAC
    1624/     621 : F8                  	DAC
    1625/     622 : B3                  	XCH R3			; restore R3
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 32 - 2023/03/11 11:35:13


    1626/     623 : C0                  	BBL 0
    1627/     624 :                     
    1628/     624 :                     ;;;----------------------------------------------------------------------------
    1629/     624 :                     ;;; LD_P2P3_REG16P1
    1630/     624 :                     ;;; P2(R4R5) = REG16(P1).bitFEDCBA98
    1631/     624 :                     ;;; P3(R6R7) = REG16(P1).bit76543210
    1632/     624 :                     ;;;----------------------------------------------------------------------------
    1633/     624 :                     LD_P2P3_REG16P1:
    1634/     624 : 23                  	SRC P1
    1635/     625 : E9                  	RDM
    1636/     626 : B7                  	XCH R7			; R7 = REG16(P1).bit3210
    1637/     627 :                     
    1638/     627 : 63                  	INC R3
    1639/     628 : 23                  	SRC P1
    1640/     629 : E9                  	RDM
    1641/     62A : B6                  	XCH R6			; R6 = REG16(P1).bit7654
    1642/     62B :                     	
    1643/     62B : 63                  	INC R3
    1644/     62C : 23                  	SRC P1
    1645/     62D : E9                  	RDM
    1646/     62E : B5                  	XCH R5			; R5 = REG16(P1).bitBA98
    1647/     62F :                     
    1648/     62F : 63                  	INC R3
    1649/     630 : 23                  	SRC P1
    1650/     631 : E9                  	RDM
    1651/     632 : B4                  	XCH R4			; R4 = REG16(P1).bitFEDC
    1652/     633 :                     
    1653/     633 : A3                  	LD R3
    1654/     634 : F8                  	DAC
    1655/     635 : F8                  	DAC
    1656/     636 : F8                  	DAC
    1657/     637 : B3                  	XCH R3			; restore R3
    1658/     638 :                     
    1659/     638 : C0                  	BBL 0
    1660/     639 :                     
    1661/     639 :                     ;;;----------------------------------------------------------------------------
    1662/     639 :                     ;;; LD_REG16P0_8BIT_P1
    1663/     639 :                     ;;; REG16(P0) = P1
    1664/     639 :                     ;;; load lower 8bit, upper 8bit becomes 0
    1665/     639 :                     ;;;----------------------------------------------------------------------------
    1666/     639 :                     LD_REG16P0_8BIT_P1:
    1667/     639 : 21                  	SRC P0
    1668/     63A : A3                  	LD R3
    1669/     63B : E0                  	WRM
    1670/     63C :                     
    1671/     63C : 61                  	INC R1
    1672/     63D : 21                  	SRC P0
    1673/     63E : A2                  	LD R2
    1674/     63F : E0                  	WRM
    1675/     640 :                     
    1676/     640 : F0                  	CLB
    1677/     641 : 61                  	INC R1
    1678/     642 : 21                  	SRC P0
    1679/     643 : E0                  	WRM
    1680/     644 :                     
    1681/     644 : 61                  	INC R1
    1682/     645 : 21                  	SRC P0
    1683/     646 : E0                  	WRM
    1684/     647 :                     
    1685/     647 : A1                  	LD R1
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 33 - 2023/03/11 11:35:13


    1686/     648 : F8                  	DAC
    1687/     649 : F8                  	DAC
    1688/     64A : F8                  	DAC
    1689/     64B : B1                  	XCH R1			; restore R1
    1690/     64C : C0                  	BBL 0
    1691/     64D :                     
    1692/     64D :                     ;;;----------------------------------------------------------------------------
    1693/     64D :                     ;;; CLEAR_SIGNFLAG
    1694/     64D :                     ;;; TOGGLE_SIGNFLAG
    1695/     64D :                     ;;; GET_SIGNFLAG_TOCARRY
    1696/     64D :                     ;;;----------------------------------------------------------------------------
    1697/     64D :                     CLEAR_SIGNFLAG:
    1698/     64D : 2E 7D               	FIM P7, REG4_SIGN
    1699/     64F : 2F                  	SRC P7
    1700/     650 : F0                  	CLB
    1701/     651 : E0                  	WRM
    1702/     652 : C0                  	BBL 0
    1703/     653 :                     
    1704/     653 :                     TOGGLE_SIGNFLAG:
    1705/     653 : 2E 7D               	FIM P7, REG4_SIGN
    1706/     655 : 2F                  	SRC P7
    1707/     656 : E9                  	RDM
    1708/     657 : F4                  	CMA
    1709/     658 : E0                  	WRM
    1710/     659 : C0                  	BBL 0
    1711/     65A :                     
    1712/     65A :                     GET_SIGNFLAG_TOCARRY:	
    1713/     65A : 2E 7D               	FIM P7, REG4_SIGN
    1714/     65C : 2F                  	SRC P7
    1715/     65D : E9                  	RDM
    1716/     65E : F6                  	RAR
    1717/     65F : C0                  	BBL 0
    1718/     660 :                     
    1719/     660 :                     ;;;----------------------------------------------------------------------------
    1720/     660 :                     ;;; LD_REG8P0_P1
    1721/     660 :                     ;;; REG8(P0) = P1
    1722/     660 :                     ;;;----------------------------------------------------------------------------
    1723/     660 :                     LD_REG8P0_P1:
    1724/     660 : 21                  	SRC P0
    1725/     661 : A3                  	LD R3
    1726/     662 : E0                  	WRM
    1727/     663 :                     
    1728/     663 : 61                  	INC R1
    1729/     664 : 21                  	SRC P0
    1730/     665 : A2                  	LD R2
    1731/     666 : E0                  	WRM
    1732/     667 :                     
    1733/     667 : A1                  	LD R1
    1734/     668 : F8                  	DAC
    1735/     669 : B1                  	XCH R1			; restore R1
    1736/     66A : C0                  	BBL 0
    1737/     66B :                     
    1738/     66B :                     ;;;----------------------------------------------------------------------------
    1739/     66B :                     ;;; LD_P1_REG16P0_8BIT (= LD_P1_REG8P0)
    1740/     66B :                     ;;; P1 = REG16(P0).bit76543210
    1741/     66B :                     ;;; or 	P1 = REG8(P0)
    1742/     66B :                     ;;;----------------------------------------------------------------------------
    1743/     66B :                     LD_P1_REG8P0
    1744/     66B :                     LD_P1_REG16P0_8BIT:
    1745/     66B : 21                  	SRC P0
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 34 - 2023/03/11 11:35:13


    1746/     66C : E9                  	RDM
    1747/     66D : B3                  	XCH R3			; R5 = REG16(R14R15).bit3210
    1748/     66E :                     
    1749/     66E : 61                  	INC R1			; R1++
    1750/     66F : 21                  	SRC P0
    1751/     670 : E9                  	RDM			; R4 = REG16(R14R15).bit7654
    1752/     671 : B2                  	XCH R2
    1753/     672 :                     
    1754/     672 : A1                  	LD R1
    1755/     673 : F8                  	DAC
    1756/     674 : B1                  	XCH R1			; restore R1
    1757/     675 : C0                  	BBL 0
    1758/     676 :                     
    1759/     676 :                     ;;;----------------------------------------------------------------------------
    1760/     676 :                     ;;; LD_P2P3_REG16P0
    1761/     676 :                     ;;; P2(R4R5) = REG16(P0).bitFEDCBA98
    1762/     676 :                     ;;; P3(R6R7) = REG16(P0).bit76543210
    1763/     676 :                     ;;;----------------------------------------------------------------------------
    1764/     676 :                     LD_P2P3_REG16P0:
    1765/     676 : 21                  	SRC P0
    1766/     677 : E9                  	RDM
    1767/     678 : B7                  	XCH R7			; R7 = REG16(P0).bit3210
    1768/     679 :                     
    1769/     679 : 61                  	INC R1
    1770/     67A : 21                  	SRC P0
    1771/     67B : E9                  	RDM
    1772/     67C : B6                  	XCH R6			; R6 = REG16(P0).bit7654
    1773/     67D :                     	
    1774/     67D : 61                  	INC R1
    1775/     67E : 21                  	SRC P0
    1776/     67F : E9                  	RDM
    1777/     680 : B5                  	XCH R5			; R5 = REG16(P0).bitBA98
    1778/     681 :                     
    1779/     681 : 61                  	INC R1
    1780/     682 : 21                  	SRC P0
    1781/     683 : E9                  	RDM
    1782/     684 : B4                  	XCH R4			; R4 = REG16(P0).bitFEDC
    1783/     685 :                     
    1784/     685 : A1                  	LD R1
    1785/     686 : F8                  	DAC
    1786/     687 : F8                  	DAC
    1787/     688 : F8                  	DAC
    1788/     689 : B1                  	XCH R1			; restore R1
    1789/     68A :                     
    1790/     68A : C0                  	BBL 0
    1791/     68B :                     
    1792/     68B :                     ;;;----------------------------------------------------------------------------
    1793/     68B :                     ;;; MUL2_REG16P0
    1794/     68B :                     ;;; REG16(P0) = REG16(P0)*2
    1795/     68B :                     ;;; CY=1 if overflow
    1796/     68B :                     ;;; destroy: P7(R14, R15)
    1797/     68B :                     ;;;----------------------------------------------------------------------------
    1798/     68B :                     MUL2_REG16P0:
    1799/     68B : A1                  	LD R1
    1800/     68C : BF                  	XCH R15			; save R1 to R15
    1801/     68D :                     
    1802/     68D : DC                  	LDM loop(4)
    1803/     68E : BE                  	XCH R14
    1804/     68F : F1                  	CLC
    1805/     690 :                     MUL2REG16P0_LOOP:
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 35 - 2023/03/11 11:35:13


    1806/     690 : 21                  	SRC P0
    1807/     691 : E9                  	RDM
    1808/     692 : F5                  	RAL
    1809/     693 : E0                  	WRM
    1810/     694 : 61                  	INC R1
    1811/     695 : 7E 90               	ISZ R14, MUL2REG16P0_LOOP
    1812/     697 :                     
    1813/     697 : AF                  	LD R15
    1814/     698 : B1                  	XCH R1			; restore R1
    1815/     699 : C0                  	BBL 0
    1816/     69A :                     
    1817/     69A :                     ;;;----------------------------------------------------------------------------
    1818/     69A :                     ;;; MUL2_REG16P1
    1819/     69A :                     ;;; REG16(P1) = REG16(P1)*2
    1820/     69A :                     ;;; CY=1 if overflow
    1821/     69A :                     ;;; destroy: P7(R14, R15)
    1822/     69A :                     ;;;----------------------------------------------------------------------------
    1823/     69A :                     MUL2_REG16P1:
    1824/     69A : A3                  	LD R3
    1825/     69B : BF                  	XCH R15			; save R3 to R15
    1826/     69C :                     
    1827/     69C : DC                  	LDM loop(4)
    1828/     69D : BE                  	XCH R14
    1829/     69E : F1                  	CLC
    1830/     69F :                     MUL2REG16P1_LOOP:
    1831/     69F : 23                  	SRC P1
    1832/     6A0 : E9                  	RDM
    1833/     6A1 : F5                  	RAL
    1834/     6A2 : E0                  	WRM
    1835/     6A3 : 63                  	INC R3
    1836/     6A4 : 7E 9F               	ISZ R14, MUL2REG16P1_LOOP
    1837/     6A6 :                     
    1838/     6A6 : AF                  	LD R15
    1839/     6A7 : B3                  	XCH R3			; restore R3
    1840/     6A8 : C0                  	BBL 0
    1841/     6A9 :                     
    1842/     6A9 :                     ;;;----------------------------------------------------------------------------
    1843/     6A9 :                     ;;; DIV2_REG16P2
    1844/     6A9 :                     ;;; REG16(P2) = REG16(P2)/2
    1845/     6A9 :                     ;;; CY=1 if LSB was 1
    1846/     6A9 :                     ;;; destroy: P7(R14, R15)
    1847/     6A9 :                     ;;;----------------------------------------------------------------------------
    1848/     6A9 :                     DIV2_REG16P2:
    1849/     6A9 : 65                  	INC R5
    1850/     6AA : 65                  	INC R5
    1851/     6AB : 65                  	INC R5			; R5=R5+3
    1852/     6AC : DC                  	LDM loop(4)
    1853/     6AD : BE                  	XCH R14
    1854/     6AE : F0                  	CLB
    1855/     6AF : BF                  	XCH R15
    1856/     6B0 :                     DIV2REG16_LOOP:
    1857/     6B0 : AF                  	LD R15
    1858/     6B1 : F6                  	RAR			; restore last CY
    1859/     6B2 : 25                  	SRC P2
    1860/     6B3 : E9                  	RDM
    1861/     6B4 : F6                  	RAR
    1862/     6B5 : E0                  	WRM
    1863/     6B6 : F7                  	TCC			;
    1864/     6B7 : BF                  	XCH R15			; R15=CY
    1865/     6B8 : A5                  	LD R5
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 36 - 2023/03/11 11:35:13


    1866/     6B9 : F8                  	DAC
    1867/     6BA : B5                  	XCH R5			; R5--
    1868/     6BB : 7E B0               	ISZ R14, DIV2REG16_LOOP
    1869/     6BD : 65                  	INC R5			; restore R5
    1870/     6BE : AF                  	LD R15
    1871/     6BF : F6                  	RAR			; set last CY
    1872/     6C0 : C0                  	BBL 0
    1873/     6C1 :                     	
    1874/     6C1 :                     ;;;----------------------------------------------------------------------------
    1875/     6C1 :                     ;;; ADD_REG16P0_REG16P1
    1876/     6C1 :                     ;;; REG16(P0) = REG16(P0) + REG16(P1)
    1877/     6C1 :                     ;;; destroy: P6, P7
    1878/     6C1 :                     ;;;----------------------------------------------------------------------------
    1879/     6C1 :                     ADD_REG16P0_REG16P1:
    1880/     6C1 : A1                  	LD R1
    1881/     6C2 : BF                  	XCH R15			; save R1 to R15
    1882/     6C3 : A3                  	LD R3
    1883/     6C4 : BD                  	XCH R13			; save R3 to R13
    1884/     6C5 :                     
    1885/     6C5 : DC                  	LDM loop(4)
    1886/     6C6 : BE                  	XCH R14
    1887/     6C7 : F1                  	CLC
    1888/     6C8 :                     REG16_ADD_LOOP:
    1889/     6C8 : 23                  	SRC P1
    1890/     6C9 : E9                  	RDM
    1891/     6CA : 21                  	SRC P0
    1892/     6CB : EB                  	ADM
    1893/     6CC : E0                  	WRM
    1894/     6CD : 61                  	INC R1
    1895/     6CE : 63                  	INC R3
    1896/     6CF : 7E C8               	ISZ R14, REG16_ADD_LOOP
    1897/     6D1 :                     
    1898/     6D1 : AF                  	LD R15
    1899/     6D2 : B1                  	XCH R1			; restore R1
    1900/     6D3 : AD                  	LD R13
    1901/     6D4 : B3                  	XCH R3			; restore R3
    1902/     6D5 : C0                  	BBL 0
    1903/     6D6 :                     
    1904/     6D6 :                     ;;;----------------------------------------------------------------------------
    1905/     6D6 :                     ;;; SUB_REG16P0_REG16P1
    1906/     6D6 :                     ;;; REG16(P0) = REG16(P0) - REG16(P1)
    1907/     6D6 :                     ;;; destroy: P6, P7
    1908/     6D6 :                     ;;;----------------------------------------------------------------------------
    1909/     6D6 :                     SUB_REG16P0_REG16P1:
    1910/     6D6 : A1                  	LD R1
    1911/     6D7 : BF                  	XCH R15			; save R1 to R15
    1912/     6D8 : A3                  	LD R3
    1913/     6D9 : BD                  	XCH R13			; save R3 to R13
    1914/     6DA :                     
    1915/     6DA : DC                  	LDM loop(4)
    1916/     6DB : BE                  	XCH R14
    1917/     6DC : FA                  	STC
    1918/     6DD :                     REG16_SUB_LOOP:
    1919/     6DD : F3                  	CMC
    1920/     6DE : 21                  	SRC P0
    1921/     6DF : E9                  	RDM
    1922/     6E0 : 23                  	SRC P1
    1923/     6E1 : E8                  	SBM
    1924/     6E2 : 21                  	SRC P0
    1925/     6E3 : E0                  	WRM
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 37 - 2023/03/11 11:35:13


    1926/     6E4 : 61                  	INC R1
    1927/     6E5 : 63                  	INC R3
    1928/     6E6 : 7E DD               	ISZ R14, REG16_SUB_LOOP
    1929/     6E8 :                     
    1930/     6E8 : AF                  	LD R15
    1931/     6E9 : B1                  	XCH R1			; restore R1
    1932/     6EA : AD                  	LD R13
    1933/     6EB : B3                  	XCH R3			; restore R3
    1934/     6EC : C0                  	BBL 0
    1935/     6ED :                     
    1936/     6ED :                     ;;;----------------------------------------------------------------------------
    1937/     6ED :                     ;;; P2P3 = P2P3/16
    1938/     6ED :                     ;;;----------------------------------------------------------------------------
    1939/     6ED :                     DIV16_P2P3:	
    1940/     6ED : A6                  	LD R6
    1941/     6EE : B7                  	XCH R7			; 10'->1'
    1942/     6EF : A5                  	LD R5
    1943/     6F0 : B6                  	XCH R6			; 100'->10'
    1944/     6F1 : A4                  	LD R4
    1945/     6F2 : B5                  	XCH R5			; 1000'->100'
    1946/     6F3 : F0                  	CLB
    1947/     6F4 : B4                  	XCH R4			;  0 ->1000'
    1948/     6F5 : C0                  	BBL 0
    1949/     6F6 :                     
    1950/     6F6 :                     ;;;----------------------------------------------------------------------------
    1951/     6F6 :                     ;;; P2P3 = P2P3*16
    1952/     6F6 :                     ;;;----------------------------------------------------------------------------
    1953/     6F6 :                     MUL16_P2P3:	
    1954/     6F6 : A5                  	LD R5
    1955/     6F7 : B4                  	XCH R4			; 100'->1000'
    1956/     6F8 : A6                  	LD R6
    1957/     6F9 : B5                  	XCH R5			; 10'->100'
    1958/     6FA : A7                  	LD R7
    1959/     6FB : B6                  	XCH R6			; 1'->10'
    1960/     6FC : F0                  	CLB
    1961/     6FD : B7                  	XCH R7			; 0->1'
    1962/     6FE : C0                  	BBL 0
    1963/     6FF :                     	
    1964/     6FF :                     ;;;----------------------------------------------------------------------------
    1965/     6FF :                     ;;; MUL_REG16P0_REG16P1
    1966/     6FF :                     ;;; REG16(P0) =  REG16(P0) * REG16(P1)
    1967/     6FF :                     ;;; destroy P7, P6, R5
    1968/     6FF :                     ;;;----------------------------------------------------------------------------
    1969/     6FF :                     MUL_REG16P0_REG16P1:
    1970/     6FF : 59 5C               	JMS PUSH_P1
    1971/     701 : 59 74               	JMS PUSH_P2
    1972/     703 :                     
    1973/     703 : 24 A0               	FIM P2, REG16_TMP
    1974/     705 : 55 89               	JMS LD_REG16P2_REG16P0	; REG(TMP)= REG(P0)
    1975/     707 :                     	
    1976/     707 : 24 A4               	FIM P2, REG16_TMP2
    1977/     709 : 55 9C               	JMS LD_REG16P2_REG16P1	; REG(TMP2)= REG(P1)
    1978/     70B :                     
    1979/     70B : 55 43               	JMS CLEAR_REG16P0	; REG(P0) = 0
    1980/     70D : 22 A0               	FIM P1, REG16_TMP
    1981/     70F : 24 A4               	FIM P2, REG16_TMP2
    1982/     711 :                     
    1983/     711 : D0                  	LDM loop(16)
    1984/     712 : BA                  	XCH R10
    1985/     713 :                     MUL_REG16_LOOP:
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 38 - 2023/03/11 11:35:13


    1986/     713 : 56 A9               	JMS DIV2_REG16P2
    1987/     715 : 1A 19               	JCN CN, MUL_REG16_NEXT
    1988/     717 : 56 C1               	JMS ADD_REG16P0_REG16P1
    1989/     719 :                     MUL_REG16_NEXT:	
    1990/     719 : 56 9A               	JMS MUL2_REG16P1
    1991/     71B : 7A 13               	ISZ R10, MUL_REG16_LOOP
    1992/     71D :                     
    1993/     71D : 59 C0               	JMS POP_P2
    1994/     71F : 59 A6               	JMS POP_P1
    1995/     721 : C0                  	BBL 0
    1996/     722 :                     
    1997/     722 :                     ;;;----------------------------------------------------------------------------
    1998/     722 :                     ;;; DIV_REG16P0_REG16P1
    1999/     722 :                     ;;; REG16(P0) =  REG16(P0) / REG16(P1)
    2000/     722 :                     ;;; REG(RMND) = remainder
    2001/     722 :                     ;;; return: ACC=0 OK, ACC=1 divide by zero
    2002/     722 :                     ;;; destroy: P2, P3, P4, P5, P6, P7
    2003/     722 :                     ;;;----------------------------------------------------------------------------
    2004/     722 :                     DIV_REG16P0_REG16P1:
    2005/     722 : 59 DA               	JMS PUSH_REG16P1
    2006/     724 : 59 5C               	JMS PUSH_P1
    2007/     726 : 59 44               	JMS PUSH_P0
    2008/     728 :                     
    2009/     728 : 56 4D               	JMS CLEAR_SIGNFLAG
    2010/     72A :                     	
    2011/     72A : 24 00               	FIM P2, 00H
    2012/     72C : 55 AF               	JMS GETSIGN_REG16P0_TOCARRY
    2013/     72E : 1A 38               	JCN NC, DIV_POSITIVE_DIVIDEND
    2014/     730 : 55 EC               	JMS COMPLEMENT_REG16P0
    2015/     732 : 55 CB               	JMS INC_REG16P0		; REG(P0)=-REG(P0)
    2016/     734 : 56 53               	JMS TOGGLE_SIGNFLAG	; set SIGNFLAG
    2017/     736 : 24 01               	FIM P2, 01H
    2018/     738 :                     DIV_POSITIVE_DIVIDEND:
    2019/     738 : 59 74               	JMS PUSH_P2		; save sign of REG(P0) for sign of the remainder
    2020/     73A : 56 76               	JMS LD_P2P3_REG16P0
    2021/     73C : 20 90               	FIM P0, REG16_RMND
    2022/     73E : 55 FA               	JMS LD_REG16P0_P2P3	; REG(RMND) = abd(REG(P0))
    2023/     740 :                     	
    2024/     740 : (MACRO)              	LD_P0_P1
    2024/     740 : A2                                  LD R2
    2024/     741 : B0                                  XCH R0
    2024/     742 : A3                                  LD R3
    2024/     743 : B1                                  XCH R1
    2025/     744 : 55 AF               	JMS GETSIGN_REG16P0_TOCARRY
    2026/     746 : 1A 4E               	JCN NC, DIV_POSITIVE_DIVISOR
    2027/     748 : 55 EC               	JMS COMPLEMENT_REG16P0
    2028/     74A : 55 CB               	JMS INC_REG16P0		; REG(P1)=-REG(P1)
    2029/     74C : 56 53               	JMS TOGGLE_SIGNFLAG	; toggle SIGN
    2030/     74E :                     DIV_POSITIVE_DIVISOR:
    2031/     74E : 56 24               	JMS LD_P2P3_REG16P1 	; P2P3=abs(REG(P1)) P2P3 = divisor
    2032/     750 :                     
    2033/     750 : 20 90               	FIM P0, REG16_RMND
    2034/     752 :                     	
    2035/     752 :                     	;; registers for the result
    2036/     752 : 28 00               	FIM P4, 00H		; R8R9 = 00H
    2037/     754 : 2A 00               	FIM P5, 00H		; R10R11 = 00H
    2038/     756 :                     	
    2039/     756 : A4                  	LD R4
    2040/     757 : 1C 9C               	JCN NZ, REG16_DIV_L1
    2041/     759 : 56 F6               	JMS MUL16_P2P3		; P2P3 *= 16
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 39 - 2023/03/11 11:35:13


    2042/     75B :                     
    2043/     75B : A4                  	LD R4
    2044/     75C : 1C 8F               	JCN NZ, REG16_DIV_L2
    2045/     75E : 56 F6               	JMS MUL16_P2P3		; P2P3 *= 16
    2046/     760 :                     
    2047/     760 : A4                  	LD R4
    2048/     761 : 1C 82               	JCN NZ, REG16_DIV_L3
    2049/     763 : 56 F6               	JMS MUL16_P2P3		; P2P3 *= 16
    2050/     765 :                     
    2051/     765 : A4                  	LD R4
    2052/     766 : 1C 75               	JCN NZ, REG16_DIV_L4
    2053/     768 :                     
    2054/     768 :                     ;;; 	 Error: divide by zero 
    2055/     768 : 20 90               	FIM P0, REG16_RMND
    2056/     76A : 55 43               	JMS CLEAR_REG16P0	; RMND=0
    2057/     76C :                     
    2058/     76C : 59 8C               	JMS POP_P0
    2059/     76E : 24 7F               	FIM P2, 07FH
    2060/     770 : 26 FF               	FIM P3, 0FFH
    2061/     772 : 55 FA               	JMS LD_REG16P0_P2P3	; result = MAXINT
    2062/     774 : C1                  	BBL 1
    2063/     775 :                     	
    2064/     775 :                     REG16_DIV_L4:
    2065/     775 : 56 0F               	JMS LD_REG16P1_P2P3	; REG(P1)=P2P3
    2066/     777 :                     REG16_DIV_LOOP4:
    2067/     777 : 56 D6               	JMS SUB_REG16P0_REG16P1	; REG(RMND) = REG(RMND) - REG(P1)
    2068/     779 : 1A 7E               	JCN CN, REG16_DIV_NEXT4
    2069/     77B : 68                  	INC R8			; result +=1000H
    2070/     77C : 47 77               	JUN REG16_DIV_LOOP4
    2071/     77E :                     REG16_DIV_NEXT4:
    2072/     77E : 56 C1               	JMS ADD_REG16P0_REG16P1	; REG(RMND) = REG(RMND) + REG(P1)
    2073/     780 : 56 ED               	JMS DIV16_P2P3		; P2P3 /=16
    2074/     782 :                     REG16_DIV_L3:
    2075/     782 : 56 0F               	JMS LD_REG16P1_P2P3	; REG(P1)=P2P3
    2076/     784 :                     REG16_DIV_LOOP3:
    2077/     784 : 56 D6               	JMS SUB_REG16P0_REG16P1	; REG(RMND) = REG(RMND) - REG(P1)
    2078/     786 : 1A 8B               	JCN CN, REG16_DIV_NEXT3
    2079/     788 : 69                  	INC R9			; result +=100H
    2080/     789 : 47 84               	JUN REG16_DIV_LOOP3
    2081/     78B :                     REG16_DIV_NEXT3:
    2082/     78B : 56 C1               	JMS ADD_REG16P0_REG16P1	; REG(RMND) = REG(RMND) + REG(P1)
    2083/     78D : 56 ED               	JMS DIV16_P2P3		; P2P3 /=16
    2084/     78F :                     REG16_DIV_L2:
    2085/     78F : 56 0F               	JMS LD_REG16P1_P2P3	; REG(P1)=P2P3
    2086/     791 :                     REG16_DIV_LOOP2:
    2087/     791 : 56 D6               	JMS SUB_REG16P0_REG16P1	; REG(RMND) = REG(RMND) - REG(P1)
    2088/     793 : 1A 98               	JCN CN, REG16_DIV_NEXT2
    2089/     795 : 6A                  	INC R10			; result +=10H
    2090/     796 : 47 91               	JUN REG16_DIV_LOOP2
    2091/     798 :                     REG16_DIV_NEXT2:
    2092/     798 : 56 C1               	JMS ADD_REG16P0_REG16P1	; REG(RMND) = REG(RMND) + REG(P1)
    2093/     79A : 56 ED               	JMS DIV16_P2P3		; P2P3 /=16
    2094/     79C :                     REG16_DIV_L1:	
    2095/     79C : 56 0F               	JMS LD_REG16P1_P2P3	; REG(P1)=P2P3
    2096/     79E :                     REG16_DIV_LOOP1:
    2097/     79E : 56 D6               	JMS SUB_REG16P0_REG16P1	; REG(RMND) = REG(RMND) - REG(P1)
    2098/     7A0 : 1A A5               	JCN CN, REG16_DIV_NEXT1
    2099/     7A2 : 6B                  	INC R11	 		; result +=1H
    2100/     7A3 : 47 9E               	JUN REG16_DIV_LOOP1
    2101/     7A5 :                     REG16_DIV_NEXT1:
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 40 - 2023/03/11 11:35:13


    2102/     7A5 : 56 C1               	JMS ADD_REG16P0_REG16P1	; REG(RMND) = REG(RMND) + REG(P1)
    2103/     7A7 :                     
    2104/     7A7 : 59 C0               	JMS POP_P2		; set sign of remainder
    2105/     7A9 : A5                  	LD R5
    2106/     7AA : 14 B0               	JCN Z, REG16_DIV_POSITIVE_RMND
    2107/     7AC : 55 EC               	JMS COMPLEMENT_REG16P0
    2108/     7AE : 55 CB               	JMS INC_REG16P0
    2109/     7B0 :                     REG16_DIV_POSITIVE_RMND:
    2110/     7B0 : (MACRO)              	LD_P2_P4
    2110/     7B0 : A8                                  LD R8
    2110/     7B1 : B4                                  XCH R4
    2110/     7B2 : A9                                  LD R9
    2110/     7B3 : B5                                  XCH R5
    2111/     7B4 : (MACRO)              	LD_P3_P5
    2111/     7B4 : AA                                  LD R10
    2111/     7B5 : B6                                  XCH R6
    2111/     7B6 : AB                                  LD R11
    2111/     7B7 : B7                                  XCH R7
    2112/     7B8 :                     
    2113/     7B8 : 59 8C               	JMS POP_P0
    2114/     7BA : 55 FA               	JMS LD_REG16P0_P2P3		; REG(P0)=P2P3 (ABS(REG(P0))/ABS(REG(P1)))
    2115/     7BC : 56 5A               	JMS GET_SIGNFLAG_TOCARRY	; check the sign of the result
    2116/     7BE : 1A C4               	JCN NC, REG16_DIV_EXIT
    2117/     7C0 :                     	;; REG(P0)=-REG(P0)
    2118/     7C0 : 55 EC               	JMS COMPLEMENT_REG16P0
    2119/     7C2 : 55 CB               	JMS INC_REG16P0
    2120/     7C4 :                     REG16_DIV_EXIT:
    2121/     7C4 : 59 A6               	JMS POP_P1
    2122/     7C6 : 59 FD               	JMS POP_REG16P1
    2123/     7C8 :                     	
    2124/     7C8 : C0                  	BBL 0
    2125/     7C9 :                     
    2126/     7C9 :                     ;;;----------------------------------------------------------------------------
    2127/     7C9 :                     ;;; CMP_REG16P0_REG16P1
    2128/     7C9 :                     ;;; execute REG16(P0) - REG16(P1) and generate flag
    2129/     7C9 :                     ;;; output: ACC=1, CY=0 if REG16(P0) <  REG16(P1)
    2130/     7C9 :                     ;;; 	    ACC=0, CY=1 if REG16(P0) == REG16(P1)
    2131/     7C9 :                     ;;; 	    ACC=1, CY=1 if REG16(P0) >  REG16(P1)
    2132/     7C9 :                     ;;; destroy: P6, P7, R5
    2133/     7C9 :                     ;;;----------------------------------------------------------------------------
    2134/     7C9 :                     CMP_REG16P0_REG16P1:
    2135/     7C9 : A1                  	LD R1
    2136/     7CA : BF                  	XCH R15			; save R1 to R15
    2137/     7CB : A3                  	LD R3
    2138/     7CC : BD                  	XCH R13			; save R3 to R13
    2139/     7CD : F0                  	CLB
    2140/     7CE : BC                  	XCH R12			; R12 = 0
    2141/     7CF : DC                  	LDM loop(4)
    2142/     7D0 : BE                  	XCH R14			; R14=12, 13, 14, 15
    2143/     7D1 : FA                  	STC
    2144/     7D2 :                     REG16_CMP_LOOP:
    2145/     7D2 : F3                  	CMC
    2146/     7D3 : 21                  	SRC P0
    2147/     7D4 : E9                  	RDM
    2148/     7D5 : 23                  	SRC P1
    2149/     7D6 : E8                  	SBM
    2150/     7D7 : 61                  	INC R1
    2151/     7D8 : 63                  	INC R3
    2152/     7D9 : BB                  	XCH R11			; save ACC to R11 (exit with MSB)
    2153/     7DA : AB                  	LD R11
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 41 - 2023/03/11 11:35:13


    2154/     7DB : 14 DF               	JCN Z, REG16_CMP_NEXT
    2155/     7DD : D1                  	LDM 1
    2156/     7DE : BC                  	XCH R12			; set flag for REG(P0) != REG(P1)
    2157/     7DF :                     REG16_CMP_NEXT:
    2158/     7DF : 7E D2               	ISZ R14, REG16_CMP_LOOP
    2159/     7E1 : AB                  	LD R11
    2160/     7E2 : F5                  	RAL
    2161/     7E3 : F3                  	CMC			; CY=~MSB
    2162/     7E4 :                     
    2163/     7E4 : AF                  	LD R15
    2164/     7E5 : B1                  	XCH R1			; restore R1
    2165/     7E6 : AD                  	LD R13
    2166/     7E7 : B3                  	XCH R3			; restore R3
    2167/     7E8 :                     
    2168/     7E8 : AC                  	LD R12
    2169/     7E9 : 14 EC               	JCN Z, REG16_CMP_EXIT0
    2170/     7EB : C1                  	BBL 1
    2171/     7EC :                     REG16_CMP_EXIT0:
    2172/     7EC : C0                  	BBL 0
    2173/     7ED :                     
    2174/     7ED :                     ;;;----------------------------------------------------------------------------
    2175/     7ED :                     ;;; PRINTSTR_PM12REG16P0_DELIM_P1(Delimiter is P1 and 00H)
    2176/     7ED :                     ;;; PRINTSTR_PM12REG16P0 (Delimiter is 0x00)
    2177/     7ED :                     ;;; Print a string 
    2178/     7ED :                     ;;; put a string on PM12(REG16(P0)) to serial output until the P1 or 00H
    2179/     7ED :                     ;;; REG(INDEX) is incremented to
    2180/     7ED :                     ;;; 	the end of the string    (if the last char == 00H)
    2181/     7ED :                     ;;; 	the end of the string +1 (if the last char != 00H)
    2182/     7ED :                     ;;; 
    2183/     7ED :                     ;;; destroy: P6, P7
    2184/     7ED :                     ;;;----------------------------------------------------------------------------
    2185/     7ED :                     PRINTSTR_PM12REG16P0:
    2186/     7ED : 59 74               	JMS PUSH_P2
    2187/     7EF : 59 5C               	JMS PUSH_P1
    2188/     7F1 : 22 00               	FIM P1, 00H
    2189/     7F3 : 47 F9               	JUN PRINTSTR_PM12REG16P0_XX
    2190/     7F5 :                     PRINTSTR_PM12REG16P0_DELIM_P1:
    2191/     7F5 : 59 74               	JMS PUSH_P2
    2192/     7F7 : 59 5C               	JMS PUSH_P1
    2193/     7F9 :                     PRINTSTR_PM12REG16P0_XX:
    2194/     7F9 : 59 44               	JMS PUSH_P0
    2195/     7FB : (MACRO)              	LD_P2_P1		; save the delimiter P1 to P2
    2195/     7FB : A2                                  LD R2
    2195/     7FC : B4                                  XCH R4
    2195/     7FD : A3                                  LD R3
    2195/     7FE : B5                                  XCH R5
    2196/     7FF :                     PRINTSTR_LOOP:
    2197/     7FF : 59 07               	JMS LD_P1_PM12REG16P0
    2198/     801 : 5D F5               	JMS ISZEROORNOT_P1
    2199/     803 : 14 0F               	JCN Z, PRINTSTR_EXIT
    2200/     805 : 5D DD               	JMS CMPEQ_P1P2
    2201/     807 : 14 0F               	JCN Z, PRINTSTR_EXIT
    2202/     809 : 5D 28               	JMS PUTCHAR_P1
    2203/     80B :                     	
    2204/     80B : 55 CB               	JMS INC_REG16P0
    2205/     80D : 47 FF               	JUN PRINTSTR_LOOP
    2206/     80F :                     PRINTSTR_EXIT:
    2207/     80F : 24 00               	FIM P2, 00H
    2208/     811 : 5D DD               	JMS CMPEQ_P1P2
    2209/     813 : 14 17               	JCN Z, PRINTSTR_EXIT_NOINCREMENT
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 42 - 2023/03/11 11:35:13


    2210/     815 : 55 CB               	JMS INC_REG16P0		; pointer++ if the last char is not 00H
    2211/     817 :                     PRINTSTR_EXIT_NOINCREMENT:
    2212/     817 : 59 8C               	JMS POP_P0
    2213/     819 : 59 A6               	JMS POP_P1
    2214/     81B : 59 C0               	JMS POP_P2
    2215/     81D : C0                  	BBL 0
    2216/     81E :                     
    2217/     81E :                     
    2218/     81E :                     ;;;----------------------------------------------------------------------------
    2219/     81E :                     ;;; PRINT_REG16P1
    2220/     81E :                     ;;; PRINT REG16(P1) in decimal format
    2221/     81E :                     ;;; destroy: P3, P4, P5, P6, P7
    2222/     81E :                     ;;;----------------------------------------------------------------------------
    2223/     81E :                     PRINT_REG16P1:
    2224/     81E :                     	; PUSH P0, REG(P1), P1, P2, and REG(RMND)
    2225/     81E : 59 44               	JMS PUSH_P0
    2226/     820 : 59 DA               	JMS PUSH_REG16P1
    2227/     822 : 59 5C               	JMS PUSH_P1
    2228/     824 : 59 74               	JMS PUSH_P2
    2229/     826 : (MACRO)              	LD_P0_P1		; P0 = P1, below here
    2229/     826 : A2                                  LD R2
    2229/     827 : B0                                  XCH R0
    2229/     828 : A3                                  LD R3
    2229/     829 : B1                                  XCH R1
    2230/     82A : 22 90               	FIM P1, REG16_RMND	; save last RMND before this PRINT
    2231/     82C : 59 DA               	JMS PUSH_REG16P1
    2232/     82E :                     
    2233/     82E : 2E 7C               	FIM P7, REG4_ZEROSUP	; set zero supress flag
    2234/     830 : D1                  	LDM 1
    2235/     831 : 2F                  	SRC P7
    2236/     832 : E0                  	WRM
    2237/     833 :                     	
    2238/     833 : 55 AF               	JMS GETSIGN_REG16P0_TOCARRY ; Print '-' if REG(P0) < 0
    2239/     835 : 1A 3F               	JCN NC, PRINT_REG16P1_POSITIVE
    2240/     837 : 55 EC               	JMS COMPLEMENT_REG16P0
    2241/     839 : 55 CB               	JMS INC_REG16P0
    2242/     83B : 22 2D               	FIM P1, '-'
    2243/     83D : 5D 28               	JMS PUTCHAR_P1
    2244/     83F :                     
    2245/     83F :                     PRINT_REG16P1_POSITIVE:	
    2246/     83F :                     	;; 10000'
    2247/     83F : 22 AC               	FIM P1, REG16_TMP_PRN	; REG16(TMP_PRN) = 10000
    2248/     841 : 24 27               	FIM P2, up(10000)
    2249/     843 : 26 10               	FIM P3, lo(10000)
    2250/     845 : 56 0F               	JMS LD_REG16P1_P2P3
    2251/     847 : 57 22               	JMS DIV_REG16P0_REG16P1	; REG(P0)=REG(P0)/REG(TMP_PRN)
    2252/     849 : 58 C4               	JMS PRINT_REG4P0_ZEROSUP
    2253/     84B :                     
    2254/     84B : 22 90               	FIM P1, REG16_RMND
    2255/     84D : 55 50               	JMS LD_REG16P0_REG16P1	; REG(P0) = REG(RMND)
    2256/     84F :                     
    2257/     84F :                     	;; 1000'
    2258/     84F : 22 AC               	FIM P1, REG16_TMP_PRN	; REG16(TMP_PRN) = 1000
    2259/     851 : 24 03               	FIM P2, up(1000)
    2260/     853 : 26 E8               	FIM P3, lo(1000)
    2261/     855 : 56 0F               	JMS LD_REG16P1_P2P3
    2262/     857 :                     
    2263/     857 : 57 22               	JMS DIV_REG16P0_REG16P1	; REG(P0)=REG(P0)/REG(TMP_PRN)
    2264/     859 : 58 C4               	JMS PRINT_REG4P0_ZEROSUP
    2265/     85B :                     
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 43 - 2023/03/11 11:35:13


    2266/     85B : 22 90               	FIM P1, REG16_RMND
    2267/     85D : 55 50               	JMS LD_REG16P0_REG16P1	; REG(P0) = REG(RMND)
    2268/     85F :                     
    2269/     85F :                     	;; 100'
    2270/     85F : 22 AC               	FIM P1, REG16_TMP_PRN	; REG16(TMP_PRN) = 100
    2271/     861 : 24 00               	FIM P2, up(100)
    2272/     863 : 26 64               	FIM P3, lo(100)
    2273/     865 : 56 0F               	JMS LD_REG16P1_P2P3
    2274/     867 :                     
    2275/     867 : 57 22               	JMS DIV_REG16P0_REG16P1	; REG(P0)=REG(P0)/REG(TMP_PRN)
    2276/     869 : 58 C4               	JMS PRINT_REG4P0_ZEROSUP
    2277/     86B :                     
    2278/     86B : 22 90               	FIM P1, REG16_RMND
    2279/     86D : 55 50               	JMS LD_REG16P0_REG16P1	; REG(P0) = REG(RMND)
    2280/     86F :                     
    2281/     86F :                     	;; 10'
    2282/     86F : 22 AC               	FIM P1, REG16_TMP_PRN	; REG16(TMP_PRN) = 10
    2283/     871 : 24 00               	FIM P2, up(10)
    2284/     873 : 26 0A               	FIM P3, lo(10)
    2285/     875 : 56 0F               	JMS LD_REG16P1_P2P3
    2286/     877 :                     
    2287/     877 : 57 22               	JMS DIV_REG16P0_REG16P1	; REG(P0)=REG(P0)/REG(TMP_PRN)
    2288/     879 : 58 C4               	JMS PRINT_REG4P0_ZEROSUP
    2289/     87B :                     
    2290/     87B :                     	;; 1'
    2291/     87B : 20 90               	FIM P0, REG16_RMND
    2292/     87D : 21                  	SRC P0
    2293/     87E : E9                  	RDM
    2294/     87F : 5D 48               	JMS PRINT_ACC
    2295/     881 :                     	
    2296/     881 :                     	; POP P0, REG(P1), P1, P2, and REG(RMND)
    2297/     881 : 22 90               	FIM P1, REG16_RMND	; restore last RMND
    2298/     883 : 59 FD               	JMS POP_REG16P1
    2299/     885 : 59 C0               	JMS POP_P2
    2300/     887 : 59 A6               	JMS POP_P1
    2301/     889 : 59 FD               	JMS POP_REG16P1		; restore REG(P1)
    2302/     88B : 59 8C               	JMS POP_P0
    2303/     88D : C0                  	BBL 0
    2304/     88E :                     	
    2305/     88E :                     ;;;----------------------------------------------------------------------------
    2306/     88E :                     ;;; PRINTHEX_REG16P1
    2307/     88E :                     ;;; PRINT REG16(P0)
    2308/     88E :                     ;;; destroy: P6, P7
    2309/     88E :                     ;;;----------------------------------------------------------------------------
    2310/     88E :                     PRINTHEX_REG16P1:
    2311/     88E : 59 5C               	JMS PUSH_P1
    2312/     890 : 59 74               	JMS PUSH_P2
    2313/     892 : (MACRO)              	LD_P2_P3
    2313/     892 : A6                                  LD R6
    2313/     893 : B4                                  XCH R4
    2313/     894 : A7                                  LD R7
    2313/     895 : B5                                  XCH R5
    2314/     896 : 59 74               	JMS PUSH_P2
    2315/     898 :                     	
    2316/     898 : 56 24               	JMS LD_P2P3_REG16P1
    2317/     89A : A4                  	LD R4
    2318/     89B : 5D 48               	JMS PRINT_ACC		; print bit.FEDC
    2319/     89D : A5                  	LD R5
    2320/     89E : 5D 48               	JMS PRINT_ACC		; print bit.BA98
    2321/     8A0 : A6                  	LD R6
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 44 - 2023/03/11 11:35:13


    2322/     8A1 : 5D 48               	JMS PRINT_ACC		; print bit.7654
    2323/     8A3 : A7                  	LD R7
    2324/     8A4 : 5D 48               	JMS PRINT_ACC		; print bit.3210
    2325/     8A6 :                     
    2326/     8A6 : 59 C0               	JMS POP_P2
    2327/     8A8 : (MACRO)              	LD_P3_P2
    2327/     8A8 : A4                                  LD R4
    2327/     8A9 : B6                                  XCH R6
    2327/     8AA : A5                                  LD R5
    2327/     8AB : B7                                  XCH R7
    2328/     8AC : 59 C0               	JMS POP_P2
    2329/     8AE : 59 A6               	JMS POP_P1
    2330/     8B0 : C0                  	BBL 0
    2331/     8B1 :                     ;;;----------------------------------------------------------------------------
    2332/     8B1 :                     ;;; PRINTHEX_P1
    2333/     8B1 :                     ;;; Print 8bit register pair in HEX format
    2334/     8B1 :                     ;;; PRINT HEX
    2335/     8B1 :                     ;;; destroy: P6, P7
    2336/     8B1 :                     ;;;----------------------------------------------------------------------------
    2337/     8B1 :                     PRINTHEX_P1:
    2338/     8B1 : 59 44               	JMS PUSH_P0
    2339/     8B3 : 59 5C               	JMS PUSH_P1
    2340/     8B5 : (MACRO)              	LD_P0_P1
    2340/     8B5 : A2                                  LD R2
    2340/     8B6 : B0                                  XCH R0
    2340/     8B7 : A3                                  LD R3
    2340/     8B8 : B1                                  XCH R1
    2341/     8B9 : A0                  	LD R0
    2342/     8BA : 5D 48               	JMS PRINT_ACC		; print upper 4bit
    2343/     8BC : A1                  	LD R1
    2344/     8BD : 5D 48               	JMS PRINT_ACC		; print lower 4bit
    2345/     8BF : 59 A6               	JMS POP_P1
    2346/     8C1 : 59 8C               	JMS POP_P0
    2347/     8C3 : C0                  	BBL 0
    2348/     8C4 :                     
    2349/     8C4 :                     ;;;----------------------------------------------------------------------------
    2350/     8C4 :                     ;;; PRINT_REG4P0_ZEROSUP:
    2351/     8C4 :                     ;;; PRINT REG4(P0)
    2352/     8C4 :                     ;;; if REG4(P0) !=0 then print it and clear REG(ZEROSUP) flag
    2353/     8C4 :                     ;;; else if REG4(ZEROSUP) == false then print (P0)
    2354/     8C4 :                     ;;; skip otherwise
    2355/     8C4 :                     ;;; destroy: P6, P7
    2356/     8C4 :                     ;;;----------------------------------------------------------------------------
    2357/     8C4 :                     PRINT_REG4P0_ZEROSUP:
    2358/     8C4 : 21                  	SRC P0
    2359/     8C5 : E9                  	RDM
    2360/     8C6 : 1C CF               	JCN ZN, PRINT_AND_CLEARFLAG 	; print if REG4(P0) != 0
    2361/     8C8 : 2E 7C               	FIM P7, REG4_ZEROSUP
    2362/     8CA : 2F                  	SRC P7
    2363/     8CB : E9                  	RDM
    2364/     8CC : 14 CF               	JCN Z, PRINT_AND_CLEARFLAG 	; if flag == 0 then print
    2365/     8CE : C1                  	BBL 1				; skip print and return (flag=still 1)
    2366/     8CF :                     PRINT_AND_CLEARFLAG:
    2367/     8CF : 5D 48               	JMS PRINT_ACC
    2368/     8D1 : 2E 7C               	FIM P7, REG4_ZEROSUP
    2369/     8D3 : F0                  	CLB
    2370/     8D4 : 2F                  	SRC P7
    2371/     8D5 : E0                  	WRM				; clear the flag
    2372/     8D6 : C0                  	BBL 0
    2373/     8D7 :                     
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 45 - 2023/03/11 11:35:13


    2374/     8D7 :                     ;;;----------------------------------------------------------------------------
    2375/     8D7 :                     ;;; Subroutines for program memory operation
    2376/     8D7 :                     ;;;----------------------------------------------------------------------------
    2377/     8D7 :                     ;;;---------------------------------------------------------------------------
    2378/     8D7 :                     ;;; PM_WRITE_P0_P1
    2379/     8D7 :                     ;;; Write to program memory located at Page 15 (0F00H-0FFFH)
    2380/     8D7 :                     ;;; (0F00H+P0) = P1
    2381/     8D7 :                     ;;; input: P0, P1
    2382/     8D7 :                     ;;; output: none
    2383/     8D7 :                     ;;;---------------------------------------------------------------------------
    2384/     8D7 :                     PM_WRITE_P0_P1:
    2385/     8D7 : 21                  	SRC P0
    2386/     8D8 : A3                  	LD R3
    2387/     8D9 : E3                  	WPM			; write lower 4bit
    2388/     8DA : A2                  	LD R2
    2389/     8DB : E3                  	WPM			; write higher 4bit
    2390/     8DC : C0                  	BBL 0
    2391/     8DD :                     
    2392/     8DD :                     ;;;---------------------------------------------------------------------------
    2393/     8DD :                     ;;; PM_WRITE_P6_P7
    2394/     8DD :                     ;;; Write to program memory located at Page 15 (0F00H-0FFFH)
    2395/     8DD :                     ;;; (0F00H+P6) = P7
    2396/     8DD :                     ;;; input: P6, P7
    2397/     8DD :                     ;;; output: none
    2398/     8DD :                     ;;;---------------------------------------------------------------------------
    2399/     8DD :                     PM_WRITE_P6_P7:
    2400/     8DD : 2D                  	SRC P6
    2401/     8DE : AF                  	LD R15
    2402/     8DF : E3                  	WPM			; write lower 4bit
    2403/     8E0 : AE                  	LD R14
    2404/     8E1 : E3                  	WPM			; write higher 4bit
    2405/     8E2 : C0                  	BBL 0
    2406/     8E3 :                     
    2407/     8E3 :                     ;;;---------------------------------------------------------------------------
    2408/     8E3 :                     ;;; PM_INIT_BANK
    2409/     8E3 :                     ;;; initialization for program memory (RAM)
    2410/     8E3 :                     ;;; Write a subroutne code for reading memory
    2411/     8E3 :                     ;;; destroy: P6, P7
    2412/     8E3 :                     ;;;---------------------------------------------------------------------------
    2413/     8E3 :                     PM_INIT_BANK:	
    2414/     8E3 : 2C FE               	FIM P6, lo(PM_READ_P0_P1)
    2415/     8E5 : 2E 32               	FIM P7, 32H		; FIN P1
    2416/     8E7 : 58 DD               	JMS PM_WRITE_P6_P7
    2417/     8E9 : 6D                  	INC R13
    2418/     8EA : 2E C0               	FIM P7, 0C0H		; BBL 0
    2419/     8EC : 58 DD               	JMS PM_WRITE_P6_P7
    2420/     8EE : C0                  	BBL 0
    2421/     8EF :                     
    2422/     8EF :                     ;;;---------------------------------------------------------------------------
    2423/     8EF :                     ;;; PM_SELECTPMB
    2424/     8EF :                     ;;; Write ACC to RAM port (BANK_PMSELECT, CHIP_PMSELECT)
    2425/     8EF :                     ;;; The bank selection port should be BANK_DEFAULT to omit the DCL instruction
    2426/     8EF :                     ;;; destroy: P7
    2427/     8EF :                     ;;;---------------------------------------------------------------------------
    2428/     8EF :                     PM_SELECTPMB:
    2429/     8EF : 2E 00                       FIM P7, CHIP_PMSELECT
    2430/     8F1 : 2F                          SRC P7
    2431/     8F2 : E1                          WMP
    2432/     8F3 : C0                  	BBL 0
    2433/     8F4 :                     
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 46 - 2023/03/11 11:35:13


    2434/     8F4 :                     ;;;---------------------------------------------------------------------------
    2435/     8F4 :                     ;;; COMMAND_PMB
    2436/     8F4 :                     ;;; Set program memory bank
    2437/     8F4 :                     ;;;---------------------------------------------------------------------------
    2438/     8F4 :                     COMMAND_PMB:
    2439/     8F4 : 20 40               	FIM P0, lo(STR_BANK)	; print " BANK="
    2440/     8F6 : 5E 00               	JMS PRINTSTR_P0
    2441/     8F8 : 5D 00               	JMS GETCHAR_P1
    2442/     8FA : 5D 28               	JMS PUTCHAR_P1
    2443/     8FC : 5D B7               	JMS CTOI_P1
    2444/     8FE : A3                  	LD R3
    2445/     8FF : 58 EF               	JMS PM_SELECTPMB
    2446/     901 : 58 E3               	JMS PM_INIT_BANK
    2447/     903 : 5D 5C               	JMS PRINT_CRLF
    2448/     905 :                     
    2449/     905 : 40 1B               	JUN CMD_LOOP		; return to command loop
    2450/     907 :                     
    2451/     907 :                     ;;;---------------------------------------------------------------------------
    2452/     907 :                     ;;; PM12
    2453/     907 :                     ;;; Logical program memory with 12 bit address space
    2454/     907 :                     ;;; Phisical PM is 254byte(00H to 0FD)x16 bank memory
    2455/     907 :                     ;;; PM12 is a logical memory space (000H to FFFH) mapped to Phisical PM
    2456/     907 :                     ;;; FFEH-FFFH  in each bank is used for PM_READ_P0_P1(2 byte subroutine
    2457/     907 :                     ;;; to read the PM of the bank)
    2458/     907 :                     ;;; PM12 is a 000H-FDF flat space.
    2459/     907 :                     ;;; 
    2460/     907 :                     ;;;    PM12(BA98.7654.3210)
    2461/     907 :                     ;;;   -> PM(3210.7654.BA98) BANK=3210, ADD=7654BA98
    2462/     907 :                     ;;; 
    2463/     907 :                     ;;;    PM16(FEDC.BA98.7654.3210)
    2464/     907 :                     ;;;   -> PM(7654.3210.FEDC.BA98) BANK=BA98.7654 ADD=3210FEDC
    2465/     907 :                     ;;;---------------------------------------------------------------------------
    2466/     907 :                     ;;;---------------------------------------------------------------------------
    2467/     907 :                     ;;; LD_P1_PM12REG16P0
    2468/     907 :                     ;;; P1 = PM12(REG(P0))
    2469/     907 :                     ;;; destroy: P6, P7
    2470/     907 :                     ;;;---------------------------------------------------------------------------
    2471/     907 :                     LD_P1_PM12REG16P0:
    2472/     907 : (MACRO)              	LD_P6_P0		; P6 = P0
    2472/     907 : A0                                  LD R0
    2472/     908 : BC                                  XCH R12
    2472/     909 : A1                                  LD R1
    2472/     90A : BD                                  XCH R13
    2473/     90B : 2D                  	SRC P6
    2474/     90C : E9                  	RDM			; ACC=REG(P0).bit3210
    2475/     90D :                     
    2476/     90D : 2E 00                       FIM P7, CHIP_PMSELECT
    2477/     90F : 2F                          SRC P7
    2478/     910 : E1                          WMP			; set bank to REG(P0).bit3210
    2479/     911 :                     
    2480/     911 : 6D                  	INC R13
    2481/     912 : 2D                  	SRC P6
    2482/     913 : E9                  	RDM
    2483/     914 : B1                  	XCH R1			; R1=REG(P0).bit7654
    2484/     915 :                     	
    2485/     915 : 6D                  	INC R13	
    2486/     916 : 2D                  	SRC P6
    2487/     917 : E9                  	RDM
    2488/     918 : B0                  	XCH R0			; R0 = REG(P0).bitBA98
    2489/     919 :                     
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 47 - 2023/03/11 11:35:13


    2490/     919 : 5F FE               	JMS PM_READ_P0_P1	; P1 = PM(REG(P0))
    2491/     91B :                     
    2492/     91B : AC                  	LD R12                  ; restore P0
    2493/     91C : B0                          XCH R0
    2494/     91D : AD                          LD R13
    2495/     91E :                     	;; 	CLC             ; can be omitted?
    2496/     91E : F8                          DAC
    2497/     91F : F8                          DAC
    2498/     920 : B1                          XCH R1
    2499/     921 : C0                          BBL 0
    2500/     922 :                     
    2501/     922 :                     ;;;---------------------------------------------------------------------------
    2502/     922 :                     ;;; LD_PM12REG16P0_P1
    2503/     922 :                     ;;; PM12(REG(P0)) = P1
    2504/     922 :                     ;;; destroy: P7
    2505/     922 :                     ;;;---------------------------------------------------------------------------
    2506/     922 :                     LD_PM12REG16P0_P1:
    2507/     922 : 21                  	SRC P0
    2508/     923 : E9                  	RDM			; bit3210 of REG(P0)
    2509/     924 : 2E 00                       FIM P7, CHIP_PMSELECT
    2510/     926 : 2F                          SRC P7
    2511/     927 : E1                          WMP			; set bank to REG(P0).bit3210
    2512/     928 :                     
    2513/     928 :                     
    2514/     928 : 61                  	INC R1
    2515/     929 : 21                  	SRC P0
    2516/     92A : E9                  	RDM			; bit7654 of REG(P0)
    2517/     92B : BD                  	XCH R13			; R13 = REG(P0).bit7654
    2518/     92C :                     
    2519/     92C : 61                  	INC R1
    2520/     92D : 21                  	SRC P0
    2521/     92E : E9                  	RDM
    2522/     92F : BC                  	XCH R12			; R12 = REG(P0).bitBA98
    2523/     930 :                     	
    2524/     930 : 2D                  	SRC P6
    2525/     931 : A3                  	LD R3
    2526/     932 : E3                  	WPM
    2527/     933 : A2                  	LD R2
    2528/     934 : E3                  	WPM
    2529/     935 :                     	
    2530/     935 : A1                  	LD R1			; restore P0
    2531/     936 :                     	;; 	CLC             ; can be omitted?
    2532/     936 : F8                  	DAC
    2533/     937 : F8                  	DAC
    2534/     938 : B1                  	XCH R1
    2535/     939 : C0                  	BBL 0
    2536/     93A :                     
    2537/     93A :                     ;;;----------------------------------------------------------------------------
    2538/     93A :                     ;;; PUSH_P0, P1, P2, P3
    2539/     93A :                     ;;; POP_P0, P1, P2, P3
    2540/     93A :                     ;;; Push and Pop an 8bit register pair
    2541/     93A :                     ;;; Stack area is a 16x4bit ring buffer using one register in data RAM.
    2542/     93A :                     ;;; Stack pointer is status character 0 of the register.
    2543/     93A :                     ;;; destroy P7, P6
    2544/     93A :                     ;;;----------------------------------------------------------------------------
    2545/     93A :                     
    2546/     93A :                     ;;;----------------------------------------------------------------------------
    2547/     93A :                     PUSHP	macro ThisR0, ThisR1
    2548/     93A :                     	LDM 2
    2549/     93A :                     	XCH R12
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 48 - 2023/03/11 11:35:13


    2550/     93A :                     	FIM P7, REG16_STACKPOINTER
    2551/     93A :                     	SRC P7
    2552/     93A :                     	RD1
    2553/     93A :                     	CLC
    2554/     93A :                     	SUB R12
    2555/     93A :                     	WR1			; sp.3210=sp.3210-2
    2556/     93A :                     	XCH R15			; R15=new sp.3210(CHAR#)
    2557/     93A :                     	RD0
    2558/     93A :                     	JCN C, PUSH_NOBORROW_ThisR0_ThisR1	; check borrow of the last SUB R12
    2559/     93A :                     	DAC			; decriment upper 4bit
    2560/     93A :                     PUSH_NOBORROW_ThisR0_ThisR1:
    2561/     93A :                     	WR0			; sp.7654--
    2562/     93A :                     	XCH R14			; R14=new sp.7654(REG#)
    2563/     93A :                     
    2564/     93A :                     	SRC P7			;
    2565/     93A :                     	LD ThisR1		; lower 4bit
    2566/     93A :                     	WRM			; (sp)=ThisR1
    2567/     93A :                     	INC R15			; carry check is omitted
    2568/     93A :                     				; because the SP shoudld be even address
    2569/     93A :                     	SRC P7			;
    2570/     93A :                     	LD ThisR0		; upper 4bit
    2571/     93A :                     	WRM			; (sp+1)=ThisR0
    2572/     93A :                     	BBL 0
    2573/     93A :                     	endm
    2574/     93A :                     ;;;----------------------------------------------------------------------------
    2575/     93A :                     POPP	macro ThisR0, ThisR1
    2576/     93A :                     	FIM P7, REG16_STACKPOINTER
    2577/     93A :                     	SRC P7
    2578/     93A :                     	RD0			;
    2579/     93A :                     	XCH R14			; R14=sp.7654 (REG#)
    2580/     93A :                     	RD1			;
    2581/     93A :                     	XCH R15			; R15=sp.3210 (CHAR#)
    2582/     93A :                     	SRC P7			;
    2583/     93A :                     	RDM
    2584/     93A :                     	XCH ThisR1		; ThisR1=(sp)
    2585/     93A :                     	INC R15			; R15++
    2586/     93A :                     				; Carry check is omitted here because SP was even
    2587/     93A :                     	SRC P7			;
    2588/     93A :                     	RDM
    2589/     93A :                     	XCH ThisR0		; ThisR0=(sp+1)
    2590/     93A :                     
    2591/     93A :                     	FIM P6, REG16_STACKPOINTER
    2592/     93A :                     	SRC P6			;
    2593/     93A :                     	INC R15			; R15++
    2594/     93A :                     	LD R15
    2595/     93A :                     	WR1			; sp.lower=sp.lower+2
    2596/     93A :                     	JCN ZN, POP_NOCARRY_ThisR0_ThisR1
    2597/     93A :                     	INC R14
    2598/     93A :                     	LD R14
    2599/     93A :                     	WR0			; sp.upper=sp.upper+1
    2600/     93A :                     POP_NOCARRY_ThisR0_ThisR1:
    2601/     93A :                     	BBL 0
    2602/     93A :                     	endm
    2603/     93A :                     ;;;----------------------------------------------------------------------------
    2604/     93A :                     ;;; INIT_STACKPOINTER
    2605/     93A :                     ;;; Initialize Stack Pointer
    2606/     93A :                     ;;;----------------------------------------------------------------------------
    2607/     93A :                     INIT_STACKPOINTER:
    2608/     93A : 20 FC               	FIM P0, REG16_STACKPOINTER
    2609/     93C : 22 00               	FIM P1, INITVAL_STACKPOINTER
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 49 - 2023/03/11 11:35:13


    2610/     93E : 21                  	SRC P0
    2611/     93F : A2                  	LD R2
    2612/     940 : E4                  	WR0
    2613/     941 : A3                  	LD R3
    2614/     942 : E5                  	WR1
    2615/     943 : C0                  	BBL 0
    2616/     944 :                     
    2617/     944 :                     ;;;----------------------------------------------------------------------------
    2618/     944 :                     ;;; Generate real codes from macros
    2619/     944 :                     ;;;----------------------------------------------------------------------------
    2620/     944 : (MACRO)              PUSH_P0: PUSHP  R0, R1
    2620/     944 : D2                          LDM 2
    2620/     945 : BC                          XCH R12
    2620/     946 : 2E FC                       FIM P7, REG16_STACKPOINTER
    2620/     948 : 2F                          SRC P7
    2620/     949 : ED                          RD1
    2620/     94A : F1                          CLC
    2620/     94B : 9C                          SUB R12
    2620/     94C : E5                          WR1                     ; sp.3210=sp.3210-2
    2620/     94D : BF                          XCH R15                 ; R15=new sp.3210(CHAR#)
    2620/     94E : EC                          RD0
    2620/     94F : 12 52                       JCN C, PUSH_NOBORROW_R0_R1      ; check borrow of the last SUB R12
    2620/     951 : F8                          DAC                     ; decriment upper 4bit
    2620/     952 :                     PUSH_NOBORROW_R0_R1:
    2620/     952 : E4                          WR0                     ; sp.7654--
    2620/     953 : BE                          XCH R14                 ; R14=new sp.7654(REG#)
    2620/     954 :                     
    2620/     954 : 2F                          SRC P7                  ;
    2620/     955 : A1                          LD R1               ; lower 4bit
    2620/     956 : E0                          WRM                     ; (sp)=R1
    2620/     957 : 6F                          INC R15                 ; carry check is omitted
    2620/     958 :                                                     ; because the SP shoudld be even address
    2620/     958 : 2F                          SRC P7                  ;
    2620/     959 : A0                          LD R0               ; upper 4bit
    2620/     95A : E0                          WRM                     ; (sp+1)=R0
    2620/     95B : C0                          BBL 0
    2621/     95C : (MACRO)              PUSH_P1: PUSHP  R2, R3
    2621/     95C : D2                          LDM 2
    2621/     95D : BC                          XCH R12
    2621/     95E : 2E FC                       FIM P7, REG16_STACKPOINTER
    2621/     960 : 2F                          SRC P7
    2621/     961 : ED                          RD1
    2621/     962 : F1                          CLC
    2621/     963 : 9C                          SUB R12
    2621/     964 : E5                          WR1                     ; sp.3210=sp.3210-2
    2621/     965 : BF                          XCH R15                 ; R15=new sp.3210(CHAR#)
    2621/     966 : EC                          RD0
    2621/     967 : 12 6A                       JCN C, PUSH_NOBORROW_R2_R3      ; check borrow of the last SUB R12
    2621/     969 : F8                          DAC                     ; decriment upper 4bit
    2621/     96A :                     PUSH_NOBORROW_R2_R3:
    2621/     96A : E4                          WR0                     ; sp.7654--
    2621/     96B : BE                          XCH R14                 ; R14=new sp.7654(REG#)
    2621/     96C :                     
    2621/     96C : 2F                          SRC P7                  ;
    2621/     96D : A3                          LD R3               ; lower 4bit
    2621/     96E : E0                          WRM                     ; (sp)=R3
    2621/     96F : 6F                          INC R15                 ; carry check is omitted
    2621/     970 :                                                     ; because the SP shoudld be even address
    2621/     970 : 2F                          SRC P7                  ;
    2621/     971 : A2                          LD R2               ; upper 4bit
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 50 - 2023/03/11 11:35:13


    2621/     972 : E0                          WRM                     ; (sp+1)=R2
    2621/     973 : C0                          BBL 0
    2622/     974 : (MACRO)              PUSH_P2: PUSHP  R4, R5
    2622/     974 : D2                          LDM 2
    2622/     975 : BC                          XCH R12
    2622/     976 : 2E FC                       FIM P7, REG16_STACKPOINTER
    2622/     978 : 2F                          SRC P7
    2622/     979 : ED                          RD1
    2622/     97A : F1                          CLC
    2622/     97B : 9C                          SUB R12
    2622/     97C : E5                          WR1                     ; sp.3210=sp.3210-2
    2622/     97D : BF                          XCH R15                 ; R15=new sp.3210(CHAR#)
    2622/     97E : EC                          RD0
    2622/     97F : 12 82                       JCN C, PUSH_NOBORROW_R4_R5      ; check borrow of the last SUB R12
    2622/     981 : F8                          DAC                     ; decriment upper 4bit
    2622/     982 :                     PUSH_NOBORROW_R4_R5:
    2622/     982 : E4                          WR0                     ; sp.7654--
    2622/     983 : BE                          XCH R14                 ; R14=new sp.7654(REG#)
    2622/     984 :                     
    2622/     984 : 2F                          SRC P7                  ;
    2622/     985 : A5                          LD R5               ; lower 4bit
    2622/     986 : E0                          WRM                     ; (sp)=R5
    2622/     987 : 6F                          INC R15                 ; carry check is omitted
    2622/     988 :                                                     ; because the SP shoudld be even address
    2622/     988 : 2F                          SRC P7                  ;
    2622/     989 : A4                          LD R4               ; upper 4bit
    2622/     98A : E0                          WRM                     ; (sp+1)=R4
    2622/     98B : C0                          BBL 0
    2623/     98C : (MACRO)              POP_P0: POPP R0, R1
    2623/     98C : 2E FC                       FIM P7, REG16_STACKPOINTER
    2623/     98E : 2F                          SRC P7
    2623/     98F : EC                          RD0                     ;
    2623/     990 : BE                          XCH R14                 ; R14=sp.7654 (REG#)
    2623/     991 : ED                          RD1                     ;
    2623/     992 : BF                          XCH R15                 ; R15=sp.3210 (CHAR#)
    2623/     993 : 2F                          SRC P7                  ;
    2623/     994 : E9                          RDM
    2623/     995 : B1                          XCH R1              ; R1=(sp)
    2623/     996 : 6F                          INC R15                 ; R15++
    2623/     997 :                                                     ; Carry check is omitted here because SP was even
    2623/     997 : 2F                          SRC P7                  ;
    2623/     998 : E9                          RDM
    2623/     999 : B0                          XCH R0              ; R0=(sp+1)
    2623/     99A :                     
    2623/     99A : 2C FC                       FIM P6, REG16_STACKPOINTER
    2623/     99C : 2D                          SRC P6                  ;
    2623/     99D : 6F                          INC R15                 ; R15++
    2623/     99E : AF                          LD R15
    2623/     99F : E5                          WR1                     ; sp.lower=sp.lower+2
    2623/     9A0 : 1C A5                       JCN ZN, POP_NOCARRY_R0_R1
    2623/     9A2 : 6E                          INC R14
    2623/     9A3 : AE                          LD R14
    2623/     9A4 : E4                          WR0                     ; sp.upper=sp.upper+1
    2623/     9A5 :                     POP_NOCARRY_R0_R1:
    2623/     9A5 : C0                          BBL 0
    2624/     9A6 : (MACRO)              POP_P1: POPP R2, R3
    2624/     9A6 : 2E FC                       FIM P7, REG16_STACKPOINTER
    2624/     9A8 : 2F                          SRC P7
    2624/     9A9 : EC                          RD0                     ;
    2624/     9AA : BE                          XCH R14                 ; R14=sp.7654 (REG#)
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 51 - 2023/03/11 11:35:13


    2624/     9AB : ED                          RD1                     ;
    2624/     9AC : BF                          XCH R15                 ; R15=sp.3210 (CHAR#)
    2624/     9AD : 2F                          SRC P7                  ;
    2624/     9AE : E9                          RDM
    2624/     9AF : B3                          XCH R3              ; R3=(sp)
    2624/     9B0 : 6F                          INC R15                 ; R15++
    2624/     9B1 :                                                     ; Carry check is omitted here because SP was even
    2624/     9B1 : 2F                          SRC P7                  ;
    2624/     9B2 : E9                          RDM
    2624/     9B3 : B2                          XCH R2              ; R2=(sp+1)
    2624/     9B4 :                     
    2624/     9B4 : 2C FC                       FIM P6, REG16_STACKPOINTER
    2624/     9B6 : 2D                          SRC P6                  ;
    2624/     9B7 : 6F                          INC R15                 ; R15++
    2624/     9B8 : AF                          LD R15
    2624/     9B9 : E5                          WR1                     ; sp.lower=sp.lower+2
    2624/     9BA : 1C BF                       JCN ZN, POP_NOCARRY_R2_R3
    2624/     9BC : 6E                          INC R14
    2624/     9BD : AE                          LD R14
    2624/     9BE : E4                          WR0                     ; sp.upper=sp.upper+1
    2624/     9BF :                     POP_NOCARRY_R2_R3:
    2624/     9BF : C0                          BBL 0
    2625/     9C0 : (MACRO)              POP_P2: POPP R4, R5
    2625/     9C0 : 2E FC                       FIM P7, REG16_STACKPOINTER
    2625/     9C2 : 2F                          SRC P7
    2625/     9C3 : EC                          RD0                     ;
    2625/     9C4 : BE                          XCH R14                 ; R14=sp.7654 (REG#)
    2625/     9C5 : ED                          RD1                     ;
    2625/     9C6 : BF                          XCH R15                 ; R15=sp.3210 (CHAR#)
    2625/     9C7 : 2F                          SRC P7                  ;
    2625/     9C8 : E9                          RDM
    2625/     9C9 : B5                          XCH R5              ; R5=(sp)
    2625/     9CA : 6F                          INC R15                 ; R15++
    2625/     9CB :                                                     ; Carry check is omitted here because SP was even
    2625/     9CB : 2F                          SRC P7                  ;
    2625/     9CC : E9                          RDM
    2625/     9CD : B4                          XCH R4              ; R4=(sp+1)
    2625/     9CE :                     
    2625/     9CE : 2C FC                       FIM P6, REG16_STACKPOINTER
    2625/     9D0 : 2D                          SRC P6                  ;
    2625/     9D1 : 6F                          INC R15                 ; R15++
    2625/     9D2 : AF                          LD R15
    2625/     9D3 : E5                          WR1                     ; sp.lower=sp.lower+2
    2625/     9D4 : 1C D9                       JCN ZN, POP_NOCARRY_R4_R5
    2625/     9D6 : 6E                          INC R14
    2625/     9D7 : AE                          LD R14
    2625/     9D8 : E4                          WR0                     ; sp.upper=sp.upper+1
    2625/     9D9 :                     POP_NOCARRY_R4_R5:
    2625/     9D9 : C0                          BBL 0
    2626/     9DA :                     
    2627/     9DA :                     ;;;----------------------------------------------------------------------------
    2628/     9DA :                     ;;; PUSH_REG16P1
    2629/     9DA :                     ;;; POP_REG16P1
    2630/     9DA :                     ;;; Push and Pop an REG16 register REG16(P1)
    2631/     9DA :                     ;;; Stack area is registers in data RAM.
    2632/     9DA :                     ;;; Stack pointer is status character 0 (REG#) and 1 (CHAR#) of
    2633/     9DA :                     ;;; the REG16_STACKPOINTER
    2634/     9DA :                     ;;; destroy: P7, P6
    2635/     9DA :                     ;;;----------------------------------------------------------------------------
    2636/     9DA :                     PUSH_REG16P1:
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 52 - 2023/03/11 11:35:13


    2637/     9DA : A3                  	LD R3
    2638/     9DB : BD                  	XCH R13			; save R3
    2639/     9DC :                     
    2640/     9DC : D4                  	LDM 4
    2641/     9DD : BC                  	XCH R12
    2642/     9DE : 2E FC               	FIM P7, REG16_STACKPOINTER
    2643/     9E0 : 2F                  	SRC P7
    2644/     9E1 : ED                  	RD1
    2645/     9E2 : F1                  	CLC
    2646/     9E3 : 9C                  	SUB R12
    2647/     9E4 : E5                  	WR1			; sp.3210=sp.3210-4
    2648/     9E5 : BF                  	XCH R15			; R15=new sp.3210(CHAR#)
    2649/     9E6 : EC                  	RD0			; 
    2650/     9E7 : 12 EA               	JCN C, PUSH_REG16P1_NOBORROW ; check borrow of the last SUB R12
    2651/     9E9 : F8                  	DAC			; decriment upper 4bit
    2652/     9EA :                     PUSH_REG16P1_NOBORROW:
    2653/     9EA : E4                  	WR0			; sp.7654--
    2654/     9EB : BE                  	XCH R14			; R14=new sp.7654(REG#)
    2655/     9EC :                     	
    2656/     9EC : DC                  	LDM loop(4)
    2657/     9ED : BC                  	XCH R12
    2658/     9EE :                     PUSH_REG16P1_LOOP:
    2659/     9EE : 23                  	SRC P1
    2660/     9EF : E9                  	RDM
    2661/     9F0 : 2F                  	SRC P7
    2662/     9F1 : E0                  	WRM			; (R15)=REG(P1)
    2663/     9F2 : 6F                  	INC R15
    2664/     9F3 : AF                  	LD R15
    2665/     9F4 : 1C F7               	JCN ZN, PUSH_REG16P1_NOINCUPPER
    2666/     9F6 : 6E                  	INC R14			; increment REG#
    2667/     9F7 :                     PUSH_REG16P1_NOINCUPPER:
    2668/     9F7 : 63                  	INC R3
    2669/     9F8 : 7C EE               	ISZ R12, PUSH_REG16P1_LOOP
    2670/     9FA :                     
    2671/     9FA : AD                  	LD R13
    2672/     9FB : B3                  	XCH R3			; restore R3
    2673/     9FC : C0                  	BBL 0
    2674/     9FD :                     ;;;----------------------------------------------------------------------------
    2675/     9FD :                     POP_REG16P1:
    2676/     9FD : A3                  	LD R3
    2677/     9FE : BD                  	XCH R13			; save R3
    2678/     9FF :                     
    2679/     9FF : 2E FC               	FIM P7, REG16_STACKPOINTER
    2680/     A01 : 2F                  	SRC P7
    2681/     A02 : EC                  	RD0			;
    2682/     A03 : BE                  	XCH R14			; R14=sp.7654 (REG#)
    2683/     A04 : ED                  	RD1			;
    2684/     A05 : BF                  	XCH R15			; R15=sp.3210 (CHAR#)
    2685/     A06 : DC                  	LDM loop(4)
    2686/     A07 : BC                  	XCH R12
    2687/     A08 :                     POP_REG16P1_LOOP:
    2688/     A08 : 2F                  	SRC P7
    2689/     A09 : E9                  	RDM
    2690/     A0A : 23                  	SRC P1
    2691/     A0B : E0                  	WRM			; REG(P1)=(R15)
    2692/     A0C : 6F                  	INC R15
    2693/     A0D : AF                  	LD R15
    2694/     A0E : 1C 11               	JCN ZN, POP_REG16P1_NOCARRY
    2695/     A10 : 6E                  	INC R14			; increment REG#
    2696/     A11 :                     POP_REG16P1_NOCARRY:
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 53 - 2023/03/11 11:35:13


    2697/     A11 : 63                  	INC R3
    2698/     A12 : 7C 08               	ISZ R12, POP_REG16P1_LOOP
    2699/     A14 :                     
    2700/     A14 : AD                  	LD R13
    2701/     A15 : B3                  	XCH R3			; restore R3
    2702/     A16 :                     
    2703/     A16 : 2C FC               	FIM P6, REG16_STACKPOINTER
    2704/     A18 : 2D                  	SRC P6 			; write new sp (old sp+4)
    2705/     A19 : AE                  	LD R14
    2706/     A1A : E4                  	WR0
    2707/     A1B : AF                  	LD R15
    2708/     A1C : E5                  	WR1
    2709/     A1D :                     
    2710/     A1D : C0                  	BBL 0
    2711/     A1E :                     
    2712/     A1E :                     ;;;----------------------------------------------------------------------------
    2713/     A1E :                     ;;; GETLINE_PM12REG16P0
    2714/     A1E :                     ;;; Get line from serial input and store to PM12(REG(P0))
    2715/     A1E :                     ;;; The value of REG(P0) does not change
    2716/     A1E :                     ;;;----------------------------------------------------------------------------
    2717/     A1E :                     GETLINE_PM12REG16P0:
    2718/     A1E : 59 44               	JMS PUSH_P0
    2719/     A20 : 59 5C               	JMS PUSH_P1
    2720/     A22 :                     
    2721/     A22 : 22 A0               	FIM P1, REG16_TMP
    2722/     A24 : 55 63               	JMS LD_REG16P1_REG16P0	; REG(TMP)=REG(INDEX)
    2723/     A26 :                     
    2724/     A26 :                     GETLINE_LOOP:
    2725/     A26 : 5D 00               	JMS GETCHAR_P1		; P1 = getchar()
    2726/     A28 :                     
    2727/     A28 : 2E 0D               	FIM P7, '\r'
    2728/     A2A : 5D D0               	JMS CMP_P1P7
    2729/     A2C : 14 26               	JCN Z, GETLINE_LOOP	; skip CR
    2730/     A2E :                     
    2731/     A2E : 2E 0A               	FIM P7, '\n'		; LF
    2732/     A30 : 5D D0               	JMS CMP_P1P7
    2733/     A32 : 1C 3E               	JCN ZN, GETLINE_L1
    2734/     A34 :                     
    2735/     A34 : 22 0D               	FIM P1, '\r'
    2736/     A36 : 5D 28               	JMS PUTCHAR_P1
    2737/     A38 : 22 0A               	FIM P1, '\n'		; put CRLF
    2738/     A3A : 5D 28               	JMS PUTCHAR_P1
    2739/     A3C : 4A 60               	JUN GETLINE_EXIT
    2740/     A3E :                     GETLINE_L1:
    2741/     A3E : 2E 08               	FIM P7, 08H		; backspace
    2742/     A40 : 5D D0               	JMS CMP_P1P7
    2743/     A42 : 1C 58               	JCN ZN, GETLINE_INSERTCHAR
    2744/     A44 :                     
    2745/     A44 : 22 A0               	FIM P1, REG16_TMP
    2746/     A46 : 57 C9               	JMS CMP_REG16P0_REG16P1
    2747/     A48 : 1C 4C               	JCN ZN, GETLINE_BS	; do BS if REG(P0)!=REG(TMP)
    2748/     A4A : 4A 26               	JUN GETLINE_LOOP	; ignore BS
    2749/     A4C :                     GETLINE_BS:		; delete a character on the cursor
    2750/     A4C : 55 DB               	JMS DEC_REG16P0		; REG(P0)--
    2751/     A4E :                     GETLINE_L1_NEXT:		; delete a character on the cursor
    2752/     A4E : 22 08               	FIM P1, 08H
    2753/     A50 : 5D 28               	JMS PUTCHAR_P1		; put backspace
    2754/     A52 : 5D 53               	JMS PRINT_SPC		; put ' '
    2755/     A54 : 5D 28               	JMS PUTCHAR_P1		; put backspace
    2756/     A56 :                     
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 54 - 2023/03/11 11:35:13


    2757/     A56 : 4A 26               	JUN GETLINE_LOOP
    2758/     A58 :                     GETLINE_INSERTCHAR:
    2759/     A58 : 5D 28               	JMS PUTCHAR_P1
    2760/     A5A : 59 22               	JMS LD_PM12REG16P0_P1
    2761/     A5C : 55 CB               	JMS INC_REG16P0		; *REG(P0)++ = P1
    2762/     A5E :                     
    2763/     A5E : 4A 26               	JUN GETLINE_LOOP
    2764/     A60 :                     GETLINE_EXIT:
    2765/     A60 : 22 00               	FIM P1, 00H
    2766/     A62 : 59 22               	JMS LD_PM12REG16P0_P1 	; write NULL on the end of line buffer
    2767/     A64 : 55 CB               	JMS INC_REG16P0
    2768/     A66 : 59 22               	JMS LD_PM12REG16P0_P1 	; write extra NULL to prevent buffer overrun
    2769/     A68 :                     
    2770/     A68 : 22 A0               	FIM P1, REG16_TMP
    2771/     A6A : 55 50               	JMS LD_REG16P0_REG16P1	; restore REG(INDEX)
    2772/     A6C : 59 A6               	JMS POP_P1		; restore P1
    2773/     A6E : 59 8C               	JMS POP_P0		; restore P0
    2774/     A70 : C0                  	BBL 0
    2775/     A71 :                     
    2776/     A71 :                     
    2777/     A71 :                     ;;;----------------------------------------------------------------------------
    2778/     A71 :                     ;;; GETNUMBER_PM12REG16P0_REG16P1
    2779/     A71 :                     ;;; Read a decimal or hexadecimal number in the string and store to register
    2780/     A71 :                     ;;; Read string from PM12(REG16(P0)) and set a number to REG16(P1)
    2781/     A71 :                     ;;; REG16(P0) is incremented to the character which is not a number.
    2782/     A71 :                     ;;; Hexadecimal number begins with 0 (ex. 0A123).
    2783/     A71 :                     ;;; destroy: P7, P6, P2, P3
    2784/     A71 :                     ;;; TMP: result
    2785/     A71 :                     ;;; TMP2: input char buffer
    2786/     A71 :                     ;;; TMP3: working for multiply by 10
    2787/     A71 :                     ;;;----------------------------------------------------------------------------
    2788/     A71 :                     GETNUMBER_PM12REG16P0_REG16P1:
    2789/     A71 : 59 44               	JMS PUSH_P0
    2790/     A73 : 59 5C               	JMS PUSH_P1
    2791/     A75 : (MACRO)              	LD_P2_P0		; P0 is saved to P2
    2791/     A75 : A0                                  LD R0
    2791/     A76 : B4                                  XCH R4
    2791/     A77 : A1                                  LD R1
    2791/     A78 : B5                                  XCH R5
    2792/     A79 :                     
    2793/     A79 : (MACRO)              	LD_P0_P1
    2793/     A79 : A2                                  LD R2
    2793/     A7A : B0                                  XCH R0
    2793/     A7B : A3                                  LD R3
    2793/     A7C : B1                                  XCH R1
    2794/     A7D : 55 43               	JMS CLEAR_REG16P0	; REG(P1) = 0
    2795/     A7F :                     
    2796/     A7F : 20 A0               	FIM P0, REG16_TMP
    2797/     A81 : 55 43               	JMS CLEAR_REG16P0	; REG(TMP) = 0 register for the result
    2798/     A83 :                     
    2799/     A83 : (MACRO)              	LD_P0_P2		; restore P0
    2799/     A83 : A4                                  LD R4
    2799/     A84 : B0                                  XCH R0
    2799/     A85 : A5                                  LD R5
    2799/     A86 : B1                                  XCH R1
    2800/     A87 : 59 07               	JMS LD_P1_PM12REG16P0	; P1 = PM12(REG16(P0))
    2801/     A89 : 2E 30               	FIM P7, '0'
    2802/     A8B : 5D D0               	JMS CMP_P1P7
    2803/     A8D : 1C 91               	JCN ZN, GETNUMBER_LOOP
    2804/     A8F : 4A CC               	JUN GETHEXNUMBER	; start with '0' then get hex number
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 55 - 2023/03/11 11:35:13


    2805/     A91 :                     GETNUMBER_LOOP:
    2806/     A91 : 5D B7               	JMS CTOI_P1
    2807/     A93 :                     
    2808/     A93 : 20 A4               	FIM P0, REG16_TMP2
    2809/     A95 : 56 39               	JMS LD_REG16P0_8BIT_P1       ; REG(TEMP2) = P1
    2810/     A97 :                     
    2811/     A97 : 20 A0               	FIM P0, REG16_TMP
    2812/     A99 : 22 A0               	FIM P1, REG16_TMP
    2813/     A9B : 55 BA               	JMS ISZEROORNOT_REG16P1
    2814/     A9D : 14 AB               	JCN Z, GETNUMBER_SKIP_MUL10
    2815/     A9F :                     	;; REG(TMP) *= 10
    2816/     A9F : 22 A8               	FIM P1, REG16_TMP3
    2817/     AA1 : 55 63               	JMS LD_REG16P1_REG16P0	; REG(TMP3) = REG(TMP)
    2818/     AA3 : 56 8B               	JMS MUL2_REG16P0	; REG(TMP) *= 2
    2819/     AA5 : 56 8B               	JMS MUL2_REG16P0	; REG(TMP) *= 2
    2820/     AA7 : 56 C1               	JMS ADD_REG16P0_REG16P1	; REG(TMP) += REG(TMP3)
    2821/     AA9 : 56 8B               	JMS MUL2_REG16P0	; REG(TMP) *= 2
    2822/     AAB :                     GETNUMBER_SKIP_MUL10:	
    2823/     AAB : 22 A4               	FIM P1, REG16_TMP2
    2824/     AAD : 56 C1               	JMS ADD_REG16P0_REG16P1	; REG(TMP) = REG(TMP)*10 + REG(TMP2)
    2825/     AAF :                     
    2826/     AAF : (MACRO)              	LD_P0_P2		; restore P0
    2826/     AAF : A4                                  LD R4
    2826/     AB0 : B0                                  XCH R0
    2826/     AB1 : A5                                  LD R5
    2826/     AB2 : B1                                  XCH R1
    2827/     AB3 : 55 CB               	JMS INC_REG16P0		; REG(P0)++
    2828/     AB5 : 59 07               	JMS LD_P1_PM12REG16P0	; P1 = PM12(REG16(P0))
    2829/     AB7 : 5D 8C               	JMS ISNUM_P1
    2830/     AB9 : 14 BD               	JCN Z, GETNUMBER_EXIT
    2831/     ABB : 4A 91               	JUN GETNUMBER_LOOP
    2832/     ABD :                     GETNUMBER_EXIT:
    2833/     ABD : 59 A6               	JMS POP_P1
    2834/     ABF : 20 A0               	FIM P0, REG16_TMP
    2835/     AC1 : 55 63               	JMS LD_REG16P1_REG16P0	; REG(P1) = REG(TMP)
    2836/     AC3 : 59 8C               	JMS POP_P0
    2837/     AC5 : C0                   	BBL 0
    2838/     AC6 :                     GETHEX_EXIT:
    2839/     AC6 : 20 A0               	FIM P0, REG16_TMP
    2840/     AC8 : 55 FA               	JMS LD_REG16P0_P2P3
    2841/     ACA : 4A BD               	JUN GETNUMBER_EXIT
    2842/     ACC :                     GETHEXNUMBER:
    2843/     ACC : 24 00               	FIM P2, 00H
    2844/     ACE : 26 00               	FIM P3, 00H
    2845/     AD0 :                     GETHEX_LOOP:
    2846/     AD0 : 55 CB               	JMS INC_REG16P0		; REG(P0)++
    2847/     AD2 : 59 07               	JMS LD_P1_PM12REG16P0	; P1 = PM12(REG16(P0))
    2848/     AD4 : 50 AE               	JMS ISHEX_P1
    2849/     AD6 : 14 C6               	JCN Z, GETHEX_EXIT	; not a hex number then exit
    2850/     AD8 : 5D B7               	JMS CTOI_P1
    2851/     ADA : 56 F6               	JMS MUL16_P2P3		; R4R5R6R7 *= 16
    2852/     ADC : A3                  	LD R3
    2853/     ADD : B7                  	XCH R7			; R7=R3
    2854/     ADE : 4A D0               	JUN GETHEX_LOOP
    2855/     AE0 :                     	
    2856/     AE0 :                     ;;; 	JUN RETURN_P2 ; for another implementation
    2857/     AE0 :                     
    2858/     AE0 :                     ;;;----------------------------------------------------------------------------
    2859/     AE0 :                     ;;; Routines for monitor program command to read/write logical memory
    2860/     AE0 :                     ;;;----------------------------------------------------------------------------
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 56 - 2023/03/11 11:35:13


    2861/     AE0 :                     COMMAND_LMR:
    2862/     AE0 : 20 4E               	FIM P0, lo(STR_ADR)
    2863/     AE2 : 5E 00               	JMS PRINTSTR_P0
    2864/     AE4 :                     
    2865/     AE4 :                     	;; input 2 hexdigits to REG16(TMP)
    2866/     AE4 : F0                  	CLB
    2867/     AE5 : B4                  	XCH R4
    2868/     AE6 : 5D 00               	JMS GETCHAR_P1
    2869/     AE8 : 5D 28               	JMS PUTCHAR_P1
    2870/     AEA : 5D B7               	JMS CTOI_P1
    2871/     AEC : A3                  	LD R3
    2872/     AED : B5                  	XCH R5
    2873/     AEE : 5D 00               	JMS GETCHAR_P1
    2874/     AF0 : 5D 28               	JMS PUTCHAR_P1
    2875/     AF2 : 5D B7               	JMS CTOI_P1
    2876/     AF4 : A3                  	LD R3
    2877/     AF5 : B6                  	XCH R6
    2878/     AF6 : F0                  	CLB
    2879/     AF7 : B7                  	XCH R7
    2880/     AF8 : 22 A0               	FIM P1, REG16_TMP
    2881/     AFA : 56 0F               	JMS LD_REG16P1_P2P3
    2882/     AFC :                     
    2883/     AFC :                     	;; input 1 hexdigits to R11
    2884/     AFC : 5D 00               	JMS GETCHAR_P1
    2885/     AFE : 5D 28               	JMS PUTCHAR_P1
    2886/     B00 : 5D B7               	JMS CTOI_P1
    2887/     B02 : A3                  	LD R3
    2888/     B03 : F4                  	CMA			;R11=15-R3 for ISZ loop(R3+1)
    2889/     B04 : BB                  	XCH R11
    2890/     B05 :                     COMMAND_LMR_VLOOP:
    2891/     B05 : 5D 5C               	JMS PRINT_CRLF
    2892/     B07 : 22 A0               	FIM P1, REG16_TMP
    2893/     B09 : 58 8E               	JMS PRINTHEX_REG16P1
    2894/     B0B : 22 3A               	FIM P1, ':'
    2895/     B0D : 5D 28               	JMS PUTCHAR_P1
    2896/     B0F :                     
    2897/     B0F : D0                  	LDM 0
    2898/     B10 : BA                  	XCH R10
    2899/     B11 :                     COMMAND_LMR_HLOOP:
    2900/     B11 : 20 A0               	FIM P0, REG16_TMP
    2901/     B13 : 59 07               	JMS LD_P1_PM12REG16P0
    2902/     B15 : 58 B1               	JMS PRINTHEX_P1
    2903/     B17 : 55 CB               	JMS INC_REG16P0
    2904/     B19 : 7A 11               	ISZ R10, COMMAND_LMR_HLOOP
    2905/     B1B : 7B 05               	ISZ R11, COMMAND_LMR_VLOOP
    2906/     B1D :                     
    2907/     B1D : 5D 5C               	JMS PRINT_CRLF
    2908/     B1F : 40 1B               	JUN CMD_LOOP
    2909/     B21 :                     	
    2910/     B21 :                     COMMAND_LMW:
    2911/     B21 : 20 4E               	FIM P0, lo(STR_ADR)
    2912/     B23 : 5E 00               	JMS PRINTSTR_P0
    2913/     B25 :                     
    2914/     B25 :                     	;; input 3 hexdigits to REG16(TMP)
    2915/     B25 : F0                  	CLB
    2916/     B26 : B4                  	XCH R4
    2917/     B27 : 5D 00               	JMS GETCHAR_P1
    2918/     B29 : 5D 28               	JMS PUTCHAR_P1
    2919/     B2B : 5D B7               	JMS CTOI_P1
    2920/     B2D : A3                  	LD R3
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 57 - 2023/03/11 11:35:13


    2921/     B2E : B5                  	XCH R5
    2922/     B2F : 5D 00               	JMS GETCHAR_P1
    2923/     B31 : 5D 28               	JMS PUTCHAR_P1
    2924/     B33 : 5D B7               	JMS CTOI_P1
    2925/     B35 : A3                  	LD R3
    2926/     B36 : B6                  	XCH R6
    2927/     B37 : 5D 00               	JMS GETCHAR_P1
    2928/     B39 : 5D 28               	JMS PUTCHAR_P1
    2929/     B3B : 5D B7               	JMS CTOI_P1
    2930/     B3D : A3                  	LD R3
    2931/     B3E : B7                  	XCH R7
    2932/     B3F : 22 A0               	FIM P1, REG16_TMP
    2933/     B41 : 56 0F               	JMS LD_REG16P1_P2P3
    2934/     B43 :                     
    2935/     B43 :                     COMMAND_LMW_LOOP:
    2936/     B43 : 5D 5C               	JMS PRINT_CRLF
    2937/     B45 : 22 A0               	FIM P1, REG16_TMP
    2938/     B47 : 58 8E               	JMS PRINTHEX_REG16P1
    2939/     B49 : 22 3A               	FIM P1, ':'
    2940/     B4B : 5D 28               	JMS PUTCHAR_P1
    2941/     B4D :                     
    2942/     B4D :                     COMMAND_LMW_SKIPCR:
    2943/     B4D : 5D 00               	JMS GETCHAR_P1
    2944/     B4F : 20 0D               	FIM P0, '\r'
    2945/     B51 : 5D C3               	JMS CMP_P0P1
    2946/     B53 : 14 4D               	JCN Z, COMMAND_LMW_SKIPCR	; skip CR
    2947/     B55 : 20 0A               	FIM P0, '\n'
    2948/     B57 : 5D C3               	JMS CMP_P0P1
    2949/     B59 : 14 71               	JCN Z, COMMAND_LMW_EXIT
    2950/     B5B : 5D 28               	JMS PUTCHAR_P1
    2951/     B5D : 5D B7               	JMS CTOI_P1
    2952/     B5F : A3                  	LD R3
    2953/     B60 : B4                  	XCH R4
    2954/     B61 : 5D 00               	JMS GETCHAR_P1
    2955/     B63 : 5D 28               	JMS PUTCHAR_P1
    2956/     B65 : 5D B7               	JMS CTOI_P1
    2957/     B67 : A4                  	LD R4
    2958/     B68 : B2                  	XCH R2
    2959/     B69 : 20 A0               	FIM P0, REG16_TMP
    2960/     B6B : 59 22               	JMS LD_PM12REG16P0_P1
    2961/     B6D : 55 CB               	JMS INC_REG16P0
    2962/     B6F :                     
    2963/     B6F : 4B 43               	JUN COMMAND_LMW_LOOP
    2964/     B71 :                     COMMAND_LMW_EXIT:
    2965/     B71 : 5D 5C               	JMS PRINT_CRLF
    2966/     B73 : 40 1B               	JUN CMD_LOOP
    2967/     B75 :                     
    2968/     BD0 :                     	org 0BD0H
    2969/     BD0 :                     ;;;----------------------------------------------------------------------------
    2970/     BD0 :                     ;;; RETURN_P2
    2971/     BD0 :                     ;;; Return to the address refering jump table
    2972/     BD0 :                     ;;;----------------------------------------------------------------------------
    2973/     BD0 :                     RETURN_P2:
    2974/     BD0 : A5                  	LD R5
    2975/     BD1 : 1C DC               	JCN ZN, RETURN_P2_OK
    2976/     BD3 : A4                  	LD R4
    2977/     BD4 : 1C DC               	JCN ZN, RETURN_P2_OK
    2978/     BD6 : 20 78               	FIM P0, REG8_ERROR
    2979/     BD8 : 22 B0               	FIM P1, ERROR_RETURN_P2_IS_00
    2980/     BDA : 41 16               	JUN VTL_START		; exit (for debug)
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 58 - 2023/03/11 11:35:13


    2981/     BDC :                     RETURN_P2_OK:
    2982/     BDC : 35                  	JIN P2			; Jump to Return Table
    2983/     BDD :                     
    2984/     BDD :                     RETURN_EXEC_R1:
    2985/     BDD : 42 C7               	JUN EXEC_R1
    2986/     BDF :                     RETURN_EVAL_R1:	
    2987/     BDF : 43 AD               	JUN EVAL_R1
    2988/     BE1 :                     RETURN_EVAL_R2:	
    2989/     BE1 : 43 D5               	JUN EVAL_R2
    2990/     BE3 :                     RETURN_GETFACTOR_R1:
    2991/     BE3 : 44 67               	JUN GETFACTOR_R1
    2992/     BE5 :                     RETURN_GETFACTOR_R2:
    2993/     BE5 : 44 79               	JUN GETFACTOR_R2
    2994/     BE7 :                     RETURN_PRINT_R1:
    2995/     BE7 : 43 5B               	JUN PRINT_R1
    2996/     BE9 :                     RETURN_GETFACTOR_L9_R1:	
    2997/     BE9 : 44 FD               	JUN GETFACTOR_L9_R1
    2998/     BEB :                     	
    2999/     BEB :                     ;;;---------------------------------------------------------------------------
    3000/     BEB :                     ;;; Monitor commands located in page 0C00H
    3001/     BEB :                     ;;;---------------------------------------------------------------------------
    3002/     C00 :                     	org 0C00H
    3003/     C00 :                     	
    3004/     C00 :                     ;;;---------------------------------------------------------------------------
    3005/     C00 :                     ;;; COMMAND_G
    3006/     C00 :                     ;;; Go to Top of Program memory PM_RAM_START(0x0F00)
    3007/     C00 :                     ;;;---------------------------------------------------------------------------
    3008/     C00 :                     COMMAND_G:
    3009/     C00 : 5D 5C               	JMS PRINT_CRLF
    3010/     C02 : 5F 00               	JMS PM_RAM_START
    3011/     C04 : 40 1B               	JUN CMD_LOOP		; return to command loop
    3012/     C06 :                     
    3013/     C06 :                     ;;;---------------------------------------------------------------------------
    3014/     C06 :                     ;;; COMMAND_R
    3015/     C06 :                     ;;; Read Data RAM
    3016/     C06 :                     ;;; input:
    3017/     C06 :                     ;;; 	R10: #bank
    3018/     C06 :                     ;;; 	R11: #chip (D3.D2.0.0)
    3019/     C06 :                     ;;; working memory:
    3020/     C06 :                     ;;;     P0(R0R1): working for PRINTSTR_P0
    3021/     C06 :                     ;;;     P1(R2R3): working for PUTCHAR_P1, PRINT_ACC
    3022/     C06 :                     ;;;     R4: loop counter for #REG (0.0.D1.D0)
    3023/     C06 :                     ;;;     R5: working for input
    3024/     C06 :                     ;;;     R6: working for SCR (R6=R11+R4)
    3025/     C06 :                     ;;;     R7: working for SCR #CHARACTER (D3.D2.D1.D0)@X3 (loop counter)
    3026/     C06 :                     ;;;         SCR R6R7
    3027/     C06 :                     ;;; 	R11: #CHIP (D3.D2.0.0)@X2
    3028/     C06 :                     ;;;     P6(R12R13): working for uart
    3029/     C06 :                     ;;;     P7(R14R15): working for uart
    3030/     C06 :                     ;;;---------------------------------------------------------------------------
    3031/     C06 :                     COMMAND_R:
    3032/     C06 :                     	;; PRINT 4 registers
    3033/     C06 : DC                  	LDM loop(4)		; 4 regs
    3034/     C07 : B4                  	XCH R4			; R4=loop(4)
    3035/     C08 :                     
    3036/     C08 :                     	;; PRINT 16 characters
    3037/     C08 :                     CMDR_L1:
    3038/     C08 : D0                  	LDM loop(16)		; 16 characters
    3039/     C09 : B7                  	XCH R7			; R7=D3D2D1D0@X3 (#character)
    3040/     C0A :                     CMDR_L2:
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 59 - 2023/03/11 11:35:13


    3041/     C0A : F0                  	CLB
    3042/     C0B : D4                  	LDM 4
    3043/     C0C : 84                  	ADD R4		;ACC<-#reg (D1D0@X2)(00, 01, 10, 11 for each loop)
    3044/     C0D : F1                  	CLC
    3045/     C0E : 8B                  	ADD R11
    3046/     C0F : B6                  	XCH R6		;R6=D3D2D1D0@X2 (#chip.#reg)
    3047/     C10 :                     	
    3048/     C10 : 27                  	SRC R6R7	; set address
    3049/     C11 : E9                  	RDM		; read data memory
    3050/     C12 : 5D 48               	JMS PRINT_ACC
    3051/     C14 : 77 0A               	ISZ R7,CMDR_L2
    3052/     C16 :                     
    3053/     C16 :                     	;; PRINT STATUS 
    3054/     C16 : 22 3A               	FIM P1, ':'
    3055/     C18 : 5D 28               	JMS PUTCHAR_P1
    3056/     C1A : 27                  	SRC R6R7	; set address
    3057/     C1B : EC                  	RD0
    3058/     C1C : 5D 48               	JMS PRINT_ACC
    3059/     C1E : 27                  	SRC R6R7	; set address
    3060/     C1F : ED                  	RD1
    3061/     C20 : 5D 48               	JMS PRINT_ACC
    3062/     C22 : 27                  	SRC R6R7	; set address
    3063/     C23 : EE                  	RD2
    3064/     C24 : 5D 48               	JMS PRINT_ACC
    3065/     C26 : 27                  	SRC R6R7	; set address
    3066/     C27 : EF                  	RD3
    3067/     C28 : 5D 48               	JMS PRINT_ACC
    3068/     C2A : 5D 5C               	JMS PRINT_CRLF
    3069/     C2C :                     
    3070/     C2C : 74 08               	ISZ R4,CMDR_L1
    3071/     C2E : 40 1B               	JUN CMD_LOOP		; return to command loop
    3072/     C30 :                     	
    3073/     C30 :                     ;;;---------------------------------------------------------------------------
    3074/     C30 :                     ;;; COMMAND_W:
    3075/     C30 :                     ;;; Write Data RAM
    3076/     C30 :                     ;;; input:
    3077/     C30 :                     ;;; 	R10: #bank
    3078/     C30 :                     ;;; 	R11: #chip (D3.D2.0.0)
    3079/     C30 :                     ;;;---------------------------------------------------------------------------
    3080/     C30 :                     COMMAND_W:
    3081/     C30 :                     	;; PRINT 4 registers
    3082/     C30 : DC                  	LDM loop(4)		; 4 regs
    3083/     C31 : B4                  	XCH R4			; R4=loop(4)
    3084/     C32 :                     
    3085/     C32 :                     	;; PRINT 16 characters
    3086/     C32 :                     CMDW_L1:
    3087/     C32 : D0                  	LDM loop(16)		; 16 characters
    3088/     C33 : B7                  	XCH R7			; R7=D3D2D1D0@X3 (#character)
    3089/     C34 :                     CMDW_L2:
    3090/     C34 : F0                  	CLB
    3091/     C35 : D4                  	LDM 4
    3092/     C36 : 84                  	ADD R4		;ACC<-#reg (D1D0@X2)(00, 01, 10, 11 for each loop)
    3093/     C37 : F1                  	CLC
    3094/     C38 : 8B                  	ADD R11
    3095/     C39 : B6                  	XCH R6		;R6=D3D2D1D0@X2 (#chip.#reg)
    3096/     C3A :                     
    3097/     C3A : 5D 00               	JMS GETCHAR_P1
    3098/     C3C : 5D B7               	JMS CTOI_P1
    3099/     C3E :                     
    3100/     C3E : 27                  	SRC R6R7	; set address
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 60 - 2023/03/11 11:35:13


    3101/     C3F : A3                  	LD R3
    3102/     C40 : E0                  	WRM			; write to memory
    3103/     C41 : 5D 48               	JMS PRINT_ACC
    3104/     C43 : 77 34               	ISZ R7,CMDW_L2
    3105/     C45 :                     
    3106/     C45 :                     	;; PRINT STATUS 
    3107/     C45 : 22 3A               	FIM P1, ':'
    3108/     C47 : 5D 28               	JMS PUTCHAR_P1
    3109/     C49 :                     
    3110/     C49 : 5D 00               	JMS GETCHAR_P1
    3111/     C4B : 5D B7               	JMS CTOI_P1
    3112/     C4D :                     
    3113/     C4D : 27                  	SRC R6R7	; set address
    3114/     C4E : A3                  	LD R3
    3115/     C4F : E4                  	WR0
    3116/     C50 : 5D 48               	JMS PRINT_ACC
    3117/     C52 :                     
    3118/     C52 : 5D 00               	JMS GETCHAR_P1
    3119/     C54 : 5D B7               	JMS CTOI_P1
    3120/     C56 :                     
    3121/     C56 : 27                  	SRC R6R7	; set address
    3122/     C57 : A3                  	LD R3
    3123/     C58 : E5                  	WR1
    3124/     C59 : 5D 48               	JMS PRINT_ACC
    3125/     C5B :                     
    3126/     C5B : 5D 00               	JMS GETCHAR_P1
    3127/     C5D : 5D B7               	JMS CTOI_P1
    3128/     C5F :                     
    3129/     C5F : 27                  	SRC R6R7	; set address
    3130/     C60 : A3                  	LD R3
    3131/     C61 : E6                  	WR2
    3132/     C62 : 5D 48               	JMS PRINT_ACC
    3133/     C64 :                     
    3134/     C64 : 5D 00               	JMS GETCHAR_P1
    3135/     C66 : 5D B7               	JMS CTOI_P1
    3136/     C68 :                     
    3137/     C68 : 27                  	SRC R6R7	; set address
    3138/     C69 : A3                  	LD R3
    3139/     C6A : E7                  	WR3
    3140/     C6B : 5D 48               	JMS PRINT_ACC
    3141/     C6D : 5D 5C               	JMS PRINT_CRLF
    3142/     C6F :                     
    3143/     C6F : 74 32               	ISZ R4,CMDW_L1
    3144/     C71 :                     	
    3145/     C71 : 40 1B               	JUN CMD_LOOP		; return to command loop
    3146/     C73 :                     
    3147/     C73 :                     ;;;---------------------------------------------------------------------------
    3148/     C73 :                     ;;; COMMAND_PMW
    3149/     C73 :                     ;;; Write Program Memory
    3150/     C73 :                     ;;;---------------------------------------------------------------------------
    3151/     C73 :                     COMMAND_PMW:
    3152/     C73 : 20 4E               	FIM P0, lo(STR_ADR)	; print " ADR="
    3153/     C75 : 5E 00               	JMS PRINTSTR_P0
    3154/     C77 : 5D 00               	JMS GETCHAR_P1
    3155/     C79 : 5D 28               	JMS PUTCHAR_P1
    3156/     C7B : 5D B7               	JMS CTOI_P1
    3157/     C7D : A3                  	LD R3
    3158/     C7E : B5                  	XCH R5
    3159/     C7F : 5D 5C               	JMS PRINT_CRLF
    3160/     C81 :                     
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 61 - 2023/03/11 11:35:13


    3161/     C81 : 22 46               	FIM P1,'F'
    3162/     C83 : 5D 28               	JMS PUTCHAR_P1
    3163/     C85 : A5                  	LD R5
    3164/     C86 : 5D 48               	JMS PRINT_ACC
    3165/     C88 : 22 30               	FIM P1,'0'
    3166/     C8A : 5D 28               	JMS PUTCHAR_P1
    3167/     C8C : 22 3A               	FIM P1,':'
    3168/     C8E : 5D 28               	JMS PUTCHAR_P1
    3169/     C90 :                     	
    3170/     C90 : A5                  	LD R5
    3171/     C91 : B0                  	XCH R0
    3172/     C92 :                     
    3173/     C92 : D0                  	LDM 0
    3174/     C93 : B1                  	XCH R1
    3175/     C94 :                     CMDPMW_L1:
    3176/     C94 : 5D 53               	JMS PRINT_SPC
    3177/     C96 :                     
    3178/     C96 : 5D 00               	JMS GETCHAR_P1
    3179/     C98 : 5D 28               	JMS PUTCHAR_P1
    3180/     C9A : 5D B7               	JMS CTOI_P1
    3181/     C9C : A3                  	LD R3
    3182/     C9D : B4                  	XCH R4
    3183/     C9E :                     
    3184/     C9E : 5D 00               	JMS GETCHAR_P1
    3185/     CA0 : 5D 28               	JMS PUTCHAR_P1
    3186/     CA2 : 5D B7               	JMS CTOI_P1
    3187/     CA4 :                     
    3188/     CA4 : A4                  	LD R4
    3189/     CA5 : B2                  	XCH R2
    3190/     CA6 :                     
    3191/     CA6 : 58 D7               	JMS PM_WRITE_P0_P1
    3192/     CA8 : 71 94               	ISZ R1, CMDPMW_L1
    3193/     CAA :                     
    3194/     CAA : 5D 5C               	JMS PRINT_CRLF
    3195/     CAC :                     
    3196/     CAC : 40 1B               	JUN CMD_LOOP		; return to command loop
    3197/     CAE :                     
    3198/     CAE :                     ;;;---------------------------------------------------------------------------
    3199/     CAE :                     ;;; COMMAND_PMR
    3200/     CAE :                     ;;; Dump Program Memory
    3201/     CAE :                     ;;;---------------------------------------------------------------------------
    3202/     CAE :                     COMMAND_PMR:
    3203/     CAE : 5D 5C               	JMS PRINT_CRLF
    3204/     CB0 :                     
    3205/     CB0 : 58 E3               	JMS PM_INIT_BANK
    3206/     CB2 :                     
    3207/     CB2 : 20 00               	FIM P0, 00H
    3208/     CB4 :                     CMDPMR_L0:
    3209/     CB4 : 22 46               	FIM P1,'F'
    3210/     CB6 : 5D 28               	JMS PUTCHAR_P1
    3211/     CB8 : A0                  	LD R0
    3212/     CB9 : 5D 48               	JMS PRINT_ACC
    3213/     CBB : 22 30               	FIM P1,'0'
    3214/     CBD : 5D 28               	JMS PUTCHAR_P1
    3215/     CBF : 22 3A               	FIM P1,':'
    3216/     CC1 : 5D 28               	JMS PUTCHAR_P1
    3217/     CC3 :                     CMDPMR_L1:	
    3218/     CC3 :                     	;; 	FIM P1, ' '
    3219/     CC3 :                     	;; 	JMS PUTCHAR_P1
    3220/     CC3 :                     
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 62 - 2023/03/11 11:35:13


    3221/     CC3 : 5F FE               	JMS PM_READ_P0_P1	; Read program memory
    3222/     CC5 : A3                  	LD R3
    3223/     CC6 : B5                  	XCH R5
    3224/     CC7 : A2                  	LD R2
    3225/     CC8 : 5D 48               	JMS PRINT_ACC
    3226/     CCA : A5                  	LD R5
    3227/     CCB : 5D 48               	JMS PRINT_ACC
    3228/     CCD :                     
    3229/     CCD : 71 C3               	ISZ R1, CMDPMR_L1
    3230/     CCF : 5D 5C               	JMS PRINT_CRLF
    3231/     CD1 : 70 B4                       ISZ R0, CMDPMR_L0
    3232/     CD3 :                     	
    3233/     CD3 : 40 1B               	JUN CMD_LOOP		; return to command loop
    3234/     CD5 :                     
    3235/     CD5 :                     ;;;---------------------------------------------------------------------------
    3236/     CD5 :                     ;;; COMMAND_PMC
    3237/     CD5 :                     ;;; Clear Program Memory
    3238/     CD5 :                     ;;;---------------------------------------------------------------------------
    3239/     CD5 :                     COMMAND_PMC:
    3240/     CD5 : 5D 5C               	JMS PRINT_CRLF
    3241/     CD7 :                     
    3242/     CD7 : 24 00               	FIM P2, loop(16)	; R5 = 0..15
    3243/     CD9 :                     CMDPMC_BANKLOOP:
    3244/     CD9 : A5                  	LD R5
    3245/     CDA : 58 EF               	JMS PM_SELECTPMB
    3246/     CDC : 20 00               	FIM P0, 00H		; loop counter
    3247/     CDE : 22 00               	FIM P1, 00H		; data to fill
    3248/     CE0 :                     CMDPMC_L1:
    3249/     CE0 : 58 D7               	JMS PM_WRITE_P0_P1
    3250/     CE2 : 71 E0               	ISZ R1, CMDPMC_L1
    3251/     CE4 : 70 E0               	ISZ R0, CMDPMC_L1
    3252/     CE6 :                     
    3253/     CE6 : 58 E3               	JMS PM_INIT_BANK 	; write PM_READ code on program memory
    3254/     CE8 : 75 D9               	ISZ R5, CMDPMC_BANKLOOP
    3255/     CEA :                     
    3256/     CEA : F0                  	CLB
    3257/     CEB : 58 EF               	JMS PM_SELECTPMB	; set PMB to 0
    3258/     CED :                     	
    3259/     CED : 40 1B               	JUN CMD_LOOP		; return to command loop
    3260/     CEF :                     
    3261/     CEF :                     
    3262/     CEF :                     ;;;----------------------------------------------------------------------------
    3263/     CEF :                     ;;; I/O and some basic routines located in Page 0D00H
    3264/     CEF :                     ;;;----------------------------------------------------------------------------
    3265/     D00 :                     	org 0D00H
    3266/     D00 :                     ;;;---------------------------------------------------------------------------
    3267/     D00 :                     ;;; Software UART Routine
    3268/     D00 :                     ;;; GETCHAR_P1 and PUTCHAR_P1
    3269/     D00 :                     ;;; defined in separated file
    3270/     D00 :                     ;;;---------------------------------------------------------------------------
    3271/     D00 :                     ;;; supported baudrates are 4800bps or 9600bps
    3272/     D00 :                     ;; BAUDRATE equ 4800	; 4800 bps, 8 data bits, no parity, 1 stop bit
    3273/     D00 : =2580H               BAUDRATE equ 9600   ; 9600 bps, 8 data bits, no parity, 1 stop bit
    3274/     D00 :                     
    3275/     D00 : =2580H               	switch BAUDRATE
    3276/     D00 : =>FALSE              	case 4800
    3277/     D00 :                     	include "4800bps.inc"
    3278/     D00 : =>TRUE               	case 9600
    3279/     D00 :                     	include "9600bps.inc"
(1)    1/     D00 :                     ;;;---------------------------------------------------------------------------
 AS V1.42 Beta [Bld 236] - Source File vtl.asm(9600bps.inc) - Page 63 - 2023/03/11 11:35:13


(1)    2/     D00 :                     ;;; getchar and putchar functions
(1)    3/     D00 :                     ;;; baud rate = 9600bps
(1)    4/     D00 :                     ;;; 8bit, no parity, stop 1
(1)    5/     D00 :                     ;;;---------------------------------------------------------------------------
(1)    6/     D00 :                     
(1)    7/     D00 :                     ;;;---------------------------------------------------------------------------
(1)    8/     D00 :                     ;;; GETCHAR_P1
(1)    9/     D00 :                     ;;; receive a character from serial port (TEST) and put into P1(R2, R3)
(1)   10/     D00 :                     ;;;
(1)   11/     D00 :                     ;;; Input: none
(1)   12/     D00 :                     ;;; Output: P1(R2,R3), ACC=0(OK), ACC=1(error)
(1)   13/     D00 :                     ;;; Working: P6, P7
(1)   14/     D00 :                     ;;; This subroutine destroys P6, P7.
(1)   15/     D00 :                     ;;; 
(1)   16/     D00 :                     ;;; baud rate: 9600bps (104.17us/bit, 9.645cycle/bit)
(1)   17/     D00 :                     ;;; 
(1)   18/     D00 :                     ;;;          |--12--|-9--|-9-|-9--|-12--|-9--|-9-|-9--|-10--|
(1)   19/     D00 :                     ;;; ~~~~~~~~|____|~~~~|____|~~~~|____|~~~~|____|~~~~|____|~~~~~ 9.645cycle/bit
(1)   20/     D00 :                     ;;;          ^      ^    ^   ^    ^     ^    ^   ^    ^     ^
(1)   21/     D00 :                     ;;;        start    0    1   2    3     4    5   6    7    stop
(1)   22/     D00 :                     ;;;               |->phase delay
(1)   23/     D00 :                     ;;; - In order to check data bits in the middle of the signal,
(1)   24/     D00 :                     ;;;   a "phase delay" should be added between the start bit and data bits.
(1)   25/     D00 :                     ;;;   (1 to 4 cycles may be moderate for 9.645cycle/bit)
(1)   26/     D00 :                     ;;; - Detection of the start bit may cause delay of 2 cycles due to polling.
(1)   27/     D00 :                     ;;;---------------------------------------------------------------------------
(1)   28/     D00 :                     
(1)   29/     D00 :                     GETCHAR_P1:
(1)   30/     D00 : 2C 0C                       FIM R12R13, loop(4)     ; loop for first(lower) 4 bit
(1)   31/     D02 :                                                     ; 
(1)   32/     D02 : 19 02                       JCN TN, $               ;(2) wait for start bit (TEST="0")
(1)   33/     D04 : 2E 0C               	FIM P7, loop(4)         ;(2)
(1)   34/     D06 : 7F 06               	ISZ R15,$               ;(8) 12 cycles between startbit and bit0
(1)   35/     D08 :                                                     ;    phase(bit0)= 12 -9.645 = 2.355cycle
(1)   36/     D08 :                     GETCHAR_L1:
(1)   37/     D08 : 19 0D               	JCN TN, GETCHAR_L2      ;(2) check a bit
(1)   38/     D0A : F1                          CLC                     ;<1> TEST="0" then CY=0
(1)   39/     D0B : 4D 10                       JUN GETCHAR_L3          ;<2>
(1)   40/     D0D :                     GETCHAR_L2:
(1)   41/     D0D : FA                  	STC                     ;[1] TEST="1" then CY=1
(1)   42/     D0E : 00                          NOP                     ;[1]
(1)   43/     D0F : 00                          NOP                     ;[1]
(1)   44/     D10 :                     GETCHAR_L3:
(1)   45/     D10 : F6                  	RAR                     ;(1) load CY->ACC
(1)   46/     D11 : 00                  	NOP                     ;(1) 9cycle/bit (error=-0.645 cycle/bit)
(1)   47/     D12 : 7D 08                       ISZ R13, GETCHAR_L1     ;(2) repeat until 4 bit received
(1)   48/     D14 :                                                     ;    phase(here)= 2.355 -0.645*3 = 0.42cycle
(1)   49/     D14 : B3                  	XCH R3                  ;(1)
(1)   50/     D15 : 2C 0C               	FIM R12R13, loop(4)     ;(2) loop for second(upper) 4 bit
(1)   51/     D17 :                     		                ;    12 cycles between bit3 and bit4
(1)   52/     D17 :                                                     ;    phase(bit4)= 2.42 +12 -9.645 = 2.775cycle
(1)   53/     D17 :                     GETCHAR_L4:
(1)   54/     D17 : 19 1C               	JCN TN, GETCHAR_L5      ;(2) check a bit
(1)   55/     D19 : F1                          CLC                     ;<1> TEST="0" then CY=0
(1)   56/     D1A : 4D 1F                       JUN GETCHAR_L6          ;<2>
(1)   57/     D1C :                     GETCHAR_L5:
(1)   58/     D1C : FA                  	STC                     ;[1] TEST="1" then CY=1
(1)   59/     D1D : 00                          NOP                     ;[1]
(1)   60/     D1E : 00                          NOP                     ;[1]
(1)   61/     D1F :                     GETCHAR_L6:
 AS V1.42 Beta [Bld 236] - Source File vtl.asm(9600bps.inc) - Page 64 - 2023/03/11 11:35:13


(1)   62/     D1F : F6                  	RAR                     ;(1) load CY->ACC
(1)   63/     D20 : 00                  	NOP                     ;(1) 9cycle/bit (error=-0.645 cycle/bit)
(1)   64/     D21 : 7D 17                       ISZ R13, GETCHAR_L4     ;(2) repeat until 4 bit received
(1)   65/     D23 :                                                     ;    phase(here)= 4.755 -0.645*3 = 0.84 cycle
(1)   66/     D23 : B2                  	XCH R2                  ;(1)
(1)   67/     D24 :                                                     ;    10 cycles/between bit7 and stopbit
(1)   68/     D24 :                                                     ;    phase(stop)= 2.84 +10 -9.645 = 1.195cycle
(1)   69/     D24 :                     	;; check stop bit
(1)   70/     D24 : 19 27                       JCN TN, GETCHAR_OK      ; stop bit == "1"
(1)   71/     D26 : C1                          BBL 1                   ; stop bit != "1"
(1)   72/     D27 :                     GETCHAR_OK:
(1)   73/     D27 : C0                  	BBL 0
(1)   74/     D28 :                                     
(1)   75/     D28 :                     ;;;---------------------------------------------------------------------------
(1)   76/     D28 :                     ;;; PUTCHAR_P1
(1)   77/     D28 :                     ;;; send the character in P1(R2, R3) to OUTPORT
(1)   78/     D28 :                     ;;; 
(1)   79/     D28 :                     ;;; Input: P1(R2,R3)
(1)   80/     D28 :                     ;;; Output: ACC=0
(1)   81/     D28 :                     ;;; Working: P6(R12R13), P7
(1)   82/     D28 :                     ;;; This subroutine destroys P6, P7.
(1)   83/     D28 :                     ;;; P1 is not affected
(1)   84/     D28 :                     ;;; 
(1)   85/     D28 :                     ;;; baud rate: 9600bps (104.17us/bit, 9.645cycle/bit)
(1)   86/     D28 :                     ;;; 
(1)   87/     D28 :                     ;;; Input: P1(R2,R3)
(1)   88/     D28 :                     ;;; Output: ACC=0
(1)   89/     D28 :                     ;;; Working: P6(R12R13), P7
(1)   90/     D28 :                     ;;; This subroutine destroys P6, P7.
(1)   91/     D28 :                     ;;;---------------------------------------------------------------------------
(1)   92/     D28 :                     ;;; 
(1)   93/     D28 :                     ;;;         |--9-|-9--|-9-|-9--|-10--|-10-|-10-|-10-|-10--|(ave.9.56cycle/bit)
(1)   94/     D28 :                     ;;; ~~~~~~~~|____|~~~~|____|~~~~|____|~~~~|____|~~~~|____|~~~~~ 9.645cycle/bit
(1)   95/     D28 :                     ;;;         ^    ^    ^   ^    ^     ^    ^    ^    ^     ^
(1)   96/     D28 :                     ;;;       start  0    1   2    3     4    5    6    7     stop
(1)   97/     D28 :                     ;;;---------------------------------------------------------------------------
(1)   98/     D28 :                     
(1)   99/     D28 :                     PUTCHAR_P1:
(1)  100/     D28 : =>FALSE              	if (BANK_SERIAL != BANK_DEFAULT)
(1)  101/     D28 :                     	LDM BANK_SERIAL     ; set bank to serial output port RAM
(1)  102/     D28 :                             DCL                 ; this may be omitted if BANK_SERIAL==BANK_DEFAULT
(1)  103/     D28 : [100]                	endif
(1)  104/     D28 :                     	
(1)  105/     D28 : 2E C0                       FIM P7, CHIP_SERIAL ; chip# of output port
(1)  106/     D2A : 2F                  	SRC P7              ; set port address
(1)  107/     D2B :                     
(1)  108/     D2B : 2C 0B                       FIM R12R13, loop(5) ; start bit and lower 4bit(R3)
(1)  109/     D2D : A3                          LD R3
(1)  110/     D2E : F1                          CLC                 ; start bit is 0
(1)  111/     D2F : F5                          RAL
(1)  112/     D30 :                                     
(1)  113/     D30 :                     PUTCHAR_L1:
(1)  114/     D30 : 00                  	NOP                 ;(1) 9cycle/bit
(1)  115/     D31 : 00                          NOP                 ;(1)
(1)  116/     D32 : 00                          NOP                 ;(1)
(1)  117/     D33 : 00                          NOP                 ;(1)
(1)  118/     D34 : 00                          NOP                 ;(1)
(1)  119/     D35 : E1                          WMP                 ;(1)
(1)  120/     D36 : F6                          RAR                 ;(1)
(1)  121/     D37 : 7D 30                       ISZ R13, PUTCHAR_L1 ;(2)
 AS V1.42 Beta [Bld 236] - Source File vtl.asm(9600bps.inc) - Page 65 - 2023/03/11 11:35:13


(1)  122/     D39 :                     	
(1)  123/     D39 : 2C 0B                       FIM R12R13, loop(5) ;(2) upper 4bit(R2) and stop bit
(1)  124/     D3B : A2                          LD R2               ;(1)
(1)  125/     D3C : FA                          STC                 ;(1) stop bit is 1
(1)  126/     D3D : 00                  	NOP                 ;(1) timing adjustment
(1)  127/     D3E : 00                          NOP                 ;(1) 10cycle between bit3 and bit4
(1)  128/     D3F :                     PUTCHAR_L2:
(1)  129/     D3F : E1                  	WMP                 ;(1) 10cycle/bit
(1)  130/     D40 : 2E 0E                       FIM R14R15, loop(2) ;(2)
(1)  131/     D42 : 7F 42                       ISZ R15, $          ;(4)
(1)  132/     D44 : F6                          RAR                 ;(1)
(1)  133/     D45 : 7D 3F                       ISZ R13, PUTCHAR_L2 ;(2)
(1)  134/     D47 :                     	
(1)  135/     D47 : =>FALSE              	if (BANK_SERIAL != BANK_DEFAULT)
(1)  136/     D47 :                     	LDM BANK_DEFAULT    ; restore bank to default
(1)  137/     D47 :                             DCL                 ; this may be omitted if BANK_SERIAL==BANK_DEFAULT
(1)  138/     D47 : [135]                	endif
(1)  139/     D47 :                     	
(1)  140/     D47 : C0                          BBL 0
(1)  141/     D48 :                     
(1)  142/     D48 :                     
    3280/     D48 : [3275]               	endcase
    3281/     D48 :                     
    3282/     D48 :                     ;;;---------------------------------------------------------------------------
    3283/     D48 :                     ;;; PRINT_ACC
    3284/     D48 :                     ;;; print contents of ACC('0'...'F') as a character
    3285/     D48 :                     ;;; destroy: P1, P6, P7, ACC
    3286/     D48 :                     ;;;---------------------------------------------------------------------------
    3287/     D48 :                     PRINT_ACC:
    3288/     D48 : 22 30               	FIM R2R3, 30H		;'0'
    3289/     D4A : F1                  	CLC			; clear carry
    3290/     D4B : FB                  	DAA			; ACC=ACC+6 if ACC>9 and set carry
    3291/     D4C : 1A 50               	JCN CN, PRINTACC_L1
    3292/     D4E : 62                  	INC R2
    3293/     D4F : F2                  	IAC
    3294/     D50 :                     PRINTACC_L1:	
    3295/     D50 : B3                  	XCH R3			; R3<-ACC
    3296/     D51 : 4D 28               	JUN PUTCHAR_P1		; not JMS but JUN (Jump to PUTCHAR and return)
    3297/     D53 :                     
    3298/     D53 :                     ;;;---------------------------------------------------------------------------
    3299/     D53 :                     ;;; PRINT_SPC
    3300/     D53 :                     ;;; print " "
    3301/     D53 :                     ;;; destroy: ACC
    3302/     D53 :                     ;;; this routine consumes 2 PC stack
    3303/     D53 :                     ;;;---------------------------------------------------------------------------
    3304/     D53 :                     PRINT_SPC:
    3305/     D53 : 59 5C               	JMS PUSH_P1
    3306/     D55 : 22 20               	FIM P1, ' '
    3307/     D57 : 5D 28               	JMS PUTCHAR_P1
    3308/     D59 : 59 A6               	JMS POP_P1
    3309/     D5B : C0                  	BBL 0
    3310/     D5C :                     
    3311/     D5C :                     ;;;---------------------------------------------------------------------------
    3312/     D5C :                     ;;; PRINT_CRLF
    3313/     D5C :                     ;;; print "\r\n"
    3314/     D5C :                     ;;; destroy: ACC
    3315/     D5C :                     ;;; this routine consumes 2 PC stack
    3316/     D5C :                     ;;;---------------------------------------------------------------------------
    3317/     D5C :                     PRINT_CRLF:
    3318/     D5C : 59 5C               	JMS PUSH_P1
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 66 - 2023/03/11 11:35:13


    3319/     D5E : 22 0D               	FIM P1, '\r'
    3320/     D60 : 5D 28               	JMS PUTCHAR_P1
    3321/     D62 : 22 0A               	FIM P1, '\n'
    3322/     D64 : 5D 28               	JMS PUTCHAR_P1
    3323/     D66 : 59 A6               	JMS POP_P1
    3324/     D68 : C0                  	BBL 0
    3325/     D69 :                     
    3326/     D69 :                     ;;;---------------------------------------------------------------------------
    3327/     D69 :                     ;;; PRINT_CR
    3328/     D69 :                     ;;; print "\r"
    3329/     D69 :                     ;;; destroy: P1, ACC
    3330/     D69 :                     ;;; this routine consumes 1 PC stack
    3331/     D69 :                     ;;;---------------------------------------------------------------------------
    3332/     D69 :                     PRINT_CR:
    3333/     D69 : 22 0D               	FIM P1, '\r'
    3334/     D6B : 4D 28               	JUN PUTCHAR_P1
    3335/     D6D :                     
    3336/     D6D :                     ;;;---------------------------------------------------------------------------
    3337/     D6D :                     ;;; PRINT_LF
    3338/     D6D :                     ;;; print "\n"
    3339/     D6D :                     ;;; destroy: P1, ACC
    3340/     D6D :                     ;;; this routine consumes 1 PC stack
    3341/     D6D :                     ;;;---------------------------------------------------------------------------
    3342/     D6D :                     PRINT_LF:
    3343/     D6D : 22 0A               	FIM P1, '\n'
    3344/     D6F : 4D 28               	JUN PUTCHAR_P1
    3345/     D71 :                     
    3346/     D71 :                     ;;;----------------------------------------------------------------------------
    3347/     D71 :                     ;;; DISPLED_P1
    3348/     D71 :                     ;;;   DISPLAY the contents of P1 on Port 1 and 2
    3349/     D71 :                     ;;; Input: P1(R2R3)
    3350/     D71 :                     ;;; Output:  ACC=0
    3351/     D71 :                     ;;; Working: P7
    3352/     D71 :                     ;;; Destroy: P7
    3353/     D71 :                     ;;;----------------------------------------------------------------------------
    3354/     D71 :                     DISPLED_P1:
    3355/     D71 : D0                  	LDM BANK_RAM1
    3356/     D72 : FD                          DCL
    3357/     D73 : 2E 40                       FIM P7, CHIP_RAM1
    3358/     D75 : 2F                          SRC P7
    3359/     D76 : A2                          LD R2
    3360/     D77 : E1                          WMP
    3361/     D78 :                     	
    3362/     D78 : D0                          LDM BANK_RAM2
    3363/     D79 : FD                          DCL
    3364/     D7A : 2E 80                       FIM P7, CHIP_RAM2
    3365/     D7C : 2F                          SRC P7
    3366/     D7D : A3                          LD R3
    3367/     D7E : E1                          WMP
    3368/     D7F :                     
    3369/     D7F : D0                          LDM BANK_DEFAULT	; restore BANK to default
    3370/     D80 : FD                  	DCL
    3371/     D81 :                     	
    3372/     D81 : C0                          BBL 0
    3373/     D82 :                     
    3374/     D82 :                     ;;;---------------------------------------------------------------------------
    3375/     D82 :                     ;;; INIT_SERIAL
    3376/     D82 :                     ;;; Initialize serial port
    3377/     D82 :                     ;;;---------------------------------------------------------------------------
    3378/     D82 :                     INIT_SERIAL:
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 67 - 2023/03/11 11:35:13


    3379/     D82 : D0                  	LDM BANK_SERIAL     ; bank of output port
    3380/     D83 : FD                          DCL                 ; set port bank
    3381/     D84 :                     	
    3382/     D84 : 2E C0                       FIM P7, CHIP_SERIAL ; chip# of output port
    3383/     D86 : 2F                  	SRC P7              ; set port address
    3384/     D87 : D1                  	LDM 1
    3385/     D88 : E1                          WMP                 ; set serial port to 1 (TTL->H)
    3386/     D89 :                     
    3387/     D89 : D0                  	LDM BANK_DEFAULT    
    3388/     D8A : FD                          DCL                 ; restore bank to default
    3389/     D8B :                     
    3390/     D8B : C0                          BBL 0
    3391/     D8C :                     
    3392/     D8C :                     ;;;---------------------------------------------------------------------------
    3393/     D8C :                     ;;; ISNUM_P1
    3394/     D8C :                     ;;; check P1 '0' to '9' as a ascii character
    3395/     D8C :                     ;;; return: ACC=0 if P1 is not a number
    3396/     D8C :                     ;;;         ACC=1 if P1 is a number
    3397/     D8C :                     ;;; destroy: P7
    3398/     D8C :                     ;;;---------------------------------------------------------------------------
    3399/     D8C :                     ISNUM_P1:
    3400/     D8C : 2E 30               	FIM P7, '0'
    3401/     D8E : 5D D0               	JMS CMP_P1P7
    3402/     D90 : 1A 99               	JCN CN, ISNUM_FALSE	; P1 < '0'
    3403/     D92 : 2E 3A               	FIM P7, '9'+1
    3404/     D94 : 5D D0               	JMS CMP_P1P7
    3405/     D96 : 12 99               	JCN C,  ISNUM_FALSE	; P1 >= '9'+1
    3406/     D98 : C1                  	BBL 1			; P1 is a number
    3407/     D99 :                     ISNUM_FALSE:
    3408/     D99 : C0                  	BBL 0			; P1 is not a number
    3409/     D9A :                     
    3410/     D9A :                     ;;;----------------------------------------------------------------------------
    3411/     D9A :                     ;;; ISALPHA_P1
    3412/     D9A :                     ;;; check P1 is an alphabet as a ascii character
    3413/     D9A :                     ;;; return: ACC=0 if P1 is not an alphabet
    3414/     D9A :                     ;;;         ACC=1 if P1 is an alphabet
    3415/     D9A :                     ;;; destroy: P7
    3416/     D9A :                     ;;;----------------------------------------------------------------------------
    3417/     D9A :                     ISALPHA_P1:
    3418/     D9A :                     ISALPHA_L1:
    3419/     D9A : 2E 41               	FIM P7, 'A'
    3420/     D9C : 5D D0               	JMS CMP_P1P7
    3421/     D9E : 12 A1               	JCN C, ISALPHA_L10
    3422/     DA0 : C0                  	BBL 0			; P1<'A'
    3423/     DA1 :                     ISALPHA_L10:
    3424/     DA1 : 2E 5B               	FIM P7, 'Z'+1
    3425/     DA3 : 5D D0               	JMS CMP_P1P7
    3426/     DA5 : 12 A8               	JCN C,  ISALPHA_L2	; P1>='Z'+1 then jump to next chance
    3427/     DA7 : C1                  	BBL 1			; 'A'<=P1<='Z'
    3428/     DA8 :                     ISALPHA_L2:
    3429/     DA8 : 2E 61               	FIM P7, 'a'
    3430/     DAA : 5D D0               	JMS CMP_P1P7
    3431/     DAC : 12 AF               	JCN C, ISALPHA_L20
    3432/     DAE : C0                  	BBL 0			; P1<'a'
    3433/     DAF :                     ISALPHA_L20:	
    3434/     DAF : 2E 7B               	FIM P7, 'z'+1
    3435/     DB1 : 5D D0               	JMS CMP_P1P7
    3436/     DB3 : 12 B6               	JCN C, ISALPHA_FALSE	; P1>='z'+1
    3437/     DB5 : C1                  	BBL 1			; 'a'<=P1<= 'z'
    3438/     DB6 :                     ISALPHA_FALSE:
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 68 - 2023/03/11 11:35:13


    3439/     DB6 : C0                  	BBL 0
    3440/     DB7 :                     
    3441/     DB7 :                     ;;;---------------------------------------------------------------------------
    3442/     DB7 :                     ;;; CTOI_P1
    3443/     DB7 :                     ;;; convert character ('0'...'f') to value 0000 ... 1111
    3444/     DB7 :                     ;;; input: P1(R2R3)
    3445/     DB7 :                     ;;; output: R3, (R2=0)
    3446/     DB7 :                     ;;;---------------------------------------------------------------------------
    3447/     DB7 :                     CTOI_P1:
    3448/     DB7 : F0                  	CLB
    3449/     DB8 : D3                  	LDM 3
    3450/     DB9 : 92                  	SUB R2
    3451/     DBA : 14 C0               	JCN Z, CTOI_09		; check upper 4bit
    3452/     DBC : F0                  	CLB
    3453/     DBD : D9                  	LDM 9
    3454/     DBE : 83                  	ADD R3
    3455/     DBF : B3                  	XCH R3			; R3 = R3 + 9 for 'a-fA-F'
    3456/     DC0 :                     CTOI_09:
    3457/     DC0 : F0                  	CLB
    3458/     DC1 : B2                  	XCH R2			; R2 = 0
    3459/     DC2 : C0                  	BBL 0
    3460/     DC3 :                     	
    3461/     DC3 :                     ;;;---------------------------------------------------------------------------
    3462/     DC3 :                     ;;; CMP_P0P1
    3463/     DC3 :                     ;;; compare P0(R0R1) and P1(R2R3)
    3464/     DC3 :                     ;;; input: P0, P1
    3465/     DC3 :                     ;;; output: ACC=1,CY=0 if P0<P1
    3466/     DC3 :                     ;;;         ACC=0,CY=1 if P0==P1 
    3467/     DC3 :                     ;;;         ACC=1,CY=1 if P0>P1
    3468/     DC3 :                     ;;; P0 - P1 (the carry bit is a complement of the borrow)
    3469/     DC3 :                     ;;;---------------------------------------------------------------------------
    3470/     DC3 :                     CMP_P0P1:
    3471/     DC3 : F0                  	CLB
    3472/     DC4 : A0                  	LD R0			
    3473/     DC5 : 92                  	SUB R2			;R0-R2
    3474/     DC6 : 14 C9               	JCN Z, CMP01L1
    3475/     DC8 : C1                  	BBL 1			;P0>P1,  ACC=1, CY=1
    3476/     DC9 :                     				;P0<P1,  ACC=1, CY=0
    3477/     DC9 :                     CMP01L1:	
    3478/     DC9 : F0                  	CLB
    3479/     DCA : A1                  	LD R1
    3480/     DCB : 93                  	SUB R3			;R1-R3
    3481/     DCC : 14 CF               	JCN Z, CMP01EXIT01
    3482/     DCE : C1                  	BBL 1			;P0<P1,  ACC=1, CY=0
    3483/     DCF :                     				;P0<P1,  ACC=1, CY=0
    3484/     DCF :                     CMP01EXIT01:
    3485/     DCF : C0                  	BBL 0			;P0==P1, ACC=0, CY=1
    3486/     DD0 :                     
    3487/     DD0 :                     ;;;---------------------------------------------------------------------------
    3488/     DD0 :                     ;;; CMP_P1P7
    3489/     DD0 :                     ;;; compare P1(R2R3) and P7(R14R15)
    3490/     DD0 :                     ;;; input: P1, P7
    3491/     DD0 :                     ;;; output: ACC=1,CY=0 if P1<P7
    3492/     DD0 :                     ;;;         ACC=0,CY=1 if P1==P7
    3493/     DD0 :                     ;;;         ACC=1,CY=1 if P1>P7
    3494/     DD0 :                     ;;; P1 - P7 (the carry bit is a complement of the borrow)
    3495/     DD0 :                     ;;;---------------------------------------------------------------------------
    3496/     DD0 :                     CMP_P1P7:
    3497/     DD0 : F0                  	CLB
    3498/     DD1 : A2                  	LD R2			
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 69 - 2023/03/11 11:35:13


    3499/     DD2 : 9E                  	SUB R14			;R2-R14
    3500/     DD3 : 14 D6               	JCN Z, CMP17_L1		; jump if R2==R14
    3501/     DD5 : C1                  	BBL 1			; if P1<P7 then ACC=1, CY=0
    3502/     DD6 :                     CMP17_L1:	
    3503/     DD6 : F0                  	CLB
    3504/     DD7 : A3                  	LD R3
    3505/     DD8 : 9F                  	SUB R15			;R3-R15
    3506/     DD9 : 14 DC               	JCN Z, CMP17_EXIT01	; jump if R3==R15
    3507/     DDB : C1                  	BBL 1			; if P1<P7 then ACC=1, CY=0
    3508/     DDC :                     				; if P1>P7 then ACC=1, CY=1
    3509/     DDC :                     CMP17_EXIT01:
    3510/     DDC : C0                  	BBL 0			; P1==P7, ACC=0, CY=1
    3511/     DDD :                     	
    3512/     DDD :                     ;;;---------------------------------------------------------------------------
    3513/     DDD :                     ;;; CMPEQ_P1P2
    3514/     DDD :                     ;;; compare P1 and P2 equal or not
    3515/     DDD :                     ;;; return: Take care the return value. It is comptatible with CMP
    3516/     DDD :                     ;;; 	ACC=0 if P1==P2
    3517/     DDD :                     ;;;     ACC=1 if P1!=P2
    3518/     DDD :                     ;;;---------------------------------------------------------------------------
    3519/     DDD :                     CMPEQ_P1P2:
    3520/     DDD : A2                  	LD R2
    3521/     DDE : F1                  	CLC
    3522/     DDF : 94                  	SUB R4
    3523/     DE0 : 1C E8               	JCN NZ, CMPEQ12_EXIT1
    3524/     DE2 : A3                  	LD R3
    3525/     DE3 : F1                  	CLC
    3526/     DE4 : 95                  	SUB R5
    3527/     DE5 : 1C E8               	JCN NZ, CMPEQ12_EXIT1
    3528/     DE7 : C0                  	BBL 0
    3529/     DE8 :                     CMPEQ12_EXIT1:
    3530/     DE8 : C1                  	BBL 1
    3531/     DE9 :                     
    3532/     DE9 :                     ;;;---------------------------------------------------------------------------
    3533/     DE9 :                     ;;; CMPEQ_P2P7
    3534/     DE9 :                     ;;; compare P2 and P7 equal or not
    3535/     DE9 :                     ;;; return: Take care the return value. It is comptatible with CMP
    3536/     DE9 :                     ;;; 	ACC=0 if P2==P7
    3537/     DE9 :                     ;;;     ACC=1 if P2 != P7
    3538/     DE9 :                     ;;;---------------------------------------------------------------------------
    3539/     DE9 :                     CMPEQ_P2P7:
    3540/     DE9 : A4                  	LD R4
    3541/     DEA : F1                  	CLC
    3542/     DEB : 9E                  	SUB R14
    3543/     DEC : 1C F4               	JCN NZ, CMPEQ27_EXIT1
    3544/     DEE : A5                  	LD R5
    3545/     DEF : F1                  	CLC
    3546/     DF0 : 9F                  	SUB R15
    3547/     DF1 : 1C F4               	JCN NZ, CMPEQ27_EXIT1
    3548/     DF3 : C0                  	BBL 0
    3549/     DF4 :                     CMPEQ27_EXIT1:
    3550/     DF4 : C1                  	BBL 1
    3551/     DF5 :                     	
    3552/     DF5 :                     ;;;---------------------------------------------------------------------------
    3553/     DF5 :                     ;;; ISZEROORNOT_P1
    3554/     DF5 :                     ;;; check P1 is zero or not
    3555/     DF5 :                     ;;; Return 0 if P1 is 0
    3556/     DF5 :                     ;;; return: ACC=0 if P1 == 0
    3557/     DF5 :                     ;;; 	    ACC=1 if P1 != 0
    3558/     DF5 :                     ;;;---------------------------------------------------------------------------
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 70 - 2023/03/11 11:35:13


    3559/     DF5 :                     ISZEROORNOT_P1:
    3560/     DF5 : A3                  	LD R3
    3561/     DF6 : 1C FC               	JCN ZN, ISZEROORNOT_EXIT1
    3562/     DF8 : A2                  	LD R2
    3563/     DF9 : 1C FC               	JCN ZN, ISZEROORNOT_EXIT1
    3564/     DFB : C0                  	BBL 0
    3565/     DFC :                     ISZEROORNOT_EXIT1:
    3566/     DFC : C1                  	BBL 1
    3567/     DFD :                     ;;;----------------------------------------------------------------------------
    3568/     DFD :                     ;;; Print subroutine and string data located in Page E (0E00H-0EFFH)
    3569/     DFD :                     ;;; The string data sould be located in the same page as the print routine.
    3570/     DFD :                     ;;;----------------------------------------------------------------------------
    3571/     E00 :                             org 0E00H
    3572/     E00 :                     ;;;----------------------------------------------------------------------------
    3573/     E00 :                     ;;; PRINTSTR_P0
    3574/     E00 :                     ;;; Input: P0 (top of the string is 0E00H+P0)
    3575/     E00 :                     ;;; Destroy: P6, P7 (by PUTCHAR)
    3576/     E00 :                     ;;;----------------------------------------------------------------------------
    3577/     E00 :                     PRINTSTR_P0:
    3578/     E00 : 59 44               	JMS PUSH_P0
    3579/     E02 : 59 5C               	JMS PUSH_P1
    3580/     E04 :                     PRINTSTRP0_LOOP:
    3581/     E04 : 32                          FIN P1			; P1=(P0)
    3582/     E05 : A2                          LD R2
    3583/     E06 : 1C 0B                       JCN ZN, PRINTSTRP0_PUT	; R2!=0 then putchar
    3584/     E08 : A3                  	LD R3
    3585/     E09 : 14 12                       JCN Z, PRINTSTRP0_EXIT     	; R2==0 and R3==0 then exit
    3586/     E0B :                     PRINTSTRP0_PUT:
    3587/     E0B : 5D 28                       JMS PUTCHAR_P1          ; putchar(P1)
    3588/     E0D : 71 04                       ISZ R1, PRINTSTRP0_LOOP   ; P0=P0+1
    3589/     E0F : 60                          INC R0
    3590/     E10 : 4E 04                       JUN PRINTSTRP0_LOOP	; print remaining string
    3591/     E12 :                     PRINTSTRP0_EXIT:
    3592/     E12 : 59 A6               	JMS POP_P1
    3593/     E14 : 59 8C               	JMS POP_P0
    3594/     E16 : C0                          BBL 0                   ; exit if P1(R2,R3) == 0
    3595/     E17 :                                     
    3596/     E17 :                     ;;;----------------------------------------------------------------------------
    3597/     E17 :                     ;;; String data
    3598/     E17 :                     ;;;----------------------------------------------------------------------------
    3599/     E17 :                     
    3600/     E17 :                     STR_OMSG:
    3601/     E17 : 0D 49 6E 74 65 6C   	data "\rIntel MCS-4 (4004)\r\nTiny Monitor\r\n", 0
              E1D : 20 4D 43 53 2D 34 
              E23 : 20 28 34 30 30 34 
              E29 : 29 0D 0A 54 69 6E 
              E2F : 79 20 4D 6F 6E 69 
              E35 : 74 6F 72 0D 0A 00 
    3602/     E3B :                     STR_VFD_INIT:		;reset VFD and set scroll mode
    3603/     E3B : 1B 40 1F 02 00      	data 1bH, 40H, 1fH, 02H, 0
    3604/     E40 :                     STR_BANK:
    3605/     E40 : 20 42 41 4E 4B 3D   	data " BANK=", 0
              E46 : 00                
    3606/     E47 :                     STR_CHIP:
    3607/     E47 : 20 43 48 49 50 3D   	data " CHIP=", 0
              E4D : 00                
    3608/     E4E :                     STR_ADR:
    3609/     E4E : 20 41 44 52 3D 00   	data " ADR=", 0
    3610/     E54 :                     STR_VTL_MESSAGE:
    3611/     E54 : 0D 0A 56 54 4C 2D   	data "\r\nVTL-4004 Interpreter Ver 1.0\r\n", 0
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 71 - 2023/03/11 11:35:13


              E5A : 34 30 30 34 20 49 
              E60 : 6E 74 65 72 70 72 
              E66 : 65 74 65 72 20 56 
              E6C : 65 72 20 31 2E 30 
              E72 : 0D 0A 00          
    3612/     E75 :                     STR_VTL_OK:
    3613/     E75 : 0D 0A 4F 4B 0D 0A   	data "\r\nOK\r\n", 0
              E7B : 00                
    3614/     E7C :                     STR_VTL_ERROR:
    3615/     E7C : 45 52 52 4F 52 3D   	data "ERROR=", 0
              E82 : 00                
    3616/     E83 :                     STR_VTL_BUF:
    3617/     E83 : 42 55 46 3D 00      	data "BUF=", 0
    3618/     E88 :                     STR_VTL_SP:
    3619/     E88 : 53 50 3D 00         	data "SP=", 0
    3620/     E8C :                     STR_VTL_ERRORLINENUM:
    3621/     E8C : 49 4E 20 23 00      	data "IN #", 0
    3622/     E91 :                     STR_CMDERR:
    3623/     E91 : 0D 0A 76 3D 56 54   	data "\r\nv=VTL, r/w=RD/WR RAM, R/W/C/B=RD/WR/CLR/BNK PM, l/L=rd/wr LM, g=go PM(F00)\r\n", 0 ;
              E97 : 4C 2C 20 72 2F 77 
              E9D : 3D 52 44 2F 57 52 
              EA3 : 20 52 41 4D 2C 20 
              EA9 : 52 2F 57 2F 43 2F 
              EAF : 42 3D 52 44 2F 57 
              EB5 : 52 2F 43 4C 52 2F 
              EBB : 42 4E 4B 20 50 4D 
              EC1 : 2C 20 6C 2F 4C 3D 
              EC7 : 72 64 2F 77 72 20 
              ECD : 4C 4D 2C 20 67 3D 
              ED3 : 67 6F 20 50 4D 28 
              ED9 : 46 30 30 29 0D 0A 
              EDF : 00                
    3624/     EE0 :                     
    3625/     EE0 :                     ;;;---------------------------------------------------------------------------
    3626/     EE0 :                     ;;; Subroutine for reading program memory located on page 15 (0F00H-0FFFH)
    3627/     EE0 :                     ;;;---------------------------------------------------------------------------
    3628/     EE0 :                     ;;; READPM_P0
    3629/     EE0 :                     ;;; P1 = (P0)
    3630/     EE0 :                     ;;; input: P0
    3631/     EE0 :                     ;;; output: P1
    3632/     EE0 :                     ;;;---------------------------------------------------------------------------
    3633/     EE0 :                     ;;; 	org 0FFEH
    3634/     EE0 :                     ;;; PM_READ_P0_P1:
    3635/     EE0 : 32                  	FIN P1
    3636/     EE1 : C0                  	BBL 0
    3637/     EE2 :                     
    3638/     EE2 :                     	end
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 72 - 2023/03/11 11:35:13


  Symbol Table (* = unused):
  --------------------------

 ADD_REG16P0_REG16P1 :          6C1 C |
*ARCHITECTURE :                                      "x86_64-unknown-linux" - |
 BANK_DEFAULT :                   0 - | *BANK_PMSELECT :                  0 - |
 BANK_RAM0 :                      0 - |  BANK_RAM1 :                      0 - |
 BANK_RAM2 :                      0 - |  BANK_RAM3 :                      0 - |
 BANK_SERIAL :                    0 - |  BAUDRATE :                    2580 - |
*CASESENSITIVE :                  0 - |  CHIP_PMSELECT :                  0 - |
 CHIP_RAM0 :                      0 - |  CHIP_RAM1 :                     40 - |
 CHIP_RAM2 :                     80 - |  CHIP_RAM3 :                    0C0 - |
 CHIP_SERIAL :                  0C0 - |  CLEARREG16_LOOP :              548 C |
 CLEAR_REG16P0 :                543 C |  CLEAR_SIGNFLAG :               64D C |
 CMDPMC_BANKLOOP :             0CD9 C |  CMDPMC_L1 :                   0CE0 C |
 CMDPMR_L0 :                   0CB4 C |  CMDPMR_L1 :                   0CC3 C |
 CMDPMW_L1 :                   0C94 C |  CMDR_L1 :                     0C08 C |
 CMDR_L2 :                     0C0A C |  CMDW_L1 :                     0C32 C |
 CMDW_L2 :                     0C34 C |  CMD_LOOP :                      1B C |
 CMP01EXIT01 :                 0DCF C |  CMP01L1 :                     0DC9 C |
 CMP17_EXIT01 :                0DDC C |  CMP17_L1 :                    0DD6 C |
 CMPEQ12_EXIT1 :               0DE8 C |  CMPEQ27_EXIT1 :               0DF4 C |
 CMPEQ_P1P2 :                  0DDD C |  CMPEQ_P2P7 :                  0DE9 C |
 CMP_P0P1 :                    0DC3 C |  CMP_P1P7 :                    0DD0 C |
 CMP_REG16P0_REG16P1 :          7C9 C |  COMMAND_G :                   0C00 C |
 COMMAND_LMR :                 0AE0 C |  COMMAND_LMR_HLOOP :           0B11 C |
 COMMAND_LMR_VLOOP :           0B05 C |  COMMAND_LMW :                 0B21 C |
 COMMAND_LMW_EXIT :            0B71 C |  COMMAND_LMW_LOOP :            0B43 C |
 COMMAND_LMW_SKIPCR :          0B4D C |  COMMAND_PMB :                  8F4 C |
 COMMAND_PMC :                 0CD5 C |  COMMAND_PMR :                 0CAE C |
 COMMAND_PMW :                 0C73 C |  COMMAND_R :                   0C06 C |
 COMMAND_V :                    100 C |  COMMAND_W :                   0C30 C |
 COMPLEMENT_REG16P0 :           5EC C | *COMPMODE :                       0 - |
*CONSTPI :        3.141592653589793 - |  CTOI_09 :                     0DC0 C |
 CTOI_P1 :                     0DB7 C |  CTOREG16NUM_P1 :               52E C |
*DATE :                "2023/03/11" - |  DEC_REG16P0 :                  5DB C |
 DISPLED_P1 :                  0D71 C |  DIV16_P2P3 :                   6ED C |
 DIV2REG16_LOOP :               6B0 C |  DIV2_REG16P2 :                 6A9 C |
 DIV_POSITIVE_DIVIDEND :        738 C |  DIV_POSITIVE_DIVISOR :         74E C |
 DIV_REG16P0_REG16P1 :          722 C |  ERROR_EVAL_UNEXPECTED_EOL :    0E1 - |
 ERROR_EVAL_UNKNOWNOPERATOR :   0E2 - |  ERROR_EXEC_SYNTAX_ERROR :      0E0 - |
 ERROR_FACTOR_NOTAFACTOR :      0F0 - |  ERROR_NOERROR :                  0 - |
 ERROR_PRINT_CANNOTPRINT :      0A0 - |  ERROR_RETURN_P2_IS_00 :        0B0 - |
 EVAL_06 :                      42B C |  EVAL_CONTINUE :                3AD C |
 EVAL_EXIT :                    441 C |
 EVAL_EXPRESSION_PMINDEX_REG16P1 :                                      393 C |
 EVAL_LVALUE_FALSE :            415 C |  EVAL_LVALUE_TRUE :             419 C |
 EVAL_NEXT1 :                   3BB C |  EVAL_NEXT2 :                   3C5 C |
 EVAL_NEXT3 :                   3CD C |  EVAL_O1 :                      3E9 C |
 EVAL_O2 :                      3F3 C |  EVAL_O3 :                      3FD C |
 EVAL_O4 :                      40B C |  EVAL_O5 :                      41F C |
 EVAL_O7 :                      437 C | *EVAL_O8 :                      437 C |
*EVAL_O9 :                      437 C |  EVAL_R1 :                      3AD C |
 EVAL_R2 :                      3D5 C |  EVAL_START :                   3A7 C |
 EXEC_R1 :                      2C7 C | *FALSE :                          0 - |
 FIND_LINE_AND_EXEC :           23A C |  FIND_LINE_AND_EXEC_EXIT :      260 C |
 FIND_LINE_AND_EXEC_GO :        25C C |  FIND_LINE_LOOP :               242 C |
*FULLPMMU :                       1 - |  GETCHAR_L1 :                  0D08 C |
 GETCHAR_L2 :                  0D0D C |  GETCHAR_L3 :                  0D10 C |
 GETCHAR_L4 :                  0D17 C |  GETCHAR_L5 :                  0D1C C |
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 73 - 2023/03/11 11:35:13


 GETCHAR_L6 :                  0D1F C |  GETCHAR_OK :                  0D27 C |
 GETCHAR_P1 :                  0D00 C | *GETFACTOR_ERROR :              503 C |
 GETFACTOR_EXIT :               50F C |  GETFACTOR_EXIT_NOINCREMENT :   511 C |
 GETFACTOR_L0 :                 469 C |  GETFACTOR_L1 :                 481 C |
 GETFACTOR_L10 :                503 C |  GETFACTOR_L2 :                 48B C |
 GETFACTOR_L3 :                 495 C |  GETFACTOR_L4 :                 4A1 C |
 GETFACTOR_L5 :                 4AD C |  GETFACTOR_L6 :                 4B9 C |
 GETFACTOR_L7 :                 4C5 C |  GETFACTOR_L8 :                 4D1 C |
 GETFACTOR_L9 :                 4E1 C |  GETFACTOR_L91 :                4E9 C |
 GETFACTOR_L9_R1 :              4FD C |  GETFACTOR_PMINDEX_REG16P1 :    451 C |
 GETFACTOR_R1 :                 467 C |  GETFACTOR_R2 :                 479 C |
 GETHEXNUMBER :                0ACC C |  GETHEX_EXIT :                 0AC6 C |
 GETHEX_LOOP :                 0AD0 C |  GETLINE_BS :                  0A4C C |
 GETLINE_EXIT :                0A60 C |  GETLINE_INSERTCHAR :          0A58 C |
 GETLINE_L1 :                  0A3E C | *GETLINE_L1_NEXT :             0A4E C |
 GETLINE_LOOP :                0A26 C |  GETLINE_PM12REG16P0 :         0A1E C |
 GETNUMBER_EXIT :              0ABD C |  GETNUMBER_LOOP :              0A91 C |
 GETNUMBER_PM12REG16P0_REG16P1 :                                       0A71 C |
 GETNUMBER_SKIP_MUL10 :        0AAB C |  GETSIGN_REG16P0_TOCARRY :      5AF C |
 GET_PRINTFORMAT_R5 :           33D C |  GET_SIGNFLAG_TOCARRY :         65A C |
*HAS64 :                          1 - | *HASFPU :                         0 - |
*HASPMMU :                        0 - |  INC_REG16P0 :                  5CB C |
 INITVAL_STACKPOINTER :           0 - |  INIT_SERIAL :                 0D82 C |
 INIT_STACKPOINTER :            93A C |  INSERT_PROGRAM_EXIT :          1E1 C |
 INSERT_PROGRAM_L1 :            1AF C |  INSERT_PROGRAM_LOOP :          1CF C |
*INSUPMODE :                      0 - |  ISALPHA_FALSE :               0DB6 C |
*ISALPHA_L1 :                  0D9A C |  ISALPHA_L10 :                 0DA1 C |
 ISALPHA_L2 :                  0DA8 C |  ISALPHA_L20 :                 0DAF C |
 ISALPHA_P1 :                  0D9A C |  ISHEX_FALSE :                  0D8 C |
 ISHEX_L00 :                    0B5 C |  ISHEX_L1 :                     0BC C |
 ISHEX_L10 :                    0C3 C |  ISHEX_L2 :                     0CA C |
 ISHEX_L20 :                    0D1 C |  ISHEX_P1 :                     0AE C |
 ISNUM_FALSE :                 0D99 C |  ISNUM_P1 :                    0D8C C |
 ISZEROORNOT_EXIT1 :           0DFC C |  ISZEROORNOT_LOOP :             5BE C |
 ISZEROORNOT_P1 :              0DF5 C |  ISZEROORNOT_REG16P1 :          5BA C |
 ISZEROREGP0_EXIT1 :            5C8 C |  L0 :                            35 C |
 L1 :                            3F C |  L10 :                           89 C |
 L2 :                            49 C |  L3 :                            51 C |
 L4 :                            59 C |  L5 :                            61 C |
 L6 :                            69 C |  L7 :                            71 C |
 L8 :                            79 C |  L9 :                            81 C |
 LDREG16P0P1_LOOP :             556 C |  LDREG16P1P0_LOOP :             569 C |
 LDREG16P1P2_LOOP :             57C C |  LDREG16P2P0_LOOP :             58F C |
 LDREG16P2P1_LOOP :             5A2 C |  LD_P1_PM12REG16P0 :            907 C |
 LD_P1_REG16P0_8BIT :           66B C |  LD_P1_REG8P0 :                 66B C |
 LD_P2P3_PM12REG16P0_AND_INCREMENT :                                    203 C |
 LD_P2P3_REG16P0 :              676 C |  LD_P2P3_REG16P1 :              624 C |
 LD_PM12REG16P0_P1 :            922 C |  LD_REG16P0_8BIT_P1 :           639 C |
 LD_REG16P0_P2P3 :              5FA C |  LD_REG16P0_REG16P1 :           550 C |
 LD_REG16P1_P2P3 :              60F C |  LD_REG16P1_REG16P0 :           563 C |
 LD_REG16P1_REG16P2 :           576 C |  LD_REG16P2_REG16P0 :           589 C |
 LD_REG16P2_REG16P1 :           59C C |  LD_REG8P0_P1 :                 660 C |
*LISTON :                         1 - |  L_CR :                          1F C |
*MACEXP :                         7 - | *MAIN :                           0 C |
*MOMCPU :                      4004 - | *MOMCPUNAME :                "4004" - |
 MUL16_P2P3 :                   6F6 C |  MUL2REG16P0_LOOP :             690 C |
 MUL2REG16P1_LOOP :             69F C |  MUL2_REG16P0 :                 68B C |
 MUL2_REG16P1 :                 69A C |  MUL_REG16P0_REG16P1 :          6FF C |
 MUL_REG16_LOOP :               713 C |  MUL_REG16_NEXT :               719 C |
*NESTMAX :                      100 - | *PADDING :                        1 - |
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 74 - 2023/03/11 11:35:13


*PM12_DATA :                   0B00 - |  PM12_LINEBUF :                   0 - |
 PM12_MEMEND :                 0DFF - |  PM12_PROGRAM :                 100 - |
 PM_INIT_BANK :                 8E3 C |  PM_INIT_LOOP :                   9 C |
 PM_RAM_START :                0F00 - |  PM_READ_P0_P1 :               0FFE - |
 PM_SELECTPMB :                 8EF C |  PM_WRITE_P0_P1 :               8D7 C |
 PM_WRITE_P6_P7 :               8DD C |  POP_P0 :                       98C C |
 POP_P1 :                       9A6 C |  POP_P2 :                       9C0 C |
 POP_REG16P1 :                  9FD C |  POP_REG16P1_LOOP :            0A08 C |
 POP_REG16P1_NOCARRY :         0A11 C |  PRINTACC_L1 :                 0D50 C |
 PRINTFMT_HEX2B :                 1 - |  PRINTFMT_HEX4B :                 2 - |
 PRINTFMT_NORMAL :                0 - |  PRINTHEX_P1 :                  8B1 C |
 PRINTHEX_REG16P1 :             88E C |  PRINTSTRP0_EXIT :             0E12 C |
 PRINTSTRP0_LOOP :             0E04 C |  PRINTSTRP0_PUT :              0E0B C |
 PRINTSTR_EXIT :                80F C |  PRINTSTR_EXIT_NOINCREMENT :    817 C |
 PRINTSTR_LOOP :                7FF C |  PRINTSTR_P0 :                 0E00 C |
 PRINTSTR_PM12REG16P0 :         7ED C |
 PRINTSTR_PM12REG16P0_DELIM_P1 :                                        7F5 C |
 PRINTSTR_PM12REG16P0_XX :      7F9 C |  PRINT_ACC :                   0D48 C |
 PRINT_AND_CLEARFLAG :          8CF C |  PRINT_CR :                    0D69 C |
 PRINT_CRLF :                  0D5C C | *PRINT_LF :                    0D6D C |
 PRINT_LIST :                   214 C |  PRINT_LIST_LOOP :              21C C |
 PRINT_LIST_PRINTLINE :         224 C |  PRINT_R1 :                     35B C |
 PRINT_REG16P1 :                81E C |  PRINT_REG16P1_POSITIVE :       83F C |
 PRINT_REG4P0_ZEROSUP :         8C4 C |  PRINT_SPC :                   0D53 C |
 PUSH_P0 :                      944 C |  PUSH_P1 :                      95C C |
 PUSH_P2 :                      974 C |  PUSH_REG16P1 :                 9DA C |
 PUSH_REG16P1_LOOP :            9EE C |  PUSH_REG16P1_NOBORROW :        9EA C |
 PUSH_REG16P1_NOINCUPPER :      9F7 C |  PUTCHAR_L1 :                  0D30 C |
 PUTCHAR_L2 :                  0D3F C |  PUTCHAR_P1 :                  0D28 C |
 RAM23TYPE :               "4002-2" - | *REG16_A :                        4 - |
 REG16_ADD_LOOP :               6C8 C | *REG16_ARRAYINDEX :              9C - |
*REG16_B :                        8 - | *REG16_C :                       0C - |
 REG16_CMP_EXIT0 :              7EC C |  REG16_CMP_LOOP :               7D2 C |
 REG16_CMP_NEXT :               7DF C | *REG16_COMPLEMENT_EXIT :        5F7 C |
 REG16_COMPLEMENT_LOOP :        5F0 C | *REG16_D :                       10 - |
 REG16_DEC_EXIT :               5E9 C |  REG16_DEC_LOOP :               5E0 C |
 REG16_DIV_EXIT :               7C4 C |  REG16_DIV_L1 :                 79C C |
 REG16_DIV_L2 :                 78F C |  REG16_DIV_L3 :                 782 C |
 REG16_DIV_L4 :                 775 C |  REG16_DIV_LOOP1 :              79E C |
 REG16_DIV_LOOP2 :              791 C |  REG16_DIV_LOOP3 :              784 C |
 REG16_DIV_LOOP4 :              777 C |  REG16_DIV_NEXT1 :              7A5 C |
 REG16_DIV_NEXT2 :              798 C |  REG16_DIV_NEXT3 :              78B C |
 REG16_DIV_NEXT4 :              77E C |  REG16_DIV_POSITIVE_RMND :      7B0 C |
*REG16_E :                       14 - |  REG16_EVAL :                    8C - |
*REG16_F :                       18 - |  REG16_FACTOR :                  88 - |
*REG16_G :                       1C - | *REG16_H :                       20 - |
*REG16_I :                       24 - |  REG16_INC_EXIT :               5D8 C |
 REG16_INC_LOOP :               5CF C |  REG16_INDEX :                    0 - |
*REG16_J :                       28 - | *REG16_K :                       2C - |
*REG16_L :                       30 - |  REG16_LINENUM :                 6C - |
 REG16_LVALUE :                  80 - | *REG16_M :                       34 - |
*REG16_N :                       38 - |  REG16_NEXTLINEPTR :             70 - |
*REG16_O :                       3C - | *REG16_P :                       40 - |
 REG16_PEND :                    74 - | *REG16_Q :                       44 - |
*REG16_R :                       48 - |  REG16_RANDOM :                  98 - |
*REG16_RESERVED_0B0 :           0B0 - | *REG16_RESERVED_0B4 :           0B4 - |
*REG16_RESERVED_0B8 :           0B8 - | *REG16_RESERVED_0BC :           0BC - |
 REG16_RETURN :                  94 - |  REG16_RMND :                    90 - |
 REG16_RVALUE :                  84 - | *REG16_S :                       4C - |
*REG16_STACKAREA_0C0 :          0C0 - | *REG16_STACKAREA_0C4 :          0C4 - |
 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 75 - 2023/03/11 11:35:13


*REG16_STACKAREA_0C8 :          0C8 - | *REG16_STACKAREA_0CC :          0CC - |
*REG16_STACKAREA_0D0 :          0D0 - | *REG16_STACKAREA_0D4 :          0D4 - |
*REG16_STACKAREA_0D8 :          0D8 - | *REG16_STACKAREA_0DC :          0DC - |
*REG16_STACKAREA_0E0 :          0E0 - | *REG16_STACKAREA_0E4 :          0E4 - |
*REG16_STACKAREA_0E8 :          0E8 - | *REG16_STACKAREA_0EC :          0EC - |
*REG16_STACKAREA_0F0 :          0F0 - | *REG16_STACKAREA_0F4 :          0F4 - |
*REG16_STACKAREA_0F8 :          0F8 - | *REG16_STACKAREA_0FC :          0FC - |
 REG16_STACKPOINTER :           0FC - |  REG16_SUB_LOOP :               6DD C |
*REG16_T :                       50 - |  REG16_TMP :                    0A0 - |
 REG16_TMP2 :                   0A4 - |  REG16_TMP3 :                   0A8 - |
 REG16_TMP_PRN :                0AC - | *REG16_U :                       54 - |
*REG16_V :                       58 - | *REG16_W :                       5C - |
*REG16_X :                       60 - | *REG16_Y :                       64 - |
*REG16_Z :                       68 - |  REG4_PRINTFORMAT :              7E - |
*REG4_RESERVE_7FH :              7F - |  REG4_SIGN :                     7D - |
 REG4_ZEROSUP :                  7C - |  REG8_ERROR :                    78 - |
 REG8_ERROR2 :                   7A - | *RELAXED :                        0 - |
 RETURN_EVAL_R1 :              0BDF C |  RETURN_EVAL_R2 :              0BE1 C |
 RETURN_EXEC_R1 :              0BDD C |  RETURN_GETFACTOR_L9_R1 :      0BE9 C |
 RETURN_GETFACTOR_R1 :         0BE3 C |  RETURN_GETFACTOR_R2 :         0BE5 C |
 RETURN_P2 :                   0BD0 C |  RETURN_P2_OK :                0BDC C |
 RETURN_PRINT_R1 :             0BE7 C |  SETBANKCHIP_P5 :                8F C |
 SET_PRINTFORMAT :              338 C |  SKIPSPACE_EXIT :               52B C |
 SKIPSPACE_LOOP :               51F C |  SKIPSPACE_PM12REG16P0 :        51D C |
 STR_ADR :                     0E4E C |  STR_BANK :                    0E40 C |
 STR_CHIP :                    0E47 C |  STR_CMDERR :                  0E91 C |
 STR_OMSG :                    0E17 C |  STR_VFD_INIT :                0E3B C |
 STR_VTL_BUF :                 0E83 C |  STR_VTL_ERROR :               0E7C C |
 STR_VTL_ERRORLINENUM :        0E8C C |  STR_VTL_MESSAGE :             0E54 C |
 STR_VTL_OK :                  0E75 C |  STR_VTL_SP :                  0E88 C |
 SUB_REG16P0_REG16P1 :          6D6 C | *TIME :                  "11:35:13" - |
 TOGGLE_SIGNFLAG :              653 C | *TRUE :                           1 - |
*VERSION :                     142F - |  VTL_ERROR_NOLINENUM :          14E C |
 VTL_EXECUTE_PMINDEX :          286 C |  VTL_EXECUTE_PMINDEX_CONTINUE : 286 C |
 VTL_EXEC_GOSUB :               304 C |  VTL_EXEC_GOTO_FROM_GOSUB :     2EB C |
 VTL_EXEC_L0 :                  292 C |  VTL_EXEC_L0_CHECKHEX4 :        2AB C |
 VTL_EXEC_L0_NORMAL :           2B8 C |  VTL_EXEC_L1 :                  2BD C |
*VTL_EXEC_L10 :                 32C C |  VTL_EXEC_L2 :                  2D5 C |
 VTL_EXEC_L2_TRUE :             2E3 C |  VTL_EXEC_L3 :                  2E5 C |
 VTL_EXEC_L4 :                  2F9 C |  VTL_EXEC_L5 :                  310 C |
 VTL_EXEC_L6 :                  31C C |  VTL_EXEC_L7 :                  32C C |
*VTL_EXEC_L8 :                  32C C | *VTL_EXEC_L9 :                  32C C |
 VTL_EXEC_PRINT :               343 C |  VTL_EXEC_PRINT_L1 :            34D C |
 VTL_EXEC_SKIPGOTO :            2F7 C | *VTL_EXEC_SYNTAX_ERROR :        32C C |
 VTL_INSERT_PROGRAMLINE :       1A5 C |  VTL_L0 :                       18B C |
 VTL_L1 :                       191 C |  VTL_LOOP :                     173 C |
 VTL_NOERROR :                  158 C |  VTL_OK :                       16F C |
 VTL_PRINT_DEFAULT :            373 C |  VTL_PRINT_ERREXIT :            38B C |
 VTL_PRINT_EXIT :               391 C |  VTL_PRINT_FMT2 :               36A C |
 VTL_PRINT_L2 :                 355 C |  VTL_PRINT_QUOTEDSTRING :       377 C |
 VTL_PRINT_SKIPCRLF :           387 C |  VTL_RUN_PROGRAM_EXIT :         284 C |
 VTL_RUN_PROGRAM_PMINDEX :      262 C |
 VTL_RUN_PROGRAM_PMINDEX_FROM_GOTO :                                    26A C |
 VTL_RUN_SINGLE_LINE :          272 C |  VTL_RUN_SINGLE_LINE_RETURN :   274 C |
 VTL_SET_PRINTFMT :             29C C |  VTL_START :                    116 C |

    454 symbols
     83 unused symbols

 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 76 - 2023/03/11 11:35:13


  Register Definitions (* = unused):
  ----------------------------------

 P0 --> R0P                           |  P1 --> R1P                          
 P2 --> R2P                           |  P3 --> R3P                          
 P4 --> R4P                           |  P5 --> R5P                          
 P6 --> R6P                           |  P7 --> R7P                          
*R10 --> R10                          | *R10R11 --> R5P                      
*R11 --> R11                          | *R12 --> R12                         
*R12R13 --> R6P                       | *R13 --> R13                         
*R14 --> R14                          | *R14R15 --> R7P                      
*R15 --> R15                         

     17 definitions

 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 77 - 2023/03/11 11:35:13


  Defined Macros:
  ---------------

DEBUG_SAFEPUTCHAR                     | LD_P0_P1                             
LD_P0_P2                              | LD_P0_P3                             
LD_P0_P5                              | LD_P0_P6                             
LD_P1_P0                              | LD_P1_P2                             
LD_P1_P3                              | LD_P1_P4                             
LD_P2_P0                              | LD_P2_P1                             
LD_P2_P3                              | LD_P2_P4                             
LD_P3_P1                              | LD_P3_P2                             
LD_P3_P5                              | LD_P4_P1                             
LD_P5_P0                              | LD_P6_P0                             
LD_P7_P2                              | POPP                                 
PUSHP                                 |

     23 macros

 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 78 - 2023/03/11 11:35:13


  Defined Functions:
  ------------------

LOOPS                                 | LOOP                                 
UP                                    | LO                                   

 AS V1.42 Beta [Bld 236] - Source File vtl.asm - Page 79 - 2023/03/11 11:35:13


  Code Pages:
  ----------

STANDARD (0 changed characters)

1 code page

0.02 seconds assembly time

   3980 lines source file
   4221 lines incl. macro expansions
      2 passes
      0 errors
      0 warnings
